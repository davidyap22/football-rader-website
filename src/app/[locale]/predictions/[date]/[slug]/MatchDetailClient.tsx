'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import Link from 'next/link';
import { useParams, useRouter } from 'next/navigation';
import { supabase, Prematch, OddsHistory, Moneyline1x2Prediction, OverUnderPrediction, HandicapPrediction, ProfitSummary, getUserSubscription, UserSubscription, MatchPrediction, getMatchPrediction, TeamLineup, getFixtureLineups, FixturePlayer, LiveSignals, getLiveSignals, getLiveSignalsByBetStyle, getLiveSignalsHistoryByBetStyle, FixtureEvent, getFixtureEvents, MatchStatistics, getMatchStatistics } from '@/lib/supabase';
import { User } from '@supabase/supabase-js';
import { RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Legend, ResponsiveContainer } from 'recharts';
import FlagIcon, { LANGUAGES } from "@/components/FlagIcon";
import { locales, localeNames, localeToTranslationCode, type Locale } from '@/i18n/config';
import { parseFixtureIdFromSlug, generateMatchSlug } from '@/lib/slug-utils';
import { SportsEventJsonLd } from '@/components/JsonLd';
import { calculateUnrealizedHdpPnL, formatUnrealizedProfit, getUnrealizedStatusColor } from '@/lib/betting-utils';

// Helper function to parse LiveSignals data from database
const parseLiveSignals = (data: LiveSignals | null): LiveSignals | null => {
  if (!data) return null;
  const parseArray = (val: unknown): number[] | null => {
    if (val === null || val === undefined) return null;
    if (Array.isArray(val)) return val.map(v => typeof v === 'number' ? v : parseFloat(String(v)));
    if (typeof val === 'string') {
      try {
        const parsed = JSON.parse(val);
        if (Array.isArray(parsed)) return parsed.map(v => typeof v === 'number' ? v : parseFloat(String(v)));
      } catch { return null; }
    }
    return null;
  };
  const parseNumber = (val: unknown): number | null => {
    if (val === null || val === undefined) return null;
    if (typeof val === 'number') return val;
    if (typeof val === 'string') {
      const num = parseFloat(val.replace('%', ''));
      return isNaN(num) ? null : num;
    }
    return null;
  };
  return {
    ...data,
    fair_odds_1x2: parseArray(data.fair_odds_1x2),
    market_odds_1x2: parseArray(data.market_odds_1x2),
    expected_value_1x2: parseNumber(data.expected_value_1x2),
    recommended_stake_1x2: parseNumber(data.recommended_stake_1x2),
    fair_odds_ou: parseArray(data.fair_odds_ou),
    market_odds_ou: parseArray(data.market_odds_ou),
    expected_value_ou: parseNumber(data.expected_value_ou),
    recommended_stake_ou: parseNumber(data.recommended_stake_ou),
    fair_odds_hdp: parseArray(data.fair_odds_hdp),
    market_odds_hdp: parseArray(data.market_odds_hdp),
    expected_value_hdp: parseNumber(data.expected_value_hdp),
    recommended_stake_hdp: parseNumber(data.recommended_stake_hdp),
    clock: parseNumber(data.clock),
  };
};

// Translations
const translations: Record<string, Record<string, string>> = {
  EN: {
    home: "Home", predictions: "Predictions", leagues: "Leagues", performance: "AI Performance", community: "Community", news: "News", solution: "Solution", pricing: "Pricing",
    login: "Log In", getStarted: "Get Started", backToPredictions: "Back to Predictions",
    preMatchOdds: "Pre-match Odds", liveOdds: "Live Odds", finalOdds: "Final Odds", odds: "Odds",
    viewOddsHistory: "View Odds History", oddsHistory: "Odds History", noOddsData: "No odds data available",
    home_team: "Home", away_team: "Away", draw: "Draw", over: "Over", under: "Under",
    live: "LIVE", fullTime: "Full Time", notStarted: "Not Started", win: "WIN",
    aiPredictions: "AI Predictions", poweredByAI: "Powered by AI", selectBettingStyle: "Select Your Betting Style",
    matchResult: "Match Result (1X2)", overUnder: "Over/Under 2.5 Goals", asianHandicap: "Asian Handicap -0.5",
    disclaimer: "These predictions are generated by AI and should be used for informational purposes only. Please gamble responsibly. 18+",
    footer: "18+ | Gambling involves risk. Please gamble responsibly.",
    allRights: "© 2026 OddsFlow. All rights reserved.",
    refreshIn: "Refresh in", noHistory: "No odds history available",
    teamComparison: "Team Comparison", aiAnalysis: "AI-powered analysis",
    teamLineups: "Team Lineups", startingXI: "Starting XI & Formation",
    lineupNotAvailable: "Lineup data not available yet",
    lineupNotAvailableDesc: "Team lineups are usually announced 1 hour before kick-off. Please check back closer to match time.",
    matchEvents: "Match Events", eventsTimeline: "Goals, Cards & Substitutions",
    noEvents: "No events yet", noEventsDesc: "Events will appear here once the match starts.",
    goal: "Goal", yellowCard: "Yellow Card", redCard: "Red Card", substitution: "Substitution", penalty: "Penalty", ownGoal: "Own Goal", var: "VAR", missedPenalty: "Missed Penalty",
    tabOdds: "Odds & AI", tabComparison: "Comparison", tabLineups: "Lineups", tabEvents: "Events", tabStats: "Live Stats",
    liveStatistics: "Live Statistics", statsDescription: "Ball Possession, Shots, Corners & More",
    noStats: "No statistics yet", noStatsDesc: "Statistics will appear here once the match starts.",
    possession: "Ball Possession", totalShots: "Total Shots", shotsOnGoal: "Shots on Target", shotsOffGoal: "Shots off Target",
    corners: "Corner Kicks", fouls: "Fouls", offsides: "Offsides", yellowCards: "Yellow Cards", redCards: "Red Cards",
    saves: "Goalkeeper Saves", passes: "Total Passes", passAccuracy: "Pass Accuracy", expectedGoals: "Expected Goals (xG)",
  },
  ES: {
    home: "Inicio", predictions: "Predicciones", leagues: "Ligas", performance: "Rendimiento IA", community: "Comunidad", news: "Noticias", solution: "Solución", pricing: "Precios",
    login: "Iniciar Sesión", getStarted: "Comenzar", backToPredictions: "Volver a Predicciones",
    preMatchOdds: "Cuotas Pre-partido", liveOdds: "Cuotas en Vivo", finalOdds: "Cuotas Finales", odds: "Cuotas",
    viewOddsHistory: "Ver Historial de Cuotas", oddsHistory: "Historial de Cuotas", noOddsData: "No hay datos de cuotas disponibles",
    home_team: "Local", away_team: "Visitante", draw: "Empate", over: "Más", under: "Menos",
    live: "EN VIVO", fullTime: "Final", notStarted: "No Iniciado", win: "GANÓ",
    aiPredictions: "Predicciones IA", poweredByAI: "Impulsado por IA", selectBettingStyle: "Selecciona tu Estilo de Apuesta",
    matchResult: "Resultado del Partido (1X2)", overUnder: "Más/Menos 2.5 Goles", asianHandicap: "Hándicap Asiático -0.5",
    disclaimer: "Estas predicciones son generadas por IA y deben usarse solo con fines informativos. Por favor juega responsablemente. 18+",
    footer: "18+ | El juego implica riesgo. Por favor juega responsablemente.",
    allRights: "© 2026 OddsFlow. Todos los derechos reservados.",
    refreshIn: "Actualiza en", noHistory: "No hay historial de cuotas disponible",
    teamComparison: "Comparación de Equipos", aiAnalysis: "Análisis impulsado por IA",
    teamLineups: "Alineaciones", startingXI: "XI Titular y Formación",
    lineupNotAvailable: "Alineación no disponible aún",
    lineupNotAvailableDesc: "Las alineaciones se anuncian normalmente 1 hora antes del inicio. Por favor, vuelve más tarde.",
    matchEvents: "Eventos del Partido", eventsTimeline: "Goles, Tarjetas y Sustituciones",
    noEvents: "Sin eventos aún", noEventsDesc: "Los eventos aparecerán aquí cuando comience el partido.",
    goal: "Gol", yellowCard: "Tarjeta Amarilla", redCard: "Tarjeta Roja", substitution: "Sustitución", penalty: "Penal", ownGoal: "Autogol", var: "VAR", missedPenalty: "Penal Fallado",
    tabOdds: "Cuotas & IA", tabComparison: "Comparación", tabLineups: "Alineaciones", tabEvents: "Eventos", tabStats: "Estadísticas",
    liveStatistics: "Estadísticas en Vivo", statsDescription: "Posesión, Tiros, Córners y Más",
    noStats: "Sin estadísticas aún", noStatsDesc: "Las estadísticas aparecerán aquí cuando comience el partido.",
    possession: "Posesión", totalShots: "Tiros Totales", shotsOnGoal: "Tiros a Puerta", shotsOffGoal: "Tiros Fuera",
    corners: "Córners", fouls: "Faltas", offsides: "Fueras de Juego", yellowCards: "Amarillas", redCards: "Rojas",
    saves: "Paradas", passes: "Pases Totales", passAccuracy: "Precisión de Pases", expectedGoals: "Goles Esperados (xG)",
  },
  PT: {
    home: "Início", predictions: "Previsões", leagues: "Ligas", performance: "Desempenho IA", community: "Comunidade", news: "Notícias", solution: "Solução", pricing: "Preços",
    login: "Entrar", getStarted: "Começar", backToPredictions: "Voltar às Previsões",
    preMatchOdds: "Odds Pré-jogo", liveOdds: "Odds ao Vivo", finalOdds: "Odds Finais", odds: "Odds",
    viewOddsHistory: "Ver Histórico de Odds", oddsHistory: "Histórico de Odds", noOddsData: "Nenhum dado de odds disponível",
    home_team: "Casa", away_team: "Fora", draw: "Empate", over: "Mais", under: "Menos",
    live: "AO VIVO", fullTime: "Final", notStarted: "Não Iniciado", win: "VITÓRIA",
    aiPredictions: "Previsões IA", poweredByAI: "Powered by IA", selectBettingStyle: "Selecione seu Estilo de Aposta",
    matchResult: "Resultado da Partida (1X2)", overUnder: "Mais/Menos 2.5 Gols", asianHandicap: "Handicap Asiático -0.5",
    disclaimer: "Estas previsões são geradas por IA e devem ser usadas apenas para fins informativos. Jogue com responsabilidade. 18+",
    footer: "18+ | O jogo envolve risco. Por favor, jogue com responsabilidade.",
    allRights: "© 2026 OddsFlow. Todos os direitos reservados.",
    refreshIn: "Atualiza em", noHistory: "Nenhum histórico de odds disponível",
    teamComparison: "Comparação de Equipes", aiAnalysis: "Análise com IA",
    teamLineups: "Escalações", startingXI: "XI Titular e Formação",
    lineupNotAvailable: "Escalação ainda não disponível",
    lineupNotAvailableDesc: "As escalações são normalmente anunciadas 1 hora antes do jogo. Por favor, volte mais tarde.",
    matchEvents: "Eventos da Partida", eventsTimeline: "Gols, Cartões e Substituições",
    noEvents: "Sem eventos ainda", noEventsDesc: "Os eventos aparecerão aqui quando a partida começar.",
    goal: "Gol", yellowCard: "Cartão Amarelo", redCard: "Cartão Vermelho", substitution: "Substituição", penalty: "Pênalti", ownGoal: "Gol Contra", var: "VAR", missedPenalty: "Pênalti Perdido",
    tabOdds: "Odds & IA", tabComparison: "Comparação", tabLineups: "Escalações", tabEvents: "Eventos", tabStats: "Estatísticas",
    liveStatistics: "Estatísticas ao Vivo", statsDescription: "Posse, Chutes, Escanteios e Mais",
    noStats: "Sem estatísticas ainda", noStatsDesc: "As estatísticas aparecerão aqui quando a partida começar.",
    possession: "Posse de Bola", totalShots: "Chutes Totais", shotsOnGoal: "Chutes no Gol", shotsOffGoal: "Chutes Fora",
    corners: "Escanteios", fouls: "Faltas", offsides: "Impedimentos", yellowCards: "Amarelos", redCards: "Vermelhos",
    saves: "Defesas", passes: "Passes Totais", passAccuracy: "Precisão de Passes", expectedGoals: "Gols Esperados (xG)",
  },
  DE: {
    home: "Startseite", predictions: "Vorhersagen", leagues: "Ligen", performance: "KI-Leistung", community: "Community", news: "Nachrichten", solution: "Lösung", pricing: "Preise",
    login: "Anmelden", getStarted: "Loslegen", backToPredictions: "Zurück zu Vorhersagen",
    preMatchOdds: "Vorspiel-Quoten", liveOdds: "Live-Quoten", finalOdds: "Endquoten", odds: "Quoten",
    viewOddsHistory: "Quotenverlauf anzeigen", oddsHistory: "Quotenverlauf", noOddsData: "Keine Quotendaten verfügbar",
    home_team: "Heim", away_team: "Auswärts", draw: "Unentschieden", over: "Über", under: "Unter",
    live: "LIVE", fullTime: "Endstand", notStarted: "Nicht gestartet", win: "SIEG",
    aiPredictions: "KI-Vorhersagen", poweredByAI: "Powered by KI", selectBettingStyle: "Wählen Sie Ihren Wettstil",
    matchResult: "Spielergebnis (1X2)", overUnder: "Über/Unter 2.5 Tore", asianHandicap: "Asiatisches Handicap -0.5",
    disclaimer: "Diese Vorhersagen werden von KI generiert und sollten nur zu Informationszwecken verwendet werden. Bitte spielen Sie verantwortungsvoll. 18+",
    footer: "18+ | Glücksspiel birgt Risiken. Bitte spielen Sie verantwortungsvoll.",
    allRights: "© 2026 OddsFlow. Alle Rechte vorbehalten.",
    refreshIn: "Aktualisierung in", noHistory: "Kein Quotenverlauf verfügbar",
    teamComparison: "Teamvergleich", aiAnalysis: "KI-gestützte Analyse",
    teamLineups: "Aufstellungen", startingXI: "Startelf & Formation",
    lineupNotAvailable: "Aufstellung noch nicht verfügbar",
    lineupNotAvailableDesc: "Aufstellungen werden normalerweise 1 Stunde vor Anpfiff bekannt gegeben. Bitte später wiederkommen.",
    matchEvents: "Spielereignisse", eventsTimeline: "Tore, Karten & Auswechslungen",
    noEvents: "Noch keine Ereignisse", noEventsDesc: "Ereignisse erscheinen hier, sobald das Spiel beginnt.",
    goal: "Tor", yellowCard: "Gelbe Karte", redCard: "Rote Karte", substitution: "Auswechslung", penalty: "Elfmeter", ownGoal: "Eigentor", var: "VAR", missedPenalty: "Verschossener Elfmeter",
    tabOdds: "Quoten & KI", tabComparison: "Vergleich", tabLineups: "Aufstellungen", tabEvents: "Ereignisse", tabStats: "Statistiken",
    liveStatistics: "Live-Statistiken", statsDescription: "Ballbesitz, Schüsse, Ecken & Mehr",
    noStats: "Noch keine Statistiken", noStatsDesc: "Statistiken erscheinen hier, sobald das Spiel beginnt.",
    possession: "Ballbesitz", totalShots: "Schüsse Gesamt", shotsOnGoal: "Schüsse aufs Tor", shotsOffGoal: "Schüsse Vorbei",
    corners: "Eckstöße", fouls: "Fouls", offsides: "Abseitspositionen", yellowCards: "Gelbe Karten", redCards: "Rote Karten",
    saves: "Paraden", passes: "Pässe Gesamt", passAccuracy: "Passgenauigkeit", expectedGoals: "Erwartete Tore (xG)",
  },
  FR: {
    home: "Accueil", predictions: "Prédictions", leagues: "Ligues", performance: "Performance IA", community: "Communauté", news: "Actualités", solution: "Solution", pricing: "Tarifs",
    login: "Connexion", getStarted: "Commencer", backToPredictions: "Retour aux Prédictions",
    preMatchOdds: "Cotes Pré-match", liveOdds: "Cotes en Direct", finalOdds: "Cotes Finales", odds: "Cotes",
    viewOddsHistory: "Voir l'Historique des Cotes", oddsHistory: "Historique des Cotes", noOddsData: "Aucune donnée de cotes disponible",
    home_team: "Domicile", away_team: "Extérieur", draw: "Nul", over: "Plus", under: "Moins",
    live: "EN DIRECT", fullTime: "Temps Plein", notStarted: "Non Commencé", win: "VICTOIRE",
    aiPredictions: "Prédictions IA", poweredByAI: "Propulsé par IA", selectBettingStyle: "Sélectionnez votre Style de Pari",
    matchResult: "Résultat du Match (1X2)", overUnder: "Plus/Moins 2.5 Buts", asianHandicap: "Handicap Asiatique -0.5",
    disclaimer: "Ces prédictions sont générées par l'IA et doivent être utilisées à titre informatif uniquement. Veuillez jouer de manière responsable. 18+",
    footer: "18+ | Les jeux d'argent comportent des risques. Jouez responsablement.",
    allRights: "© 2026 OddsFlow. Tous droits réservés.",
    refreshIn: "Actualisation dans", noHistory: "Aucun historique de cotes disponible",
    teamComparison: "Comparaison d'Équipes", aiAnalysis: "Analyse par IA",
    teamLineups: "Compositions", startingXI: "XI de départ & Formation",
    lineupNotAvailable: "Composition non disponible",
    lineupNotAvailableDesc: "Les compositions sont généralement annoncées 1 heure avant le coup d'envoi. Veuillez revenir plus tard.",
    matchEvents: "Événements du Match", eventsTimeline: "Buts, Cartons & Remplacements",
    noEvents: "Pas d'événements encore", noEventsDesc: "Les événements apparaîtront ici une fois le match commencé.",
    goal: "But", yellowCard: "Carton Jaune", redCard: "Carton Rouge", substitution: "Remplacement", penalty: "Pénalty", ownGoal: "But Contre Son Camp", var: "VAR", missedPenalty: "Pénalty Manqué",
    tabOdds: "Cotes & IA", tabComparison: "Comparaison", tabLineups: "Compositions", tabEvents: "Événements", tabStats: "Statistiques",
    liveStatistics: "Statistiques en Direct", statsDescription: "Possession, Tirs, Corners et Plus",
    noStats: "Pas encore de statistiques", noStatsDesc: "Les statistiques apparaîtront ici une fois le match commencé.",
    possession: "Possession", totalShots: "Tirs Totaux", shotsOnGoal: "Tirs Cadrés", shotsOffGoal: "Tirs Non Cadrés",
    corners: "Corners", fouls: "Fautes", offsides: "Hors-jeu", yellowCards: "Cartons Jaunes", redCards: "Cartons Rouges",
    saves: "Arrêts", passes: "Passes Totales", passAccuracy: "Précision des Passes", expectedGoals: "Buts Attendus (xG)",
  },
  JA: {
    home: "ホーム", predictions: "予測", leagues: "リーグ", performance: "AIパフォーマンス", community: "コミュニティ", news: "ニュース", solution: "ソリューション", pricing: "料金",
    login: "ログイン", getStarted: "始める", backToPredictions: "予測に戻る",
    preMatchOdds: "試合前オッズ", liveOdds: "ライブオッズ", finalOdds: "最終オッズ", odds: "オッズ",
    viewOddsHistory: "オッズ履歴を見る", oddsHistory: "オッズ履歴", noOddsData: "オッズデータがありません",
    home_team: "ホーム", away_team: "アウェイ", draw: "引き分け", over: "オーバー", under: "アンダー",
    live: "ライブ", fullTime: "試合終了", notStarted: "未開始", win: "勝利",
    aiPredictions: "AI予測", poweredByAI: "AIによる", selectBettingStyle: "ベッティングスタイルを選択",
    matchResult: "試合結果 (1X2)", overUnder: "オーバー/アンダー 2.5", asianHandicap: "アジアンハンディキャップ -0.5",
    disclaimer: "これらの予測はAIによって生成されており、情報提供のみを目的としています。責任を持ってプレイしてください。18歳以上",
    footer: "18歳以上 | ギャンブルにはリスクが伴います。責任を持ってプレイしてください。",
    allRights: "© 2026 OddsFlow. 全著作権所有。",
    refreshIn: "更新まで", noHistory: "オッズ履歴がありません",
    teamComparison: "チーム比較", aiAnalysis: "AI分析",
    teamLineups: "スタメン", startingXI: "先発メンバー & フォーメーション",
    lineupNotAvailable: "スタメン未発表",
    lineupNotAvailableDesc: "スタメンは通常キックオフの1時間前に発表されます。後ほどご確認ください。",
    matchEvents: "試合イベント", eventsTimeline: "ゴール、カード、交代",
    noEvents: "イベントはまだありません", noEventsDesc: "試合が始まるとイベントがここに表示されます。",
    goal: "ゴール", yellowCard: "イエローカード", redCard: "レッドカード", substitution: "交代", penalty: "ペナルティ", ownGoal: "オウンゴール", var: "VAR", missedPenalty: "PK失敗",
    tabOdds: "オッズ & AI", tabComparison: "比較", tabLineups: "スタメン", tabEvents: "イベント", tabStats: "統計",
    liveStatistics: "ライブ統計", statsDescription: "ボール支配率、シュート、コーナー等",
    noStats: "統計はまだありません", noStatsDesc: "試合が始まると統計がここに表示されます。",
    possession: "ボール支配率", totalShots: "総シュート数", shotsOnGoal: "枠内シュート", shotsOffGoal: "枠外シュート",
    corners: "コーナーキック", fouls: "ファウル", offsides: "オフサイド", yellowCards: "イエローカード", redCards: "レッドカード",
    saves: "GKセーブ", passes: "パス総数", passAccuracy: "パス成功率", expectedGoals: "期待ゴール (xG)",
  },
  KO: {
    home: "홈", predictions: "예측", leagues: "리그", performance: "AI 성능", community: "커뮤니티", news: "뉴스", solution: "솔루션", pricing: "가격",
    login: "로그인", getStarted: "시작하기", backToPredictions: "예측으로 돌아가기",
    preMatchOdds: "경기 전 배당률", liveOdds: "라이브 배당률", finalOdds: "최종 배당률", odds: "배당률",
    viewOddsHistory: "배당률 기록 보기", oddsHistory: "배당률 기록", noOddsData: "배당률 데이터 없음",
    home_team: "홈", away_team: "원정", draw: "무승부", over: "오버", under: "언더",
    live: "라이브", fullTime: "경기 종료", notStarted: "시작 전", win: "승리",
    aiPredictions: "AI 예측", poweredByAI: "AI 기반", selectBettingStyle: "베팅 스타일 선택",
    matchResult: "경기 결과 (1X2)", overUnder: "오버/언더 2.5", asianHandicap: "아시안 핸디캡 -0.5",
    disclaimer: "이 예측은 AI에 의해 생성되었으며 정보 제공 목적으로만 사용해야 합니다. 책임감 있게 플레이하세요. 18세 이상",
    footer: "18세 이상 | 도박에는 위험이 따릅니다. 책임감 있게 플레이하세요.",
    allRights: "© 2026 OddsFlow. 모든 권리 보유.",
    refreshIn: "새로고침", noHistory: "배당률 기록 없음",
    teamComparison: "팀 비교", aiAnalysis: "AI 분석",
    teamLineups: "선발 라인업", startingXI: "선발 XI & 포메이션",
    lineupNotAvailable: "라인업 미발표",
    lineupNotAvailableDesc: "라인업은 일반적으로 경기 시작 1시간 전에 발표됩니다. 나중에 다시 확인해 주세요.",
    matchEvents: "경기 이벤트", eventsTimeline: "골, 카드 & 교체",
    noEvents: "아직 이벤트 없음", noEventsDesc: "경기가 시작되면 여기에 이벤트가 표시됩니다.",
    goal: "골", yellowCard: "옐로 카드", redCard: "레드 카드", substitution: "교체", penalty: "페널티", ownGoal: "자책골", var: "VAR", missedPenalty: "페널티 실패",
    tabOdds: "배당률 & AI", tabComparison: "비교", tabLineups: "라인업", tabEvents: "이벤트", tabStats: "통계",
    liveStatistics: "라이브 통계", statsDescription: "점유율, 슈팅, 코너킥 등",
    noStats: "아직 통계가 없습니다", noStatsDesc: "경기가 시작되면 통계가 표시됩니다.",
    possession: "점유율", totalShots: "총 슈팅", shotsOnGoal: "유효 슈팅", shotsOffGoal: "슈팅 빗나감",
    corners: "코너킥", fouls: "파울", offsides: "오프사이드", yellowCards: "옐로카드", redCards: "레드카드",
    saves: "선방", passes: "총 패스", passAccuracy: "패스 성공률", expectedGoals: "기대 골 (xG)",
  },
  '中文': {
    home: "首页", predictions: "预测", leagues: "联赛", performance: "AI表现", community: "社区", news: "新闻", solution: "解决方案", pricing: "价格",
    login: "登录", getStarted: "开始使用", backToPredictions: "返回预测",
    preMatchOdds: "赛前赔率", liveOdds: "实时赔率", finalOdds: "最终赔率", odds: "赔率",
    viewOddsHistory: "查看赔率历史", oddsHistory: "赔率历史", noOddsData: "暂无赔率数据",
    home_team: "主队", away_team: "客队", draw: "平局", over: "大", under: "小",
    live: "直播", fullTime: "全场结束", notStarted: "未开始", win: "胜",
    aiPredictions: "AI预测", poweredByAI: "AI驱动", selectBettingStyle: "选择您的投注风格",
    matchResult: "比赛结果 (1X2)", overUnder: "大小球 2.5", asianHandicap: "亚洲让球 -0.5",
    disclaimer: "这些预测由AI生成，仅供参考。请理性投注。18+",
    footer: "18+ | 博彩有风险，请理性投注。",
    allRights: "© 2026 OddsFlow. 保留所有权利。",
    refreshIn: "刷新倒计时", noHistory: "暂无赔率历史",
    teamComparison: "球队对比", aiAnalysis: "AI分析",
    teamLineups: "首发阵容", startingXI: "首发11人 & 阵型",
    lineupNotAvailable: "阵容暂未公布",
    lineupNotAvailableDesc: "首发阵容通常在开球前1小时公布，请稍后再查看。",
    matchEvents: "比赛事件", eventsTimeline: "进球、红黄牌与换人",
    noEvents: "暂无事件", noEventsDesc: "比赛开始后事件将在此显示。",
    goal: "进球", yellowCard: "黄牌", redCard: "红牌", substitution: "换人", penalty: "点球", ownGoal: "乌龙球", var: "VAR", missedPenalty: "点球未进",
    tabOdds: "赔率 & AI", tabComparison: "对比", tabLineups: "阵容", tabEvents: "事件", tabStats: "统计",
    liveStatistics: "实时统计", statsDescription: "控球率、射门、角球等",
    noStats: "暂无统计", noStatsDesc: "比赛开始后统计数据将在此显示。",
    possession: "控球率", totalShots: "射门总数", shotsOnGoal: "射正", shotsOffGoal: "射偏",
    corners: "角球", fouls: "犯规", offsides: "越位", yellowCards: "黄牌", redCards: "红牌",
    saves: "扑救", passes: "传球总数", passAccuracy: "传球成功率", expectedGoals: "预期进球 (xG)",
  },
  '繁體': {
    home: "首頁", predictions: "預測", leagues: "聯賽", performance: "AI表現", community: "社區", news: "新聞", solution: "解決方案", pricing: "價格",
    login: "登入", getStarted: "開始使用", backToPredictions: "返回預測",
    preMatchOdds: "賽前賠率", liveOdds: "即時賠率", finalOdds: "最終賠率", odds: "賠率",
    viewOddsHistory: "查看賠率歷史", oddsHistory: "賠率歷史", noOddsData: "暫無賠率資料",
    home_team: "主隊", away_team: "客隊", draw: "平局", over: "大", under: "小",
    live: "直播", fullTime: "全場結束", notStarted: "未開始", win: "勝",
    aiPredictions: "AI預測", poweredByAI: "AI驅動", selectBettingStyle: "選擇您的投注風格",
    matchResult: "比賽結果 (1X2)", overUnder: "大小球 2.5", asianHandicap: "亞洲讓球 -0.5",
    disclaimer: "這些預測由AI生成，僅供參考。請理性投注。18+",
    footer: "18+ | 博彩有風險，請理性投注。",
    allRights: "© 2026 OddsFlow. 保留所有權利。",
    refreshIn: "刷新倒計時", noHistory: "暫無賠率歷史",
    teamComparison: "球隊對比", aiAnalysis: "AI分析",
    teamLineups: "首發陣容", startingXI: "首發11人 & 陣型",
    lineupNotAvailable: "陣容暫未公布",
    lineupNotAvailableDesc: "首發陣容通常在開球前1小時公布，請稍後再查看。",
    matchEvents: "比賽事件", eventsTimeline: "進球、紅黃牌與換人",
    noEvents: "暫無事件", noEventsDesc: "比賽開始後事件將在此顯示。",
    goal: "進球", yellowCard: "黃牌", redCard: "紅牌", substitution: "換人", penalty: "點球", ownGoal: "烏龍球", var: "VAR", missedPenalty: "點球未進",
    tabOdds: "賠率 & AI", tabComparison: "對比", tabLineups: "陣容", tabEvents: "事件", tabStats: "統計",
    liveStatistics: "即時統計", statsDescription: "控球率、射門、角球等",
    noStats: "暫無統計", noStatsDesc: "比賽開始後統計數據將在此顯示。",
    possession: "控球率", totalShots: "射門總數", shotsOnGoal: "射正", shotsOffGoal: "射偏",
    corners: "角球", fouls: "犯規", offsides: "越位", yellowCards: "黃牌", redCards: "紅牌",
    saves: "撲救", passes: "傳球總數", passAccuracy: "傳球成功率", expectedGoals: "預期進球 (xG)",
  },
  ID: {
    home: "Beranda", predictions: "Prediksi", leagues: "Liga", performance: "Performa AI", community: "Komunitas", news: "Berita", solution: "Solusi", pricing: "Harga",
    login: "Masuk", getStarted: "Mulai", backToPredictions: "Kembali ke Prediksi",
    preMatchOdds: "Odds Pra-pertandingan", liveOdds: "Odds Langsung", finalOdds: "Odds Akhir", odds: "Odds",
    viewOddsHistory: "Lihat Riwayat Odds", oddsHistory: "Riwayat Odds", noOddsData: "Tidak ada data odds tersedia",
    home_team: "Tim Tuan Rumah", away_team: "Tim Tamu", draw: "Seri", over: "Lebih", under: "Kurang",
    live: "LANGSUNG", fullTime: "Selesai", notStarted: "Belum Mulai", win: "MENANG",
    aiPredictions: "Prediksi AI", poweredByAI: "Didukung AI", selectBettingStyle: "Pilih Gaya Taruhan Anda",
    matchResult: "Hasil Pertandingan (1X2)", overUnder: "Over/Under 2.5 Gol", asianHandicap: "Handicap Asia -0.5",
    disclaimer: "Prediksi ini dihasilkan oleh AI dan hanya untuk tujuan informasi. Harap bertaruh dengan bijak. 18+",
    footer: "18+ | Perjudian melibatkan risiko. Harap bertaruh dengan bijak.",
    allRights: "© 2026 OddsFlow. Hak cipta dilindungi.",
    refreshIn: "Segarkan dalam", noHistory: "Tidak ada riwayat odds",
    teamComparison: "Perbandingan Tim", aiAnalysis: "Analisis bertenaga AI",
    teamLineups: "Susunan Pemain", startingXI: "Starting XI & Formasi",
    lineupNotAvailable: "Data susunan pemain belum tersedia",
    lineupNotAvailableDesc: "Susunan pemain biasanya diumumkan 1 jam sebelum kick-off. Silakan periksa kembali nanti.",
    matchEvents: "Peristiwa Pertandingan", eventsTimeline: "Gol, Kartu & Pergantian Pemain",
    noEvents: "Belum ada peristiwa", noEventsDesc: "Peristiwa akan muncul di sini saat pertandingan dimulai.",
    goal: "Gol", yellowCard: "Kartu Kuning", redCard: "Kartu Merah", substitution: "Pergantian", penalty: "Penalti", ownGoal: "Gol Bunuh Diri", var: "VAR", missedPenalty: "Penalti Gagal",
    tabOdds: "Odds & AI", tabComparison: "Perbandingan", tabLineups: "Susunan", tabEvents: "Peristiwa", tabStats: "Statistik",
    liveStatistics: "Statistik Langsung", statsDescription: "Penguasaan Bola, Tembakan, Tendangan Sudut & Lainnya",
    noStats: "Belum ada statistik", noStatsDesc: "Statistik akan muncul di sini saat pertandingan dimulai.",
    possession: "Penguasaan Bola", totalShots: "Total Tembakan", shotsOnGoal: "Tembakan Tepat Sasaran", shotsOffGoal: "Tembakan Meleset",
    corners: "Tendangan Sudut", fouls: "Pelanggaran", offsides: "Offside", yellowCards: "Kartu Kuning", redCards: "Kartu Merah",
    saves: "Penyelamatan", passes: "Total Umpan", passAccuracy: "Akurasi Umpan", expectedGoals: "Gol yang Diharapkan (xG)",
  },
};

// Betting personality types - updated to match Performance page
const PERSONALITIES = [
  {
    id: 'value',
    aiModel: 'Value Hunter', // Database value (displays as "HDP Sniper")
    name: 'HDP Sniper',
    nameZh: 'HDP狙击手',
    image: '/performance/HDP Snipper.png',
    description: 'Precision handicap betting with high accuracy.',
    color: 'from-gray-800 to-black',
    logoColor: 'from-red-500 to-red-600',
    bgColor: 'bg-gray-800/20',
    textColor: 'text-gray-400',
    isLocked: false,
  },
  {
    id: 'aggressive',
    aiModel: 'Aggressive', // Database value (displays as "Active Trader")
    name: 'Active Trader',
    nameZh: '活跃交易者',
    image: '/performance/Active trader.png',
    description: 'Dynamic trading strategy with live signals.',
    color: 'from-sky-400 to-blue-400',
    logoColor: 'from-sky-300 to-blue-300',
    bgColor: 'bg-sky-500/20',
    textColor: 'text-sky-400',
    isLocked: false,
  },
  {
    id: 'balanced',
    aiModel: 'Balanced', // Database value (displays as "Oddsflow Core Strategy")
    name: 'Oddsflow Core Strategy',
    nameZh: 'Oddsflow核心策略',
    image: '/performance/Oddsflow Core Strategy.png',
    description: 'Balanced approach with core algorithms.',
    color: 'from-green-500 to-green-600',
    logoColor: 'from-yellow-400 to-amber-500',
    bgColor: 'bg-green-500/20',
    textColor: 'text-green-400',
    isLocked: true, // Coming Soon
  },
  {
    id: 'beta',
    aiModel: 'Oddsflow Beta v8', // Database value (displays as "Oddsflow Beta")
    name: 'Oddsflow Beta',
    nameZh: 'Oddsflow测试版',
    image: '/performance/Oddsflow Beta.png',
    description: 'Advanced beta algorithms with cutting-edge AI.',
    color: 'from-purple-600 to-purple-700',
    logoColor: 'from-yellow-400 to-amber-500',
    bgColor: 'bg-purple-600/20',
    textColor: 'text-purple-400',
    isLocked: false,
  },
];

// Flash animation types
type FlashType = 'up' | 'down' | 'none';

interface OddsFlash {
  moneyline_1x2_home: FlashType;
  moneyline_1x2_draw: FlashType;
  moneyline_1x2_away: FlashType;
  totalpoints_over: FlashType;
  totalpoints_under: FlashType;
  handicap_home: FlashType;
  handicap_away: FlashType;
}

// AI Predictions state interface
interface AIPredictions {
  moneyline: Moneyline1x2Prediction | null;
  overunder: OverUnderPrediction | null;
  handicap: HandicapPrediction | null;
  loading: boolean;
}

export default function MatchDetailClient() {
  const params = useParams();
  const urlLocale = (params.locale as string) || 'en';
  const locale = locales.includes(urlLocale as Locale) ? urlLocale : 'en';
  const selectedLang = localeToTranslationCode[locale as Locale] || 'EN';
  const router = useRouter();

  // Extract date and fixture ID from new URL structure: /predictions/[date]/[slug]
  const dateParam = params.date as string;
  const slug = params.slug as string;
  const fixtureId = parseFixtureIdFromSlug(slug);
  const matchId = fixtureId || null;

  console.log('[MatchDetail] URL params:', { dateParam, slug, fixtureId, matchId });

  const localePath = (path: string): string => {
    if (locale === 'en') return path;
    return path === '/' ? `/${locale}` : `/${locale}${path}`;
  };

  // Helper for language dropdown URLs - use the new SEO-friendly URL format
  const getLocaleUrl = (targetLocale: Locale): string => {
    const currentPath = `/predictions/${dateParam}/${slug}`;
    return targetLocale === 'en' ? currentPath : `/${targetLocale}${currentPath}`;
  };

  const [match, setMatch] = useState<Prematch | null>(null);
  const [loading, setLoading] = useState(true);
  const [selectedPersonality, setSelectedPersonality] = useState('value'); // Default to HDP Sniper
  const [langDropdownOpen, setLangDropdownOpen] = useState(false);
  const [user, setUser] = useState<User | null>(null);
  const [authChecked, setAuthChecked] = useState(false);
  const [userSubscription, setUserSubscription] = useState<UserSubscription | null>(null);
  const currentLang = LANGUAGES.find(l => l.code === selectedLang) || LANGUAGES[0];

  // Check auth session and redirect if not logged in
  useEffect(() => {
    const checkUser = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        // Not logged in - redirect to login (use replace to fix back button issue)
        router.replace(localePath('/login'));
        return;
      }
      setUser(session.user);
      setAuthChecked(true);
    };
    checkUser();

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event: any, session: any) => {
      if (!session?.user) {
        router.replace(localePath('/login'));
        return;
      }
      setUser(session.user);
    });

    return () => subscription.unsubscribe();
  }, [router]);

  // Load user subscription
  useEffect(() => {
    const loadSubscription = async () => {
      if (user) {
        const { data } = await getUserSubscription(user.id);
        setUserSubscription(data);
      }
    };
    loadSubscription();
  }, [user]);

  // Check if a betting style is available based on subscription
  const isStyleAvailable = (styleId: string) => {
    // Oddsflow Core Strategy is locked (Coming Soon)
    if (styleId === 'balanced') return false;

    // HDP Sniper (value) is always available
    if (styleId === 'value') return true;

    // If no subscription or free trial, only HDP Sniper is available
    if (!userSubscription || userSubscription.package_type === 'free_trial') {
      return false;
    }

    // Starter and Pro plans: only HDP Sniper (value) available
    if (userSubscription.package_type === 'starter' || userSubscription.package_type === 'pro') {
      return false;
    }

    // Ultimate plan: all unlocked styles available (except balanced which is locked)
    if (userSubscription.package_type === 'ultimate') {
      return styleId !== 'balanced'; // balanced is locked for everyone
    }

    return false;
  };


  // AI Predictions state
  const [aiPredictions, setAiPredictions] = useState<AIPredictions>({
    moneyline: null,
    overunder: null,
    handicap: null,
    loading: true,
  });

  // Match Prediction (from predictions_match table)
  const [matchPrediction, setMatchPrediction] = useState<MatchPrediction | null>(null);

  // Live Signals state (Value Hunter)
  const [liveSignals, setLiveSignals] = useState<LiveSignals | null>(null);
  const [liveSignalsLoading, setLiveSignalsLoading] = useState(false);

  // Lineup data
  const [lineups, setLineups] = useState<TeamLineup[] | null>(null);

  // Events data
  const [events, setEvents] = useState<FixtureEvent[] | null>(null);

  // Match statistics data
  const [matchStats, setMatchStats] = useState<MatchStatistics[] | null>(null);

  // Section tab filter: 'odds' | 'comparison' | 'lineups' | 'events' | 'stats'
  const [selectedSection, setSelectedSection] = useState<'odds' | 'comparison' | 'lineups' | 'events' | 'stats'>('odds');

  // Translation function
  const t = (key: string): string => {
    return translations[selectedLang]?.[key] || translations['EN']?.[key] || key;
  };

  // Odds related state
  const [currentOdds, setCurrentOdds] = useState<OddsHistory | null>(null);
  const [oddsHistory, setOddsHistory] = useState<OddsHistory[]>([]);
  const [showHistoryModal, setShowHistoryModal] = useState(false);
  const [refreshCountdown, setRefreshCountdown] = useState(10);
  const [oddsFlash, setOddsFlash] = useState<OddsFlash>({
    moneyline_1x2_home: 'none',
    moneyline_1x2_draw: 'none',
    moneyline_1x2_away: 'none',
    totalpoints_over: 'none',
    totalpoints_under: 'none',
    handicap_home: 'none',
    handicap_away: 'none',
  });
  const previousOddsRef = useRef<OddsHistory | null>(null);

  // Signal History state
  const [showSignalHistory, setShowSignalHistory] = useState(false);
  const [signalHistory, setSignalHistory] = useState<{
    moneyline: Moneyline1x2Prediction[];
    overunder: OverUnderPrediction[];
    handicap: HandicapPrediction[];
  }>({ moneyline: [], overunder: [], handicap: [] });
  const [liveSignalsHistory, setLiveSignalsHistory] = useState<LiveSignals[]>([]); // HDP Sniper (v7)
  const [betaSignalsHistory, setBetaSignalsHistory] = useState<LiveSignals[]>([]); // Oddsflow Beta (v8)

  // Signal History modal filters (independent from main selection)
  const [modalMarketFilter, setModalMarketFilter] = useState<'moneyline' | 'overunder' | 'handicap'>('moneyline');
  const [modalBetStyleFilter, setModalBetStyleFilter] = useState<string>('value'); // personality id

  // Market type filter
  const [selectedMarket, setSelectedMarket] = useState<'moneyline' | 'overunder' | 'handicap'>('moneyline');

  // Profit Summary state
  const [profitSummary, setProfitSummary] = useState<ProfitSummary | null>(null);
  const [profitSummaryRecords, setProfitSummaryRecords] = useState<ProfitSummary[]>([]);
  const [showProfitModal, setShowProfitModal] = useState(false);
  const [profitTypeFilter, setProfitTypeFilter] = useState<'all' | 'moneyline' | 'handicap' | 'ou'>('all');

  const currentPersonality = PERSONALITIES.find(p => p.id === selectedPersonality) || PERSONALITIES[0];

  // Fetch AI predictions from database
  const fetchAIPredictions = useCallback(async (fixtureId: number, aiModel: string) => {
    setAiPredictions(prev => ({ ...prev, loading: true }));

    try {
      // Fetch latest record from all 3 tables in parallel
      const [moneylineRes, ouRes, handicapRes] = await Promise.all([
        supabase
          .from('moneyline 1x2')
          .select('*')
          .eq('fixture_id', fixtureId)
          .eq('ai_model', aiModel)
          .order('created_at', { ascending: false })
          .limit(1),
        supabase
          .from('OverUnder')
          .select('*')
          .eq('fixture_id', fixtureId)
          .eq('ai_model', aiModel)
          .order('created_at', { ascending: false })
          .limit(1),
        supabase
          .from('Handicap')
          .select('*')
          .eq('fixture_id', fixtureId)
          .eq('ai_model', aiModel)
          .order('created_at', { ascending: false })
          .limit(1),
      ]);

      setAiPredictions({
        moneyline: moneylineRes.data?.[0] || null,
        overunder: ouRes.data?.[0] || null,
        handicap: handicapRes.data?.[0] || null,
        loading: false,
      });
    } catch (error) {
      console.error('Error fetching AI predictions:', error);
      setAiPredictions(prev => ({ ...prev, loading: false }));
    }
  }, []);

  // Update predictions when personality changes
  const handlePersonalityChange = (personalityId: string) => {
    setSelectedPersonality(personalityId);
  };

  // Fetch signal history for a specific market type and personality
  const fetchSignalHistory = useCallback(async (
    type: 'moneyline' | 'overunder' | 'handicap',
    personalityId?: string
  ) => {
    if (!match?.fixture_id) return;

    const personality = PERSONALITIES.find(p => p.id === (personalityId || selectedPersonality));
    if (!personality) return;

    try {
      let tableName = '';
      if (type === 'moneyline') tableName = 'moneyline 1x2';
      else if (type === 'overunder') tableName = 'OverUnder';
      else if (type === 'handicap') tableName = 'Handicap';

      const { data, error } = await supabase
        .from(tableName)
        .select('*')
        .eq('fixture_id', match.fixture_id)
        .eq('ai_model', personality.aiModel)
        .order('created_at', { ascending: false });

      if (!error && data) {
        setSignalHistory(prev => ({
          ...prev,
          [type]: data,
        }));
      }
    } catch (error) {
      console.error('Error fetching signal history:', error);
    }
  }, [match?.fixture_id, selectedPersonality]);

  // Get last 3 signals for finished matches
  const getLastSignals = (type: 'moneyline' | 'overunder' | 'handicap', count: number = 3) => {
    const signals = signalHistory[type];
    if (!signals || signals.length === 0) return [];
    return signals.slice(0, count);
  };

  // Get last 3 live signals (for HDP Sniper) for a specific market
  const getLastLiveSignals = (marketType: '1x2' | 'ou' | 'hdp', count: number = 3) => {
    if (!liveSignalsHistory || liveSignalsHistory.length === 0) {
      console.log('getLastLiveSignals: liveSignalsHistory is empty or null');
      return [];
    }

    console.log('getLastLiveSignals:', {
      marketType,
      historyLength: liveSignalsHistory.length,
      firstSignal: liveSignalsHistory[0]
    });

    // Return first N records directly - each record contains data for all markets
    // No filtering needed as live_signals_v7 table has all market data in each row
    return liveSignalsHistory.slice(0, count);
  };

  // Get last 3 beta signals (for Oddsflow Beta v8) for a specific market
  const getLastBetaSignals = (marketType: '1x2' | 'ou' | 'hdp', count: number = 3) => {
    if (!betaSignalsHistory || betaSignalsHistory.length === 0) {
      console.log('getLastBetaSignals: betaSignalsHistory is empty or null');
      return [];
    }

    console.log('getLastBetaSignals:', {
      marketType,
      historyLength: betaSignalsHistory.length,
      firstSignal: betaSignalsHistory[0]
    });

    // Return first N records directly - each record contains data for all markets
    // No filtering needed as live_signals_v8 table has all market data in each row
    return betaSignalsHistory.slice(0, count);
  };

  // Fetch Value Hunter signal history
  const fetchValueHunterHistory = useCallback(async () => {
    if (!match?.fixture_id) {
      console.log('fetchValueHunterHistory: No fixture_id');
      return;
    }
    console.log('fetchValueHunterHistory: Fetching for fixture_id', match.fixture_id);
    try {
      const { data, error } = await supabase
        .from('live_signals_v7')
        .select('*')
        .eq('fixture_id', match.fixture_id)
        .order('created_at', { ascending: false });

      console.log('fetchValueHunterHistory result:', {
        dataLength: data?.length || 0,
        error: error?.message,
        firstRecord: data?.[0]
      });

      if (!error && data) {
        // Use raw data directly without parsing (database has single values, not arrays)
        setLiveSignalsHistory(data as LiveSignals[]);
        console.log('fetchValueHunterHistory: Set liveSignalsHistory with', data.length, 'records');
      }
    } catch (error) {
      console.error('Error fetching value hunter history:', error);
    }
  }, [match?.fixture_id]);

  // Fetch Oddsflow Beta signal history (v8)
  const fetchBetaSignalsHistory = useCallback(async () => {
    if (!match?.fixture_id) {
      console.log('fetchBetaSignalsHistory: No fixture_id');
      return;
    }
    console.log('fetchBetaSignalsHistory: Fetching for fixture_id', match.fixture_id);
    try {
      const { data, error } = await supabase
        .from('live_signals_v8')
        .select('*')
        .eq('fixture_id', match.fixture_id)
        .order('created_at', { ascending: false });

      console.log('fetchBetaSignalsHistory result:', {
        dataLength: data?.length || 0,
        error: error?.message,
        firstRecord: data?.[0]
      });

      if (!error && data) {
        setBetaSignalsHistory(data as LiveSignals[]);
        console.log('fetchBetaSignalsHistory: Set betaSignalsHistory with', data.length, 'records');
      }
    } catch (error) {
      console.error('Error fetching beta signals history:', error);
    }
  }, [match?.fixture_id]);

  // Open signal history modal with default filters
  const openSignalHistory = () => {
    // Set default filters based on current selections
    setModalMarketFilter(selectedMarket);
    setModalBetStyleFilter(selectedPersonality);

    // Fetch initial data
    if (selectedPersonality === 'value') {
      fetchValueHunterHistory();
    } else {
      fetchSignalHistory(selectedMarket, selectedPersonality);
    }

    setShowSignalHistory(true);
  };

  // Fetch data when modal filters change
  useEffect(() => {
    if (!showSignalHistory) return;

    if (modalBetStyleFilter === 'value') {
      fetchValueHunterHistory();
    } else {
      fetchSignalHistory(modalMarketFilter, modalBetStyleFilter);
    }
  }, [showSignalHistory, modalMarketFilter, modalBetStyleFilter, fetchSignalHistory, fetchValueHunterHistory]);

  // Fetch signal history when match is finished (to show last 3 signals)
  useEffect(() => {
    if (match?.type === 'Finished' && match?.fixture_id) {
      // Fetch regular signal history for all markets
      fetchSignalHistory('moneyline', selectedPersonality);
      fetchSignalHistory('overunder', selectedPersonality);
      fetchSignalHistory('handicap', selectedPersonality);

      // Always fetch live signals history (for HDP Sniper) when match is finished
      // This ensures data is available when user switches to HDP Sniper
      fetchValueHunterHistory();

      // Always fetch beta signals history (for Oddsflow Beta) when match is finished
      // This ensures data is available when user switches to Oddsflow Beta
      fetchBetaSignalsHistory();
    }
  }, [match?.type, match?.fixture_id, selectedPersonality, fetchSignalHistory, fetchValueHunterHistory, fetchBetaSignalsHistory]);

  // Fetch profit summary for finished matches
  const fetchProfitSummary = useCallback(async (fixtureId: number, betStyle?: string) => {
    try {
      // fixture_id in profit_summary table is stored as string
      let query = supabase
        .from('profit_summary')
        .select('*')
        .eq('fixture_id', String(fixtureId));

      // Filter by bet_style if provided (for Conservative)
      if (betStyle) {
        query = query.eq('bet_style', betStyle);
      }

      const { data, error } = await query.order('bet_time', { ascending: false });

      if (!error && data && data.length > 0) {
        // First record has the latest summary totals
        setProfitSummary(data[0]);
        // All records for the bet details table
        setProfitSummaryRecords(data);
      } else {
        setProfitSummary(null);
        setProfitSummaryRecords([]);
      }
    } catch (error) {
      console.error('Error fetching profit summary:', error);
      setProfitSummary(null);
      setProfitSummaryRecords([]);
    }
  }, []);

  // Open profit summary modal
  const openProfitSummary = () => {
    if (match?.fixture_id) {
      // Map personality ID to database bet_style values
      let betStyle: string | undefined;
      if (selectedPersonality === 'value') {
        betStyle = 'Value Hunter'; // HDP Sniper in database
      } else if (selectedPersonality === 'aggressive') {
        betStyle = 'Aggressive'; // Active Trader in database
      } else if (selectedPersonality === 'balanced') {
        betStyle = 'Balanced'; // Oddsflow Core Strategy in database
      } else if (selectedPersonality === 'beta') {
        betStyle = 'Oddsflow Beta v8'; // Oddsflow Beta in database
      }
      fetchProfitSummary(match.fixture_id, betStyle);
      setShowProfitModal(true);
    }
  };

  // Fetch AI predictions when personality or match changes
  useEffect(() => {
    const personality = PERSONALITIES.find(p => p.id === selectedPersonality);
    if (match?.fixture_id && personality) {
      fetchAIPredictions(match.fixture_id, personality.aiModel);

      // Fetch live signals for Value Hunter personality
      if (selectedPersonality === 'value') {
        setLiveSignalsLoading(true);
        getLiveSignals(match.fixture_id).then(({ data, error }) => {
          console.log('[Value Hunter] Response:', { data, error });
          console.log('[Value Hunter] Available fields:', data ? Object.keys(data) : 'no data');
          // Use raw data directly (database has single values, not arrays)
          setLiveSignals(data);
          setLiveSignalsLoading(false);
        }).catch((err) => {
          console.error('[Value Hunter] Error:', err);
          setLiveSignalsLoading(false);
        });
      }
    }
  }, [selectedPersonality, match?.fixture_id, fetchAIPredictions]);

  // Fetch match data from database
  const fetchMatch = useCallback(async (isRefresh: boolean = false) => {
    console.log('[MatchDetail] Fetching match, matchId:', matchId, 'type:', typeof matchId);

    if (!matchId) {
      console.log('[MatchDetail] No matchId provided');
      setLoading(false);
      return null;
    }

    try {
      console.log('[MatchDetail] Querying prematches with fixture_id:', matchId);
      // Use limit(1) instead of single() to handle duplicate records
      // Order by id descending to get the most recent record
      const { data, error } = await supabase
        .from('prematches')
        .select('*')
        .eq('fixture_id', matchId)
        .order('id', { ascending: false })
        .limit(1);

      console.log('[MatchDetail] Query result:');
      console.log('  - data array:', data);
      console.log('  - error:', error);

      if (error) {
        console.error('[MatchDetail] Supabase error details:', {
          code: error.code,
          message: error.message,
          details: error.details,
          hint: error.hint
        });
        throw error;
      }

      // Extract first record from array
      const matchData = data && data.length > 0 ? data[0] : null;
      console.log('  - extracted match:', matchData);

      if (!matchData) {
        console.warn('[MatchDetail] No data returned for fixture_id:', matchId);
      }

      setMatch(matchData);
      return matchData;
    } catch (error) {
      console.error('[MatchDetail] Error fetching match:');
      console.error('  - Error object:', error);
      console.error('  - Error type:', typeof error);
      console.error('  - Error keys:', Object.keys(error as object));
      console.error('  - Full error:', JSON.stringify(error, null, 2));
      return null;
    } finally {
      if (!isRefresh) {
        setLoading(false);
      }
    }
  }, [matchId]);

  // Fetch odds from database
  const fetchOdds = useCallback(async (fixtureId: number, isLive: boolean) => {
    try {
      const { data, error } = await supabase
        .from('odds_history')
        .select('*')
        .eq('fixture_id', fixtureId)
        .order('created_at', { ascending: false });

      if (error) throw error;

      if (data && data.length > 0) {
        const latestOdds = data[0];

        // For live matches, calculate flash animations
        if (isLive && previousOddsRef.current) {
          const prev = previousOddsRef.current;
          const calcFlash = (newVal: number | null | undefined, oldVal: number | null | undefined): FlashType => {
            if (newVal == null || oldVal == null) return 'none';
            if (newVal < oldVal) return 'down';
            if (newVal > oldVal) return 'up';
            return 'none';
          };
          const newFlash: OddsFlash = {
            moneyline_1x2_home: calcFlash(latestOdds.moneyline_1x2_home, prev.moneyline_1x2_home),
            moneyline_1x2_draw: calcFlash(latestOdds.moneyline_1x2_draw, prev.moneyline_1x2_draw),
            moneyline_1x2_away: calcFlash(latestOdds.moneyline_1x2_away, prev.moneyline_1x2_away),
            totalpoints_over: calcFlash(latestOdds.totalpoints_over, prev.totalpoints_over),
            totalpoints_under: calcFlash(latestOdds.totalpoints_under, prev.totalpoints_under),
            handicap_home: calcFlash(latestOdds.handicap_home, prev.handicap_home),
            handicap_away: calcFlash(latestOdds.handicap_away, prev.handicap_away),
          };
          setOddsFlash(newFlash);

          // Clear flash after 2 seconds (match CSS animation duration)
          setTimeout(() => {
            setOddsFlash({
              moneyline_1x2_home: 'none',
              moneyline_1x2_draw: 'none',
              moneyline_1x2_away: 'none',
              totalpoints_over: 'none',
              totalpoints_under: 'none',
              handicap_home: 'none',
              handicap_away: 'none',
            });
          }, 2000);
        }

        previousOddsRef.current = latestOdds;
        setCurrentOdds(latestOdds);
        setOddsHistory(data);
      }
    } catch (error) {
      console.error('Error fetching odds:', error);
    }
  }, []);

  // Fetch all data (match + odds + AI predictions + lineups)
  const fetchAllData = useCallback(async (isRefresh: boolean = false) => {
    const matchData = await fetchMatch(isRefresh);
    console.log('[fetchAllData] matchData:', matchData?.id, 'fixture_id:', matchData?.fixture_id);
    if (matchData?.fixture_id) {
      // Fetch odds, AI predictions, match prediction, lineups, events, and statistics in parallel
      const personality = PERSONALITIES.find(p => p.id === selectedPersonality);
      const [, , predictionResult, lineupsResult, eventsResult, statsResult, liveSignalsResult] = await Promise.all([
        fetchOdds(matchData.fixture_id, matchData.type === 'In Play'),
        personality ? fetchAIPredictions(matchData.fixture_id, personality.aiModel) : Promise.resolve(),
        getMatchPrediction(matchData.fixture_id),
        // Only fetch lineups on initial load, not on refresh
        !isRefresh ? getFixtureLineups(matchData.fixture_id) : Promise.resolve({ data: null }),
        // Fetch events (always fetch to show live updates)
        getFixtureEvents(matchData.fixture_id),
        // Fetch match statistics
        getMatchStatistics(matchData.fixture_id),
        // Fetch live signals for Value Hunter (refresh on every cycle)
        selectedPersonality === 'value'
          ? getLiveSignals(matchData.fixture_id)
          : Promise.resolve({ data: null }),
      ]);
      if (predictionResult?.data) {
        setMatchPrediction(predictionResult.data);
      }
      if (lineupsResult?.data) {
        setLineups(lineupsResult.data);
      }
      if (eventsResult?.data) {
        console.log('[page] Setting events:', eventsResult.data.length, eventsResult.data);
        setEvents(eventsResult.data);
      } else {
        console.log('[page] No events data, eventsResult:', eventsResult);
      }
      if (statsResult?.data) {
        setMatchStats(statsResult.data);
      }
      // Update live signals state for Value Hunter
      if (liveSignalsResult?.data) {
        setLiveSignals(liveSignalsResult.data);
      }
    }
  }, [fetchMatch, fetchOdds, fetchAIPredictions, selectedPersonality]);

  // Initial data fetch
  useEffect(() => {
    if (matchId) {
      fetchAllData(false);
    }
  }, [matchId, fetchAllData]);

  // Set up polling and countdown - refresh all data every 10 seconds
  useEffect(() => {
    if (match) {
      // Reset countdown
      setRefreshCountdown(10);

      // Countdown timer - updates every second and triggers fetch at 0
      const countdownInterval = setInterval(() => {
        setRefreshCountdown(prev => {
          if (prev <= 1) {
            // Fetch all data (match score + odds + AI predictions) when countdown reaches 0
            fetchAllData(true);
            return 10; // Reset to 10
          }
          return prev - 1;
        });
      }, 1000);

      return () => {
        clearInterval(countdownInterval);
      };
    }
  }, [match, fetchAllData]);

  // Background refresh for match score and clock every 10 seconds (for live matches)
  useEffect(() => {
    if (match?.type === 'In Play') {
      const scoreRefreshInterval = setInterval(() => {
        // Silently refresh match data (score + clock)
        fetchMatch(true);
      }, 10000); // Every 10 seconds

      return () => {
        clearInterval(scoreRefreshInterval);
      };
    }
  }, [match?.type, fetchMatch]);

  const formatDateTime = (dateStr: string) => {
    // Database stores Malaysia time (UTC+8), interpret correctly
    let correctedDateStr = dateStr;
    if (!dateStr.includes('Z') && !dateStr.includes('+') && !dateStr.includes('-', 10)) {
      correctedDateStr = dateStr + '+08:00';
    }
    const date = new Date(correctedDateStr);

    const day = date.getDate();
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = months[date.getMonth()];
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');

    // Get user's timezone abbreviation
    const tzAbbr = new Intl.DateTimeFormat('en', { timeZoneName: 'short' }).formatToParts(date).find(p => p.type === 'timeZoneName')?.value || 'Local';

    return `${day} ${month} ${date.getFullYear()} • ${hours}:${minutes} ${tzAbbr}`;
  };

  const formatHistoryTime = (dateStr: string) => {
    // Database stores Malaysia time (UTC+8), interpret correctly
    let correctedDateStr = dateStr;
    if (!dateStr.includes('Z') && !dateStr.includes('+') && !dateStr.includes('-', 10)) {
      correctedDateStr = dateStr + '+08:00';
    }
    const date = new Date(correctedDateStr);

    const day = date.getDate();
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = months[date.getMonth()];
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${day} ${month} ${hours}:${minutes}`;
  };

  // Get flash animation class - RED for down (跌), GREEN for up (涨)
  const getFlashClass = (flashType: FlashType) => {
    switch (flashType) {
      case 'down':
        return 'animate-flash-red';
      case 'up':
        return 'animate-flash-green';
      case 'none':
        return '';
      default:
        return '';
    }
  };

  // Render odds title based on match type
  const getOddsTitle = () => {
    switch (match?.type) {
      case 'Scheduled':
        return t('preMatchOdds');
      case 'In Play':
        return t('liveOdds');
      case 'Finished':
        return t('finalOdds');
      default:
        return t('odds');
    }
  };

  // Show loading while checking auth
  if (!authChecked) {
    return (
      <div className="min-h-screen bg-[#0a0a0f] text-white flex items-center justify-center">
        <div className="w-10 h-10 border-4 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin" />
      </div>
    );
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-[#0a0a0f] text-white flex items-center justify-center">
        <div className="w-10 h-10 border-4 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin" />
      </div>
    );
  }

  if (!match) {
    return (
      <div className="min-h-screen bg-[#0a0a0f] text-white flex flex-col items-center justify-center">
        <h1 className="text-2xl font-bold mb-4">Match not found</h1>
        <Link href={dateParam ? localePath(`/predictions?date=${dateParam}`) : localePath('/predictions')} className="text-emerald-400 hover:underline">
          ← {t('backToPredictions')}
        </Link>
      </div>
    );
  }

  // Generate the canonical URL for this match
  const matchUrl = `https://www.oddsflow.ai${locale === 'en' ? '' : `/${locale}`}/predictions/${dateParam}/${slug}`;

  return (
    <div className="min-h-screen bg-[#0a0a0f] text-white">
      {/* SportsEvent Schema for SEO */}
      {match && (
        <SportsEventJsonLd
          name={`${match.home_name} vs ${match.away_name}`}
          homeTeam={match.home_name}
          awayTeam={match.away_name}
          startDate={match.start_date_msia}
          location={match.venue_name || undefined}
          url={matchUrl}
        />
      )}

      {/* Navbar */}
      <nav className="fixed top-0 left-0 right-0 z-50 bg-black/20 backdrop-blur-xl border-b border-white/5">
        <div className="w-full px-4 sm:px-6 lg:px-12">
          <div className="flex items-center justify-between h-16">
            <Link href={localePath('/')} className="flex items-center gap-3 flex-shrink-0">
              <img src="/homepage/OddsFlow Logo2.png" alt="OddsFlow Logo" className="w-14 h-14 object-contain" />
              <span className="text-xl font-bold tracking-tight">OddsFlow</span>
            </Link>

            <div className="hidden md:flex items-center gap-6">
              <Link href={localePath('/')} className="text-gray-400 hover:text-white transition-colors text-sm font-medium">{t('home')}</Link>
              <Link href={localePath('/predictions')} className="text-emerald-400 text-sm font-medium">{t('predictions')}</Link>
              <Link href={localePath('/leagues')} className="text-gray-400 hover:text-white transition-colors text-sm font-medium">{t('leagues')}</Link>
              <Link href={localePath('/performance')} className="text-gray-400 hover:text-white transition-colors text-sm font-medium">{t('performance')}</Link>
              <Link href={localePath('/community')} className="text-gray-400 hover:text-white transition-colors text-sm font-medium">{t('community')}</Link>
              <Link href={localePath('/news')} className="text-gray-400 hover:text-white transition-colors text-sm font-medium">{t('news')}</Link>
              <Link href={localePath('/solution')} className="text-gray-400 hover:text-white transition-colors text-sm font-medium">{t('solution')}</Link>
              <Link href={localePath('/pricing')} className="text-gray-400 hover:text-white transition-colors text-sm font-medium">{t('pricing')}</Link>
            </div>

            <div className="flex items-center gap-2 sm:gap-3 flex-shrink-0">
              {/* Language Selector */}
              <div className="relative">
                <button
                  onClick={() => setLangDropdownOpen(!langDropdownOpen)}
                  className="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-all text-sm cursor-pointer"
                >
                  <FlagIcon code={currentLang.code} size={20} />
                  <span className="font-medium">{currentLang.code}</span>
                  <svg
                    className={`w-4 h-4 transition-transform ${langDropdownOpen ? 'rotate-180' : ''}`}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {langDropdownOpen && (
                  <>
                    <div className="fixed inset-0 z-40" onClick={() => setLangDropdownOpen(false)} />
                    <div className="absolute right-0 mt-2 w-48 py-2 bg-gray-900 border border-white/10 rounded-xl shadow-xl z-50 max-h-80 overflow-y-auto">
                      {locales.map((loc) => (
                        <Link
                          key={loc}
                          href={getLocaleUrl(loc)}
                          className={`w-full flex items-center gap-3 px-4 py-2.5 hover:bg-white/10 transition-colors text-left cursor-pointer ${
                            locale === loc ? 'bg-emerald-500/20 text-emerald-400' : 'text-gray-300'
                          }`}
                          onClick={() => setLangDropdownOpen(false)}
                        >
                          <FlagIcon code={loc} size={20} />
                          <span className="font-medium">{localeNames[loc]}</span>
                        </Link>
                      ))}
                    </div>
                  </>
                )}
              </div>
              {user ? (
                <Link href={localePath('/dashboard')} className="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-all cursor-pointer">
                  {user.user_metadata?.avatar_url || user.user_metadata?.picture ? (
                    <img src={user.user_metadata?.avatar_url || user.user_metadata?.picture} alt="" className="w-8 h-8 rounded-full" />
                  ) : (
                    <div className="w-8 h-8 rounded-full bg-gradient-to-r from-emerald-500 to-cyan-500 flex items-center justify-center text-black font-bold text-sm">
                      {user.user_metadata?.full_name?.charAt(0) || user.email?.charAt(0)?.toUpperCase() || 'U'}
                    </div>
                  )}
                  <span className="text-sm font-medium hidden sm:block">{user.user_metadata?.full_name || user.email?.split('@')[0]}</span>
                </Link>
              ) : (
                <>
                  <Link href={localePath('/login')} className="px-4 py-2 rounded-lg border border-white/20 text-white hover:bg-white/10 transition-all text-sm font-medium hidden sm:block cursor-pointer">{t('login')}</Link>
                  <Link href={localePath('/get-started')} className="px-5 py-2.5 rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 text-black font-semibold text-sm hover:shadow-lg hover:shadow-emerald-500/25 transition-all cursor-pointer">{t('getStarted')}</Link>
                </>
              )}

              {/* World Cup Special Button */}
              <Link
                href={localePath('/worldcup')}
                className="relative hidden sm:flex items-center gap-1.5 px-5 py-2.5 rounded-lg bg-gradient-to-r from-yellow-400 via-amber-500 to-yellow-400 shadow-[0_0_20px_rgba(251,191,36,0.5)] hover:shadow-[0_0_30px_rgba(251,191,36,0.7)] transition-all cursor-pointer group overflow-hidden hover:scale-105"
              >
                <span className="absolute inset-0 bg-gradient-to-r from-transparent via-white/60 to-transparent animate-shimmer" />
                <img src="/homepage/FIFA-2026-World-Cup-Logo-removebg-preview.png" alt="FIFA World Cup 2026" className="h-5 w-auto object-contain relative z-10" />
                <span className="text-black font-semibold text-sm relative z-10">FIFA 2026</span>
              </Link>
            </div>
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="pt-24 pb-16 px-4">
        <div className="max-w-4xl mx-auto">
          {/* Back Button */}
          <Link href={dateParam ? localePath(`/predictions?date=${dateParam}`) : localePath('/predictions')} className="inline-flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-6">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
            {t('backToPredictions')}
          </Link>

          {/* Match Header */}
          <div className="relative rounded-2xl border border-white/5 p-6 mb-6 overflow-hidden">
            {/* Background Image */}
            <img
              src="/loading/2425_MD33_FCBBMG_JH_093_4gud8JWh_20250512053606.webp"
              alt=""
              className="absolute inset-0 w-full h-full object-cover"
            />
            {/* Dark Overlay */}
            <div className="absolute inset-0 bg-gradient-to-br from-gray-900/90 to-gray-950/95" />

            {/* League */}
            <div className="relative flex items-center gap-3 mb-6">
              {match.league_logo && (
                <div className="w-8 h-8 rounded-lg bg-white p-1 flex items-center justify-center">
                  <img src={match.league_logo} alt={match.league_name} className="w-6 h-6 object-contain" />
                </div>
              )}
              <span className="text-gray-400 font-medium">{match.league_name}</span>
              <span className="text-gray-600">•</span>
              <span className="text-gray-500 text-sm">{formatDateTime(match.start_date_msia)}</span>
            </div>

            {/* Teams */}
            <div className="relative flex items-center justify-center gap-8 py-6">
              {/* Home Team */}
              <div className="flex flex-col items-center gap-3 flex-1">
                <div className="relative">
                  {match.home_logo && (
                    <div className={`w-20 h-20 rounded-full bg-white p-2 flex items-center justify-center shadow-lg ${
                      match.type === 'Finished' && (match.goals_home ?? 0) > (match.goals_away ?? 0) ? 'ring-2 ring-emerald-500' : ''
                    }`}>
                      <img src={match.home_logo} alt={match.home_name} className="w-full h-full object-contain" />
                    </div>
                  )}
                  {match.type === 'Finished' && (match.goals_home ?? 0) > (match.goals_away ?? 0) && (
                    <div className="absolute -top-1 -right-1 px-2 py-0.5 rounded-full bg-emerald-500 text-white text-[10px] font-bold shadow-lg">
                      WIN
                    </div>
                  )}
                </div>
                <span className={`font-semibold text-lg text-center ${
                  match.type === 'Finished' && (match.goals_home ?? 0) > (match.goals_away ?? 0) ? 'text-emerald-400' : 'text-white'
                }`}>{match.home_name}</span>
                <span className="text-xs text-gray-500">HOME</span>
              </div>

              {/* VS / Score */}
              <div className="flex flex-col items-center">
                {(match.type === 'In Play' || match.type === 'Finished') ? (
                  <>
                    <div className="flex items-center gap-4">
                      <span className={`text-4xl font-bold ${match.type === 'In Play' ? 'text-white' : 'text-gray-300'}`}>
                        {match.goals_home ?? 0}
                      </span>
                      <span className="text-2xl font-bold text-gray-600">-</span>
                      <span className={`text-4xl font-bold ${match.type === 'In Play' ? 'text-white' : 'text-gray-300'}`}>
                        {match.goals_away ?? 0}
                      </span>
                    </div>
                    <span className={`mt-2 px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1.5 ${
                      match.type === 'In Play' ? 'bg-red-500/20 text-red-400' : 'bg-gray-500/20 text-gray-400'
                    }`}>
                      {match.type === 'In Play' && (
                        <span className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                      )}
                      {match.type === 'In Play' ? (match.status_elapsed ? `${match.status_elapsed}'` : 'LIVE') : 'Full Time'}
                    </span>
                  </>
                ) : (
                  <>
                    <span className="text-3xl font-bold text-gray-600">VS</span>
                    <span className={`mt-2 px-3 py-1 rounded-full text-xs font-medium ${
                      match.type === 'Postponed' ? 'bg-amber-500/20 text-amber-400' :
                      match.type === 'Cancelled' ? 'bg-red-500/20 text-red-400' :
                      match.type === 'Abandoned' ? 'bg-orange-500/20 text-orange-400' :
                      match.type === 'Not Played' ? 'bg-gray-500/20 text-gray-400' :
                      'bg-emerald-500/20 text-emerald-400'
                    }`}>
                      {match.type === 'Postponed' ? 'Postponed' :
                       match.type === 'Cancelled' ? 'Cancelled' :
                       match.type === 'Abandoned' ? 'Abandoned' :
                       match.type === 'Not Played' ? 'Not Played' :
                       'Not Started'}
                    </span>
                  </>
                )}
              </div>

              {/* Away Team */}
              <div className="flex flex-col items-center gap-3 flex-1">
                <div className="relative">
                  {match.away_logo && (
                    <div className={`w-20 h-20 rounded-full bg-white p-2 flex items-center justify-center shadow-lg ${
                      match.type === 'Finished' && (match.goals_away ?? 0) > (match.goals_home ?? 0) ? 'ring-2 ring-emerald-500' : ''
                    }`}>
                      <img src={match.away_logo} alt={match.away_name} className="w-full h-full object-contain" />
                    </div>
                  )}
                  {match.type === 'Finished' && (match.goals_away ?? 0) > (match.goals_home ?? 0) && (
                    <div className="absolute -top-1 -right-1 px-2 py-0.5 rounded-full bg-emerald-500 text-white text-[10px] font-bold shadow-lg">
                      WIN
                    </div>
                  )}
                </div>
                <span className={`font-semibold text-lg text-center ${
                  match.type === 'Finished' && (match.goals_away ?? 0) > (match.goals_home ?? 0) ? 'text-emerald-400' : 'text-white'
                }`}>{match.away_name}</span>
                <span className="text-xs text-gray-500">AWAY</span>
              </div>
            </div>

            {/* Venue */}
            {match.venue_name && (
              <div className="relative text-center text-gray-500 text-sm mt-4">
                <svg className="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                {match.venue_name}, {match.venue_city}
              </div>
            )}
          </div>

          {/* Section Tab Filter */}
          <div className="flex items-center gap-2 mb-6 overflow-x-auto pb-2">
            <button
              onClick={() => setSelectedSection('odds')}
              className={`flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all whitespace-nowrap ${
                selectedSection === 'odds'
                  ? 'bg-gradient-to-r from-emerald-500 to-cyan-500 text-white shadow-lg shadow-emerald-500/25'
                  : 'bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white border border-white/10'
              }`}
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
              </svg>
              {t('tabOdds')}
            </button>
            <button
              onClick={() => setSelectedSection('comparison')}
              className={`flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all whitespace-nowrap ${
                selectedSection === 'comparison'
                  ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg shadow-purple-500/25'
                  : 'bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white border border-white/10'
              }`}
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              {t('tabComparison')}
            </button>
            <button
              onClick={() => setSelectedSection('lineups')}
              className={`flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all whitespace-nowrap ${
                selectedSection === 'lineups'
                  ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-lg shadow-green-500/25'
                  : 'bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white border border-white/10'
              }`}
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              {t('tabLineups')}
            </button>
            <button
              onClick={() => setSelectedSection('events')}
              className={`flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all whitespace-nowrap ${
                selectedSection === 'events'
                  ? 'bg-gradient-to-r from-orange-500 to-amber-600 text-white shadow-lg shadow-orange-500/25'
                  : 'bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white border border-white/10'
              }`}
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              {t('tabEvents')}
              {match.type === 'In Play' && (
                <div className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse" />
              )}
            </button>
            <button
              onClick={() => setSelectedSection('stats')}
              className={`flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all whitespace-nowrap ${
                selectedSection === 'stats'
                  ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg shadow-cyan-500/25'
                  : 'bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white border border-white/10'
              }`}
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              {t('tabStats')}
              {match.type === 'In Play' && (
                <div className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse" />
              )}
            </button>
          </div>

          {/* Team Comparison Section - AI Analysis */}
          {selectedSection === 'comparison' && (
          <div className="bg-gradient-to-br from-gray-900/80 to-gray-950/80 rounded-2xl border border-white/5 p-4 sm:p-5 mb-6">
            {/* Header */}
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <div>
                <h2 className="text-lg font-bold text-white">{t('teamComparison')}</h2>
                <p className="text-xs text-gray-500">{t('aiAnalysis')}</p>
              </div>
            </div>

            {/* Content */}
            <div>
              {!matchPrediction || (!matchPrediction.winner_name && !matchPrediction.prob_home && !matchPrediction.strength_home) ? (
                  <div className="text-center py-12">
                    <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-purple-500/10 border border-purple-500/20 flex items-center justify-center">
                      <svg className="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                      </svg>
                    </div>
                    <h3 className="text-lg font-semibold text-gray-300 mb-2">Team Comparison Coming Soon</h3>
                    <p className="text-gray-500 text-sm">AI analysis data will be available closer to match time</p>
                  </div>
                ) : (
                  <>
                  {/* AI Advice */}
                  {matchPrediction.advice && (
                    <div className="mb-6 p-4 rounded-xl bg-gradient-to-r from-emerald-500/10 to-cyan-500/10 border border-emerald-500/20">
                      <div className="flex items-start gap-3">
                        <div className="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
                          <svg className="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                          </svg>
                        </div>
                        <div>
                          <div className="text-xs text-emerald-400 font-medium uppercase tracking-wider mb-1">AI Advice</div>
                          <p className="text-gray-300 text-sm">{matchPrediction.advice}</p>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Prediction Summary */}
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                    {matchPrediction.winner_name && (
                      <div className="relative overflow-hidden rounded-xl p-4 text-center bg-gradient-to-br from-emerald-500/20 to-cyan-500/20 border border-emerald-500/30 shadow-lg shadow-emerald-500/20">
                        {/* Shimmer effect */}
                        <div className="absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/25 to-transparent" />
                        {/* Glow pulse */}
                        <div className="absolute inset-0 animate-pulse bg-emerald-500/10 rounded-xl" />
                        <div className="relative">
                          <div className="text-xs text-emerald-300/80 mb-2 font-medium uppercase tracking-wider">Predicted Winner</div>
                          <div className="text-emerald-400 font-bold text-lg flex items-center justify-center gap-2">
                            <span className="animate-bounce text-xl">🏆</span>
                            <span className="drop-shadow-[0_0_10px_rgba(16,185,129,0.5)]">{matchPrediction.winner_name}</span>
                          </div>
                        </div>
                      </div>
                    )}
                    {matchPrediction.under_over && (
                      <div className="bg-white/5 rounded-xl p-4 text-center border border-white/5">
                        <div className="text-xs text-gray-500 mb-2 uppercase tracking-wider">Goals</div>
                        <div className="text-cyan-400 font-bold text-base">{matchPrediction.under_over}</div>
                      </div>
                    )}
                    {matchPrediction.goals_home && (
                      <div className={`relative overflow-hidden rounded-xl p-4 text-center border transition-all duration-300 ${
                        matchPrediction.winner_name === match?.home_name
                          ? 'bg-gradient-to-br from-blue-500/20 to-cyan-500/20 border-blue-500/30 shadow-lg shadow-blue-500/20'
                          : 'bg-gradient-to-br from-blue-500/10 to-blue-600/5 border-blue-500/20'
                      }`}>
                        {/* Shimmer effect for winner or subtle pulse for non-winner */}
                        {matchPrediction.winner_name === match?.home_name ? (
                          <div className="absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/20 to-transparent" />
                        ) : (
                          <div className="absolute inset-0 animate-pulse bg-blue-500/5 rounded-xl" />
                        )}
                        <div className="relative">
                          <div className={`text-xs mb-2 uppercase tracking-wider ${matchPrediction.winner_name === match?.home_name ? 'text-blue-300/80 font-medium' : 'text-gray-500'}`}>Home Goals</div>
                          <div className={`font-bold text-lg ${matchPrediction.winner_name === match?.home_name ? 'text-blue-400 drop-shadow-[0_0_10px_rgba(59,130,246,0.6)]' : 'text-blue-400'}`}>
                            {matchPrediction.goals_home}
                          </div>
                        </div>
                      </div>
                    )}
                    {matchPrediction.goals_away && (
                      <div className={`relative overflow-hidden rounded-xl p-4 text-center border transition-all duration-300 ${
                        matchPrediction.winner_name === match?.away_name
                          ? 'bg-gradient-to-br from-green-500/20 to-emerald-500/20 border-green-500/30 shadow-lg shadow-green-500/20'
                          : 'bg-gradient-to-br from-green-500/10 to-green-600/5 border-green-500/20'
                      }`}>
                        {/* Shimmer effect for winner or subtle pulse for non-winner */}
                        {matchPrediction.winner_name === match?.away_name ? (
                          <div className="absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/20 to-transparent" />
                        ) : (
                          <div className="absolute inset-0 animate-pulse bg-green-500/5 rounded-xl" />
                        )}
                        <div className="relative">
                          <div className={`text-xs mb-2 uppercase tracking-wider ${matchPrediction.winner_name === match?.away_name ? 'text-green-300/80 font-medium' : 'text-gray-500'}`}>Away Goals</div>
                          <div className={`font-bold text-lg ${matchPrediction.winner_name === match?.away_name ? 'text-green-400 drop-shadow-[0_0_10px_rgba(34,197,94,0.6)]' : 'text-green-400'}`}>
                            {matchPrediction.goals_away}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Win Probability Bar */}
                  {(matchPrediction.prob_home || matchPrediction.prob_draw || matchPrediction.prob_away) && (
                    <div className="mb-6">
                      <div className="text-xs text-gray-500 mb-2 uppercase tracking-wider">Win Probability</div>
                      <div className="flex h-8 rounded-lg overflow-hidden">
                        <div
                          className="bg-blue-500 flex items-center justify-center text-xs font-bold text-white"
                          style={{ width: `${matchPrediction.prob_home || 0}%` }}
                        >
                          {matchPrediction.prob_home ? `${Math.round(matchPrediction.prob_home)}%` : ''}
                        </div>
                        <div
                          className="bg-gray-500 flex items-center justify-center text-xs font-bold text-white"
                          style={{ width: `${matchPrediction.prob_draw || 0}%` }}
                        >
                          {matchPrediction.prob_draw ? `${Math.round(matchPrediction.prob_draw)}%` : ''}
                        </div>
                        <div
                          className="bg-green-500 flex items-center justify-center text-xs font-bold text-white"
                          style={{ width: `${matchPrediction.prob_away || 0}%` }}
                        >
                          {matchPrediction.prob_away ? `${Math.round(matchPrediction.prob_away)}%` : ''}
                        </div>
                      </div>
                      <div className="flex justify-between text-xs text-gray-500 mt-1">
                        <span>{match?.home_name}</span>
                        <span>Draw</span>
                        <span>{match?.away_name}</span>
                      </div>
                    </div>
                  )}

                  {/* Radar Chart */}
                  <div className="mb-8">
                    <ResponsiveContainer width="100%" height={320}>
                      <RadarChart
                        data={[
                          { stat: 'Strength', home: matchPrediction.strength_home ?? 0, away: matchPrediction.strength_away ?? 0 },
                          { stat: 'Attacking', home: matchPrediction.attacking_home ?? 0, away: matchPrediction.attacking_away ?? 0 },
                          { stat: 'Defensive', home: matchPrediction.defensive_home ?? 0, away: matchPrediction.defensive_away ?? 0 },
                          { stat: 'Poisson', home: matchPrediction.poisson_home ?? 0, away: matchPrediction.poisson_away ?? 0 },
                          { stat: 'H2H Strength', home: matchPrediction.h2h_strength_home ?? 0, away: matchPrediction.h2h_strength_away ?? 0 },
                          { stat: 'H2H Goals', home: matchPrediction.h2h_goals_home ?? 0, away: matchPrediction.h2h_goals_away ?? 0 },
                        ]}
                        margin={{ top: 20, right: 30, bottom: 20, left: 30 }}
                      >
                        <PolarGrid stroke="#374151" />
                        <PolarAngleAxis
                          dataKey="stat"
                          tick={{ fill: '#9CA3AF', fontSize: 11 }}
                        />
                        <PolarRadiusAxis
                          angle={90}
                          domain={[0, 100]}
                          tick={{ fill: '#6B7280', fontSize: 10 }}
                          tickCount={6}
                        />
                        <Radar
                          name={match?.home_name || 'Home'}
                          dataKey="home"
                          stroke="#3B82F6"
                          fill="#3B82F6"
                          fillOpacity={0.4}
                          strokeWidth={2}
                        />
                        <Radar
                          name={match?.away_name || 'Away'}
                          dataKey="away"
                          stroke="#22C55E"
                          fill="#22C55E"
                          fillOpacity={0.4}
                          strokeWidth={2}
                        />
                        <Legend
                          wrapperStyle={{ paddingTop: '20px' }}
                          formatter={(value) => <span style={{ color: '#D1D5DB', fontSize: '12px' }}>{value}</span>}
                        />
                      </RadarChart>
                    </ResponsiveContainer>
                  </div>

                  {/* Comparison Bars */}
                  <div className="space-y-4">
                    {/* Strength */}
                    {(matchPrediction.strength_home !== null || matchPrediction.strength_away !== null) && (
                      <div>
                        <div className="flex justify-between text-xs mb-1">
                          <span className="text-blue-400 font-medium">{matchPrediction.strength_home ?? 0}%</span>
                          <span className="text-gray-400 uppercase tracking-wider">Strength</span>
                          <span className="text-green-400 font-medium">{matchPrediction.strength_away ?? 0}%</span>
                        </div>
                        <div className="flex h-2 gap-1">
                          <div className="flex-1 bg-gray-700 rounded-l-full overflow-hidden">
                            <div className="h-full bg-blue-500 float-right" style={{ width: `${matchPrediction.strength_home ?? 0}%` }} />
                          </div>
                          <div className="flex-1 bg-gray-700 rounded-r-full overflow-hidden">
                            <div className="h-full bg-green-500" style={{ width: `${matchPrediction.strength_away ?? 0}%` }} />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Attacking Potential */}
                    {(matchPrediction.attacking_home !== null || matchPrediction.attacking_away !== null) && (
                      <div>
                        <div className="flex justify-between text-xs mb-1">
                          <span className="text-blue-400 font-medium">{matchPrediction.attacking_home ?? 0}%</span>
                          <span className="text-gray-400 uppercase tracking-wider">Attacking</span>
                          <span className="text-green-400 font-medium">{matchPrediction.attacking_away ?? 0}%</span>
                        </div>
                        <div className="flex h-2 gap-1">
                          <div className="flex-1 bg-gray-700 rounded-l-full overflow-hidden">
                            <div className="h-full bg-blue-500 float-right" style={{ width: `${matchPrediction.attacking_home ?? 0}%` }} />
                          </div>
                          <div className="flex-1 bg-gray-700 rounded-r-full overflow-hidden">
                            <div className="h-full bg-green-500" style={{ width: `${matchPrediction.attacking_away ?? 0}%` }} />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Defensive Potential */}
                    {(matchPrediction.defensive_home !== null || matchPrediction.defensive_away !== null) && (
                      <div>
                        <div className="flex justify-between text-xs mb-1">
                          <span className="text-blue-400 font-medium">{matchPrediction.defensive_home ?? 0}%</span>
                          <span className="text-gray-400 uppercase tracking-wider">Defensive</span>
                          <span className="text-green-400 font-medium">{matchPrediction.defensive_away ?? 0}%</span>
                        </div>
                        <div className="flex h-2 gap-1">
                          <div className="flex-1 bg-gray-700 rounded-l-full overflow-hidden">
                            <div className="h-full bg-blue-500 float-right" style={{ width: `${matchPrediction.defensive_home ?? 0}%` }} />
                          </div>
                          <div className="flex-1 bg-gray-700 rounded-r-full overflow-hidden">
                            <div className="h-full bg-green-500" style={{ width: `${matchPrediction.defensive_away ?? 0}%` }} />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Poisson Distribution */}
                    {(matchPrediction.poisson_home !== null || matchPrediction.poisson_away !== null) && (
                      <div>
                        <div className="flex justify-between text-xs mb-1">
                          <span className="text-blue-400 font-medium">{matchPrediction.poisson_home ?? 0}%</span>
                          <span className="text-gray-400 uppercase tracking-wider">Poisson</span>
                          <span className="text-green-400 font-medium">{matchPrediction.poisson_away ?? 0}%</span>
                        </div>
                        <div className="flex h-2 gap-1">
                          <div className="flex-1 bg-gray-700 rounded-l-full overflow-hidden">
                            <div className="h-full bg-blue-500 float-right" style={{ width: `${matchPrediction.poisson_home ?? 0}%` }} />
                          </div>
                          <div className="flex-1 bg-gray-700 rounded-r-full overflow-hidden">
                            <div className="h-full bg-green-500" style={{ width: `${matchPrediction.poisson_away ?? 0}%` }} />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* H2H Strength */}
                    {(matchPrediction.h2h_strength_home !== null || matchPrediction.h2h_strength_away !== null) && (
                      <div>
                        <div className="flex justify-between text-xs mb-1">
                          <span className="text-blue-400 font-medium">{matchPrediction.h2h_strength_home ?? 0}%</span>
                          <span className="text-gray-400 uppercase tracking-wider">H2H Strength</span>
                          <span className="text-green-400 font-medium">{matchPrediction.h2h_strength_away ?? 0}%</span>
                        </div>
                        <div className="flex h-2 gap-1">
                          <div className="flex-1 bg-gray-700 rounded-l-full overflow-hidden">
                            <div className="h-full bg-blue-500 float-right" style={{ width: `${matchPrediction.h2h_strength_home ?? 0}%` }} />
                          </div>
                          <div className="flex-1 bg-gray-700 rounded-r-full overflow-hidden">
                            <div className="h-full bg-green-500" style={{ width: `${matchPrediction.h2h_strength_away ?? 0}%` }} />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* H2H Goals */}
                    {(matchPrediction.h2h_goals_home !== null || matchPrediction.h2h_goals_away !== null) && (
                      <div>
                        <div className="flex justify-between text-xs mb-1">
                          <span className="text-blue-400 font-medium">{matchPrediction.h2h_goals_home ?? 0}%</span>
                          <span className="text-gray-400 uppercase tracking-wider">H2H Goals</span>
                          <span className="text-green-400 font-medium">{matchPrediction.h2h_goals_away ?? 0}%</span>
                        </div>
                        <div className="flex h-2 gap-1">
                          <div className="flex-1 bg-gray-700 rounded-l-full overflow-hidden">
                            <div className="h-full bg-blue-500 float-right" style={{ width: `${matchPrediction.h2h_goals_home ?? 0}%` }} />
                          </div>
                          <div className="flex-1 bg-gray-700 rounded-r-full overflow-hidden">
                            <div className="h-full bg-green-500" style={{ width: `${matchPrediction.h2h_goals_away ?? 0}%` }} />
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Team Legend */}
                  <div className="flex justify-center gap-6 mt-4 pt-4 border-t border-white/5">
                    <div className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                      <span className="text-xs text-gray-400">{match?.home_name}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-green-500"></div>
                      <span className="text-xs text-gray-400">{match?.away_name}</span>
                    </div>
                  </div>
                  </>
                )}
            </div>
          </div>
          )}

          {/* Team Lineups Section */}
          {selectedSection === 'lineups' && (
          <div className="bg-gradient-to-br from-gray-900/80 to-gray-950/80 rounded-2xl border border-white/5 p-4 sm:p-5 mb-6">
            {/* Header */}
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
              <div>
                <h2 className="text-lg font-bold text-white">{t('teamLineups')}</h2>
                <p className="text-xs text-gray-500">{t('startingXI')}</p>
              </div>
            </div>

            {/* Content */}
            <div>
              {/* No lineup data message */}
              {(!lineups || lineups.length === 0) ? (
                  <div className="flex flex-col items-center justify-center py-12 text-center">
                    <div className="w-16 h-16 rounded-full bg-gray-800/50 flex items-center justify-center mb-4">
                      <svg className="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <h3 className="text-white font-medium mb-2">{t('lineupNotAvailable')}</h3>
                    <p className="text-gray-500 text-sm max-w-md">
                      {t('lineupNotAvailableDesc')}
                    </p>
                  </div>
                ) : (
                  <>
                  {/* Football Pitch */}
                  <div className="relative w-full aspect-[2/1] bg-gradient-to-b from-green-700 to-green-800 rounded-xl overflow-hidden mb-6">
                    {/* Pitch markings */}
                    <div className="absolute inset-0">
                      {/* Center line */}
                      <div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-white/30" />
                      {/* Center circle */}
                      <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-24 h-24 border-2 border-white/30 rounded-full" />
                      {/* Center dot */}
                      <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-white/50 rounded-full" />
                      {/* Left penalty area */}
                      <div className="absolute left-0 top-1/2 -translate-y-1/2 w-[12%] h-[60%] border-2 border-l-0 border-white/30" />
                      {/* Left goal area */}
                      <div className="absolute left-0 top-1/2 -translate-y-1/2 w-[5%] h-[30%] border-2 border-l-0 border-white/30" />
                      {/* Right penalty area */}
                      <div className="absolute right-0 top-1/2 -translate-y-1/2 w-[12%] h-[60%] border-2 border-r-0 border-white/30" />
                      {/* Right goal area */}
                      <div className="absolute right-0 top-1/2 -translate-y-1/2 w-[5%] h-[30%] border-2 border-r-0 border-white/30" />
                    </div>

                    {/* Formation labels */}
                    <div className="absolute top-2 left-4 px-2 py-1 bg-black/50 rounded text-xs text-white font-medium">
                      {lineups[0]?.summary.formation || 'N/A'}
                    </div>
                    <div className="absolute top-2 right-4 px-2 py-1 bg-black/50 rounded text-xs text-white font-medium">
                      {lineups[1]?.summary.formation || 'N/A'}
                    </div>

                    {/* Home team players (left side) */}
                    {lineups[0]?.starters.map((player: FixturePlayer) => {
                      if (!player.grid) return null;
                      const [row, col] = player.grid.split(':').map(Number);
                      // Convert grid to percentage positions (home team on left)
                      const left = ((row - 1) / 4) * 45 + 5; // 5% to 50%
                      const playersInRow = lineups[0].starters.filter((p: FixturePlayer) => p.grid?.startsWith(row + ':'));
                      const verticalCount = playersInRow.length;
                      const topAdjusted = verticalCount === 1 ? 50 : ((col - 1) / Math.max(verticalCount - 1, 1)) * 70 + 15;

                      return (
                        <div
                          key={player.id}
                          className="absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center"
                          style={{ left: `${left}%`, top: `${topAdjusted}%` }}
                        >
                          <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-500 border-2 border-white flex items-center justify-center text-white text-xs sm:text-sm font-bold shadow-lg">
                            {player.number || '?'}
                          </div>
                          <span className="mt-1 px-1 bg-black/60 rounded text-[8px] sm:text-[10px] text-white whitespace-nowrap max-w-[60px] truncate">
                            {player.player_name?.split(' ').pop() || player.player_name}
                          </span>
                        </div>
                      );
                    })}

                    {/* Away team players (right side) */}
                    {lineups[1]?.starters.map((player: FixturePlayer) => {
                      if (!player.grid) return null;
                      const [row, col] = player.grid.split(':').map(Number);
                      // Convert grid to percentage positions (away team on right, mirrored)
                      const left = 95 - ((row - 1) / 4) * 45; // 95% to 50%
                      const playersInRow = lineups[1].starters.filter((p: FixturePlayer) => p.grid?.startsWith(row + ':'));
                      const verticalCount = playersInRow.length;
                      const topAdjusted = verticalCount === 1 ? 50 : ((col - 1) / Math.max(verticalCount - 1, 1)) * 70 + 15;

                      return (
                        <div
                          key={player.id}
                          className="absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center"
                          style={{ left: `${left}%`, top: `${topAdjusted}%` }}
                        >
                          <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-green-500 border-2 border-white flex items-center justify-center text-white text-xs sm:text-sm font-bold shadow-lg">
                            {player.number || '?'}
                          </div>
                          <span className="mt-1 px-1 bg-black/60 rounded text-[8px] sm:text-[10px] text-white whitespace-nowrap max-w-[60px] truncate">
                            {player.player_name?.split(' ').pop() || player.player_name}
                          </span>
                        </div>
                      );
                    })}
                  </div>

                  {/* Team Lists */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {lineups.map((lineup: TeamLineup, index: number) => (
                      <div key={lineup.summary.team_id} className={`rounded-xl overflow-hidden ${index === 0 ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-green-500/10 border border-green-500/20'}`}>
                        {/* Team Header */}
                        <div className={`px-4 py-3 flex items-center justify-between ${index === 0 ? 'bg-blue-500/20' : 'bg-green-500/20'}`}>
                          <div className="flex items-center gap-3">
                            <div className={`w-1 h-8 rounded-full ${index === 0 ? 'bg-blue-500' : 'bg-green-500'}`} />
                            <div>
                              <h3 className="font-bold text-white">{lineup.summary.team_name}</h3>
                              <span className="text-xs text-gray-400">{lineup.summary.formation || 'N/A'}</span>
                            </div>
                          </div>
                          {match && (
                            <img
                              src={index === 0 ? match.home_logo : match.away_logo}
                              alt={lineup.summary.team_name}
                              className="w-10 h-10 object-contain"
                            />
                          )}
                        </div>

                        {/* Coach */}
                        {lineup.summary.coach_name && (
                          <div className="px-4 py-2 border-b border-white/5">
                            <div className="text-xs text-gray-500 uppercase tracking-wider">Coach</div>
                            <div className="text-sm text-white">{lineup.summary.coach_name}</div>
                          </div>
                        )}

                        {/* Starting XI */}
                        <div className="px-4 py-2">
                          <div className="text-xs text-gray-500 uppercase tracking-wider mb-2">Starting XI</div>
                          <div className="space-y-1">
                            {lineup.starters.map((player: FixturePlayer) => (
                              <div key={player.id} className="flex items-center gap-2 text-sm">
                                <span className={`w-6 text-center font-mono ${index === 0 ? 'text-blue-400' : 'text-green-400'}`}>
                                  {player.number || '-'}
                                </span>
                                <span className="text-white">{player.player_name}</span>
                                <span className="text-gray-500 text-xs ml-auto">{player.pos}</span>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Substitutes */}
                        {lineup.substitutes.length > 0 && (
                          <div className="px-4 py-2 border-t border-white/5">
                            <div className="text-xs text-gray-500 uppercase tracking-wider mb-2">Substitutes</div>
                            <div className="space-y-1">
                              {lineup.substitutes.map((player: FixturePlayer) => (
                                <div key={player.id} className="flex items-center gap-2 text-sm opacity-70">
                                  <span className={`w-6 text-center font-mono ${index === 0 ? 'text-blue-400' : 'text-green-400'}`}>
                                    {player.number || '-'}
                                  </span>
                                  <span className="text-gray-300">{player.player_name}</span>
                                  <span className="text-gray-500 text-xs ml-auto">{player.pos}</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                  </>
                )}
            </div>
          </div>
          )}

          {/* Match Events Section */}
          {selectedSection === 'events' && (
          <div className="bg-gradient-to-br from-gray-900/80 to-gray-950/80 rounded-2xl border border-white/5 p-4 sm:p-5 mb-6">
            {/* Header */}
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
              </div>
              <div>
                <div className="flex items-center gap-2">
                  <h2 className="text-lg font-bold text-white">{t('matchEvents')}</h2>
                  {match.type === 'In Play' && (
                    <div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-red-500/20 border border-red-500/30">
                      <div className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse" />
                      <span className="text-xs font-medium text-red-400">LIVE</span>
                    </div>
                  )}
                </div>
                <p className="text-xs text-gray-500">{t('eventsTimeline')}</p>
              </div>
            </div>

            {/* Content */}
            <div>
                {/* No events message */}
                {(!events || events.length === 0) ? (
                  <div className="flex flex-col items-center justify-center py-12 text-center">
                    <div className="w-16 h-16 rounded-full bg-gray-800/50 flex items-center justify-center mb-4">
                      <svg className="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 10V3L4 14h7v7l9-11h-7z" />
                      </svg>
                    </div>
                    <h3 className="text-white font-medium mb-2">{t('noEvents')}</h3>
                    <p className="text-gray-500 text-sm max-w-md">
                      {t('noEventsDesc')}
                    </p>
                  </div>
                ) : (
                  <div className="relative">
                    {/* Timeline vertical line */}
                    <div className="absolute left-[23px] top-4 bottom-4 w-0.5 bg-gradient-to-b from-orange-500/50 via-amber-500/30 to-orange-500/50" />

                    <div className="space-y-0">
                      {events.map((event: FixtureEvent, index: number) => {
                        // Determine event icon and color based on event_type and event_detail
                        const getEventStyle = () => {
                          const type = event.event_type?.toLowerCase() || '';
                          const detail = event.event_detail?.toLowerCase() || '';

                          if (type === 'goal') {
                            if (detail.includes('own goal')) {
                              return { icon: '⚽', dotColor: 'bg-red-500', bgColor: 'bg-red-500/10', borderColor: 'border-red-500/20', textColor: 'text-red-400' };
                            }
                            if (detail.includes('penalty')) {
                              return { icon: '⚽', dotColor: 'bg-emerald-500', bgColor: 'bg-emerald-500/10', borderColor: 'border-emerald-500/20', textColor: 'text-emerald-400' };
                            }
                            return { icon: '⚽', dotColor: 'bg-emerald-500', bgColor: 'bg-emerald-500/10', borderColor: 'border-emerald-500/20', textColor: 'text-emerald-400' };
                          }
                          if (type === 'card') {
                            if (detail.includes('yellow')) {
                              return { icon: '🟨', dotColor: 'bg-yellow-500', bgColor: 'bg-yellow-500/10', borderColor: 'border-yellow-500/20', textColor: 'text-yellow-400' };
                            }
                            if (detail.includes('red')) {
                              return { icon: '🟥', dotColor: 'bg-red-500', bgColor: 'bg-red-500/10', borderColor: 'border-red-500/20', textColor: 'text-red-400' };
                            }
                            return { icon: '🟨', dotColor: 'bg-yellow-500', bgColor: 'bg-yellow-500/10', borderColor: 'border-yellow-500/20', textColor: 'text-yellow-400' };
                          }
                          if (type === 'subst') {
                            return { icon: '🔄', dotColor: 'bg-blue-500', bgColor: 'bg-blue-500/10', borderColor: 'border-blue-500/20', textColor: 'text-blue-400' };
                          }
                          if (type === 'var') {
                            return { icon: '📺', dotColor: 'bg-purple-500', bgColor: 'bg-purple-500/10', borderColor: 'border-purple-500/20', textColor: 'text-purple-400' };
                          }
                          return { icon: '⚡', dotColor: 'bg-gray-500', bgColor: 'bg-gray-500/10', borderColor: 'border-gray-500/20', textColor: 'text-gray-400' };
                        };

                        const style = getEventStyle();
                        const isHomeTeam = match && event.team_name === match.home_name;
                        const isFirst = index === 0;
                        const isLast = index === events.length - 1;

                        return (
                          <div
                            key={event.id}
                            className={`relative flex items-start gap-4 ${isFirst ? 'pt-0' : 'pt-3'} ${isLast ? 'pb-0' : 'pb-3'}`}
                          >
                            {/* Timeline dot */}
                            <div className="relative z-10 flex-shrink-0 w-12 flex flex-col items-center">
                              <div className={`w-3 h-3 rounded-full ${style.dotColor} ring-4 ring-gray-900/80`} />
                            </div>

                            {/* Event Card */}
                            <div className={`flex-1 flex items-center gap-3 p-3 rounded-xl ${style.bgColor} border ${style.borderColor}`}>
                              {/* Time */}
                              <div className="flex-shrink-0 w-14 text-center">
                                <span className={`text-lg font-bold ${style.textColor}`}>
                                  {event.elapsed_time || '-'}&apos;
                                </span>
                                {event.extra_time && (
                                  <span className={`text-xs ${style.textColor}`}>+{event.extra_time}</span>
                                )}
                              </div>

                              {/* Event Icon */}
                              <div className="flex-shrink-0 text-2xl">
                                {style.icon}
                              </div>

                              {/* Event Details */}
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2">
                                  <span className="font-semibold text-white truncate">{event.player_name || 'Unknown'}</span>
                                  {event.assist_name && (
                                    <span className="text-gray-400 text-sm truncate">({event.assist_name})</span>
                                  )}
                                </div>
                                <div className="flex items-center gap-2 text-sm">
                                  <span className={`${isHomeTeam ? 'text-blue-400' : 'text-green-400'}`}>
                                    {event.team_name || 'Unknown Team'}
                                  </span>
                                  {event.event_detail && (
                                    <>
                                      <span className="text-gray-600">•</span>
                                      <span className="text-gray-400">{event.event_detail}</span>
                                    </>
                                  )}
                                </div>
                                {event.comments && (
                                  <p className="text-xs text-gray-500 mt-1 truncate">{event.comments}</p>
                                )}
                              </div>

                              {/* Team indicator */}
                              <div className={`flex-shrink-0 w-1 h-12 rounded-full ${isHomeTeam ? 'bg-blue-500' : 'bg-green-500'}`} />
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
            </div>
          </div>
          )}

          {/* Live Statistics Section */}
          {selectedSection === 'stats' && (
          <div className="bg-gradient-to-br from-gray-900/80 to-gray-950/80 rounded-2xl border border-white/5 p-4 sm:p-5 mb-6">
            {/* Header */}
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <div>
                <div className="flex items-center gap-2">
                  <h2 className="text-lg font-bold text-white">{t('liveStatistics')}</h2>
                  {match.type === 'In Play' && (
                    <div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-red-500/20 border border-red-500/30">
                      <div className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse" />
                      <span className="text-xs font-medium text-red-400">LIVE</span>
                    </div>
                  )}
                </div>
                <p className="text-xs text-gray-500">{t('statsDescription')}</p>
              </div>
            </div>

            {/* Content */}
            <div>
              {(!matchStats || matchStats.length < 2) ? (
                <div className="flex flex-col items-center justify-center py-12 text-center">
                  <div className="w-16 h-16 rounded-full bg-gray-800/50 flex items-center justify-center mb-4">
                    <svg className="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                  </div>
                  <h3 className="text-white font-medium mb-2">{t('noStats')}</h3>
                  <p className="text-gray-500 text-sm max-w-md">
                    {t('noStatsDesc')}
                  </p>
                </div>
              ) : (() => {
                // Find home and away team stats
                const homeStats = matchStats.find(s => s.team_name === match.home_name) || matchStats[0];
                const awayStats = matchStats.find(s => s.team_name === match.away_name) || matchStats[1];

                // Helper to render a stat bar
                const StatBar = ({ label, homeValue, awayValue, isPercentage = false }: { label: string; homeValue: number | string; awayValue: number | string; isPercentage?: boolean }) => {
                  const homeNum = typeof homeValue === 'string' ? parseFloat(homeValue) || 0 : homeValue;
                  const awayNum = typeof awayValue === 'string' ? parseFloat(awayValue) || 0 : awayValue;
                  const total = homeNum + awayNum;
                  const homePercent = total > 0 ? (homeNum / total) * 100 : 50;
                  const awayPercent = total > 0 ? (awayNum / total) * 100 : 50;

                  return (
                    <div className="mb-4">
                      <div className="flex justify-between items-center mb-1.5">
                        <span className="text-sm font-bold text-blue-400">{isPercentage ? homeValue : homeNum}</span>
                        <span className="text-xs text-gray-400 font-medium">{label}</span>
                        <span className="text-sm font-bold text-green-400">{isPercentage ? awayValue : awayNum}</span>
                      </div>
                      <div className="flex h-2 rounded-full overflow-hidden bg-gray-800/50">
                        <div
                          className="bg-blue-500 transition-all duration-500"
                          style={{ width: `${homePercent}%` }}
                        />
                        <div
                          className="bg-green-500 transition-all duration-500"
                          style={{ width: `${awayPercent}%` }}
                        />
                      </div>
                    </div>
                  );
                };

                return (
                  <div>
                    {/* Team Headers */}
                    <div className="flex justify-between items-center mb-6 pb-4 border-b border-white/5">
                      <div className="flex items-center gap-3">
                        {match.home_logo && (
                          <div className="w-10 h-10 rounded-full bg-white/10 p-1.5 flex items-center justify-center">
                            <img src={match.home_logo} alt={match.home_name} className="w-full h-full object-contain" />
                          </div>
                        )}
                        <span className="text-sm font-bold text-blue-400">{match.home_name}</span>
                      </div>
                      <div className="flex items-center gap-3">
                        <span className="text-sm font-bold text-green-400">{match.away_name}</span>
                        {match.away_logo && (
                          <div className="w-10 h-10 rounded-full bg-white/10 p-1.5 flex items-center justify-center">
                            <img src={match.away_logo} alt={match.away_name} className="w-full h-full object-contain" />
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Statistics Bars */}
                    <div className="space-y-1">
                      <StatBar label={t('possession')} homeValue={homeStats.ball_possession || '0%'} awayValue={awayStats.ball_possession || '0%'} isPercentage />
                      <StatBar label={t('totalShots')} homeValue={homeStats.total_shots} awayValue={awayStats.total_shots} />
                      <StatBar label={t('shotsOnGoal')} homeValue={homeStats.shots_on_goal} awayValue={awayStats.shots_on_goal} />
                      <StatBar label={t('shotsOffGoal')} homeValue={homeStats.shots_off_goal} awayValue={awayStats.shots_off_goal} />
                      <StatBar label={t('corners')} homeValue={homeStats.corner_kicks} awayValue={awayStats.corner_kicks} />
                      <StatBar label={t('fouls')} homeValue={homeStats.fouls} awayValue={awayStats.fouls} />
                      <StatBar label={t('offsides')} homeValue={homeStats.offsides} awayValue={awayStats.offsides} />
                      <StatBar label={t('yellowCards')} homeValue={homeStats.yellow_cards} awayValue={awayStats.yellow_cards} />
                      <StatBar label={t('redCards')} homeValue={homeStats.red_cards} awayValue={awayStats.red_cards} />
                      <StatBar label={t('saves')} homeValue={homeStats.goalkeeper_saves} awayValue={awayStats.goalkeeper_saves} />
                      <StatBar label={t('passes')} homeValue={homeStats.total_passes} awayValue={awayStats.total_passes} />
                      <StatBar label={t('passAccuracy')} homeValue={homeStats.passes_pct || '0%'} awayValue={awayStats.passes_pct || '0%'} isPercentage />
                      {(homeStats.expected_goals !== null || awayStats.expected_goals !== null) && (
                        <StatBar label={t('expectedGoals')} homeValue={homeStats.expected_goals?.toFixed(2) || '0.00'} awayValue={awayStats.expected_goals?.toFixed(2) || '0.00'} />
                      )}
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
          )}

          {/* Odds Section */}
          {selectedSection === 'odds' && (
          <>
          <div className="bg-gradient-to-br from-gray-900/80 to-gray-950/80 rounded-2xl border border-white/5 p-6 mb-6">
            <div className="flex items-center gap-2 mb-6">
              {match.type === 'In Play' && (
                <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
              )}
              {match.type === 'Scheduled' && (
                <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              )}
              {match.type === 'Finished' && (
                <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              )}
              <h2 className="text-xl font-bold text-white">{getOddsTitle()}</h2>
              {(match.type === 'In Play' || match.type === 'Scheduled') && (
                <div className="ml-2 flex items-center gap-2">
                  <div className={`relative flex items-center gap-2 px-3 py-1.5 rounded-full ${
                    match.type === 'In Play'
                      ? 'bg-red-500/10 border border-red-500/30'
                      : 'bg-emerald-500/10 border border-emerald-500/30'
                  }`}>
                    {/* Progress bar background */}
                    <div className="absolute inset-0 rounded-full overflow-hidden">
                      <div
                        className={`h-full transition-all duration-1000 ease-linear ${
                          match.type === 'In Play'
                            ? 'bg-gradient-to-r from-red-500/30 to-red-400/20'
                            : 'bg-gradient-to-r from-emerald-500/30 to-emerald-400/20'
                        }`}
                        style={{ width: `${(refreshCountdown / 10) * 100}%` }}
                      />
                    </div>
                    {/* Content */}
                    <div className="relative flex items-center gap-2">
                      <svg className={`w-3.5 h-3.5 animate-spin ${match.type === 'In Play' ? 'text-red-400' : 'text-emerald-400'}`} style={{ animationDuration: '2s' }} fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <span className={`text-xs font-medium ${match.type === 'In Play' ? 'text-red-400' : 'text-emerald-400'}`}>
                        {t('refreshIn')} <span className={`font-bold ${match.type === 'In Play' ? 'text-red-300' : 'text-emerald-300'}`}>{refreshCountdown}s</span>
                      </span>
                    </div>
                  </div>
                </div>
              )}
              {(match.type === 'Finished' || match.type === 'In Play' || match.type === 'Scheduled') && (
                <button
                  onClick={() => setShowHistoryModal(true)}
                  className="ml-auto px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 text-black text-sm font-semibold hover:shadow-lg hover:shadow-emerald-500/25 transition-all cursor-pointer"
                >
                  {t('viewOddsHistory')}
                </button>
              )}
            </div>

            {currentOdds ? (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {/* 1X2 Odds */}
                <div className="bg-white/5 rounded-xl p-4">
                  <h3 className="text-gray-400 text-sm font-medium mb-3">1X2</h3>
                  <div className="grid grid-cols-3 gap-2">
                    <div className={`bg-white/5 rounded-lg p-3 text-center hover:bg-emerald-500/20 transition-all cursor-pointer ${getFlashClass(oddsFlash.moneyline_1x2_home)}`}>
                      <div className="text-xs text-gray-500 mb-1">Home</div>
                      <div className="text-lg font-bold text-white">{currentOdds.moneyline_1x2_home?.toFixed(2) ?? '-'}</div>
                    </div>
                    <div className={`bg-white/5 rounded-lg p-3 text-center hover:bg-emerald-500/20 transition-all cursor-pointer ${getFlashClass(oddsFlash.moneyline_1x2_draw)}`}>
                      <div className="text-xs text-gray-500 mb-1">Draw</div>
                      <div className="text-lg font-bold text-white">{currentOdds.moneyline_1x2_draw?.toFixed(2) ?? '-'}</div>
                    </div>
                    <div className={`bg-white/5 rounded-lg p-3 text-center hover:bg-emerald-500/20 transition-all cursor-pointer ${getFlashClass(oddsFlash.moneyline_1x2_away)}`}>
                      <div className="text-xs text-gray-500 mb-1">Away</div>
                      <div className="text-lg font-bold text-white">{currentOdds.moneyline_1x2_away?.toFixed(2) ?? '-'}</div>
                    </div>
                  </div>
                </div>

                {/* Over/Under Odds */}
                <div className="bg-white/5 rounded-xl p-4">
                  <h3 className="text-gray-400 text-sm font-medium mb-3">Over/Under {currentOdds.totalpoints_main_line ?? '-'}</h3>
                  <div className="grid grid-cols-2 gap-2">
                    <div className={`bg-white/5 rounded-lg p-3 text-center hover:bg-emerald-500/20 transition-all cursor-pointer ${getFlashClass(oddsFlash.totalpoints_over)}`}>
                      <div className="text-xs text-gray-500 mb-1">Over</div>
                      <div className="text-lg font-bold text-white">{currentOdds.totalpoints_over?.toFixed(2) ?? '-'}</div>
                    </div>
                    <div className={`bg-white/5 rounded-lg p-3 text-center hover:bg-emerald-500/20 transition-all cursor-pointer ${getFlashClass(oddsFlash.totalpoints_under)}`}>
                      <div className="text-xs text-gray-500 mb-1">Under</div>
                      <div className="text-lg font-bold text-white">{currentOdds.totalpoints_under?.toFixed(2) ?? '-'}</div>
                    </div>
                  </div>
                </div>

                {/* Handicap Odds */}
                <div className="bg-white/5 rounded-xl p-4">
                  <h3 className="text-gray-400 text-sm font-medium mb-3">Asian Handicap {currentOdds.handicap_main_line !== null && currentOdds.handicap_main_line !== undefined ? (currentOdds.handicap_main_line > 0 ? '+' : '') + currentOdds.handicap_main_line : '-'}</h3>
                  <div className="grid grid-cols-2 gap-2">
                    <div className={`bg-white/5 rounded-lg p-3 text-center hover:bg-emerald-500/20 transition-all cursor-pointer ${getFlashClass(oddsFlash.handicap_home)}`}>
                      <div className="text-xs text-gray-500 mb-1">Home</div>
                      <div className="text-lg font-bold text-white">{currentOdds.handicap_home?.toFixed(2) ?? '-'}</div>
                    </div>
                    <div className={`bg-white/5 rounded-lg p-3 text-center hover:bg-emerald-500/20 transition-all cursor-pointer ${getFlashClass(oddsFlash.handicap_away)}`}>
                      <div className="text-xs text-gray-500 mb-1">Away</div>
                      <div className="text-lg font-bold text-white">{currentOdds.handicap_away?.toFixed(2) ?? '-'}</div>
                    </div>
                  </div>
                </div>
              </div>
            ) : (
              <div className="text-center py-8">
                <div className="text-gray-500">{t('noOddsData')}</div>
              </div>
            )}
          </div>

          {/* Odds History Modal */}
          {showHistoryModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
              {/* Backdrop */}
              <div
                className="absolute inset-0 bg-black/80 backdrop-blur-sm"
                onClick={() => setShowHistoryModal(false)}
              />
              {/* Modal */}
              <div className="relative bg-gradient-to-br from-gray-900 to-gray-950 rounded-2xl border border-white/10 p-6 max-w-5xl w-full max-h-[80vh] flex flex-col overflow-hidden">
                {/* Background glow orbs */}
                <div className="absolute top-0 left-1/4 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl pointer-events-none" />
                <div className="absolute top-0 left-1/2 w-64 h-64 bg-cyan-500/10 rounded-full blur-3xl pointer-events-none" />
                <div className="absolute top-0 right-1/4 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl pointer-events-none" />

                <div className="flex items-center justify-between mb-4 relative z-10">
                  <h3 className="text-xl font-bold text-white" style={{textShadow: '0 0 20px rgba(255, 255, 255, 0.3)'}}>{t('oddsHistory')}</h3>
                  <button
                    onClick={() => setShowHistoryModal(false)}
                    className="p-2 rounded-lg hover:bg-white/10 transition-colors cursor-pointer"
                  >
                    <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>

                {oddsHistory.length > 0 ? (
                  <div className="overflow-auto flex-1 relative z-10">
                    {/* Desktop Table */}
                    <table className="w-full text-sm border-collapse hidden md:table">
                      <thead className="sticky top-0 z-10">
                        {/* Section Headers */}
                        <tr className="bg-[#0d1117]">
                          <th className="py-3 px-3 bg-[#0d1117]"></th>
                          <th colSpan={3} className="py-3 px-2 text-center bg-[#0d1117]">
                            <div className="relative inline-block px-4 py-1 rounded-full" style={{background: 'linear-gradient(180deg, rgba(16, 185, 129, 0.15) 0%, transparent 100%)', boxShadow: '0 0 20px rgba(16, 185, 129, 0.3), inset 0 1px 0 rgba(16, 185, 129, 0.3)'}}>
                              <span className="text-emerald-400 font-bold text-sm tracking-wider" style={{textShadow: '0 0 10px rgba(16, 185, 129, 0.8), 0 0 30px rgba(16, 185, 129, 0.6), 0 0 50px rgba(16, 185, 129, 0.4)'}}>1X2</span>
                            </div>
                          </th>
                          <th colSpan={3} className="py-3 px-2 text-center bg-[#0d1117]">
                            <div className="relative inline-block px-4 py-1 rounded-full" style={{background: 'linear-gradient(180deg, rgba(34, 211, 238, 0.15) 0%, transparent 100%)', boxShadow: '0 0 20px rgba(34, 211, 238, 0.3), inset 0 1px 0 rgba(34, 211, 238, 0.3)'}}>
                              <span className="text-cyan-400 font-bold text-sm tracking-wider" style={{textShadow: '0 0 10px rgba(34, 211, 238, 0.8), 0 0 30px rgba(34, 211, 238, 0.6), 0 0 50px rgba(34, 211, 238, 0.4)'}}>OVER/UNDER</span>
                            </div>
                          </th>
                          <th colSpan={3} className="py-3 px-2 text-center bg-[#0d1117]">
                            <div className="relative inline-block px-4 py-1 rounded-full" style={{background: 'linear-gradient(180deg, rgba(192, 132, 252, 0.15) 0%, transparent 100%)', boxShadow: '0 0 20px rgba(192, 132, 252, 0.3), inset 0 1px 0 rgba(192, 132, 252, 0.3)'}}>
                              <span className="text-purple-400 font-bold text-sm tracking-wider" style={{textShadow: '0 0 10px rgba(192, 132, 252, 0.8), 0 0 30px rgba(192, 132, 252, 0.6), 0 0 50px rgba(192, 132, 252, 0.4)'}}>HANDICAP</span>
                            </div>
                          </th>
                        </tr>
                        {/* Column Headers */}
                        <tr className="bg-[#0d1117]" style={{boxShadow: '0 2px 10px rgba(0, 0, 0, 0.5)'}}>
                          <th className="text-left py-3 px-3 text-gray-400 font-medium bg-[#0d1117]">Time</th>
                          <th className="text-center py-3 px-2 text-gray-400 font-medium bg-[#0d1117]" style={{boxShadow: 'inset 2px 0 0 rgba(16, 185, 129, 0.5)'}}>Home</th>
                          <th className="text-center py-3 px-2 text-gray-400 font-medium bg-[#0d1117]">Draw</th>
                          <th className="text-center py-3 px-2 text-gray-400 font-medium bg-[#0d1117]" style={{boxShadow: 'inset -2px 0 0 rgba(16, 185, 129, 0.5)'}}>Away</th>
                          <th className="text-center py-3 px-2 text-gray-400 font-medium bg-[#0d1117]" style={{boxShadow: 'inset 2px 0 0 rgba(34, 211, 238, 0.5)'}}>Line</th>
                          <th className="text-center py-3 px-2 text-gray-400 font-medium bg-[#0d1117]">Over</th>
                          <th className="text-center py-3 px-2 text-gray-400 font-medium bg-[#0d1117]" style={{boxShadow: 'inset -2px 0 0 rgba(34, 211, 238, 0.5)'}}>Under</th>
                          <th className="text-center py-3 px-2 text-gray-400 font-medium bg-[#0d1117]" style={{boxShadow: 'inset 2px 0 0 rgba(192, 132, 252, 0.5)'}}>Line</th>
                          <th className="text-center py-3 px-2 text-gray-400 font-medium bg-[#0d1117]">Home</th>
                          <th className="text-center py-3 px-2 text-gray-400 font-medium bg-[#0d1117]">Away</th>
                        </tr>
                      </thead>
                      <tbody>
                        {oddsHistory.map((record, index) => (
                          <tr key={record.id} className={`border-b border-white/5 ${index === 0 ? 'bg-emerald-500/10' : 'hover:bg-white/5'} transition-colors`}>
                            <td className="py-3 px-3 text-gray-300 whitespace-nowrap">
                              {formatHistoryTime(record.created_at)}
                              {index === 0 && <span className="ml-2 text-xs text-emerald-400 font-medium" style={{textShadow: '0 0 8px rgba(16, 185, 129, 0.6)'}}>(Latest)</span>}
                            </td>
                            {/* 1X2 Section */}
                            <td className="text-center py-3 px-2 text-white font-medium" style={{boxShadow: 'inset 2px 0 0 rgba(16, 185, 129, 0.4)'}}>{record.moneyline_1x2_home?.toFixed(2) ?? '-'}</td>
                            <td className="text-center py-3 px-2 text-white font-medium">{record.moneyline_1x2_draw?.toFixed(2) ?? '-'}</td>
                            <td className="text-center py-3 px-2 text-white font-medium" style={{boxShadow: 'inset -2px 0 0 rgba(16, 185, 129, 0.4)'}}>{record.moneyline_1x2_away?.toFixed(2) ?? '-'}</td>
                            {/* O/U Section */}
                            <td className="text-center py-3 px-2 font-medium" style={{boxShadow: 'inset 2px 0 0 rgba(34, 211, 238, 0.4)'}}>
                              <span className="text-cyan-400" style={{textShadow: '0 0 8px rgba(34, 211, 238, 0.5)'}}>{record.totalpoints_main_line ?? '-'}</span>
                            </td>
                            <td className="text-center py-3 px-2 text-white font-medium">{record.totalpoints_over?.toFixed(2) ?? '-'}</td>
                            <td className="text-center py-3 px-2 text-white font-medium" style={{boxShadow: 'inset -2px 0 0 rgba(34, 211, 238, 0.4)'}}>{record.totalpoints_under?.toFixed(2) ?? '-'}</td>
                            {/* Handicap Section */}
                            <td className="text-center py-3 px-2 font-medium" style={{boxShadow: 'inset 2px 0 0 rgba(192, 132, 252, 0.4)'}}>
                              <span className="text-purple-400" style={{textShadow: '0 0 8px rgba(192, 132, 252, 0.5)'}}>{record.handicap_main_line ?? '-'}</span>
                            </td>
                            <td className="text-center py-3 px-2 text-white font-medium">{record.handicap_home?.toFixed(2) ?? '-'}</td>
                            <td className="text-center py-3 px-2 text-white font-medium">{record.handicap_away?.toFixed(2) ?? '-'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>

                    {/* Mobile Card Layout */}
                    <div className="md:hidden space-y-3 p-2">
                      {oddsHistory.map((record, index) => (
                        <div
                          key={record.id}
                          className={`bg-white/5 rounded-lg p-3 border ${
                            index === 0 ? 'border-emerald-500/30 bg-emerald-500/5' : 'border-white/5'
                          }`}
                        >
                          {/* Time Header */}
                          <div className="flex items-center justify-between mb-3 pb-2 border-b border-white/5">
                            <span className="text-sm text-gray-300">
                              {formatHistoryTime(record.created_at)}
                            </span>
                            {index === 0 && (
                              <span className="px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400 text-xs font-medium">
                                Latest
                              </span>
                            )}
                          </div>

                          {/* Odds Grid */}
                          <div className="space-y-2">
                            {/* 1X2 */}
                            <div className="flex items-center gap-2">
                              <span className="px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-400 text-[10px] font-semibold w-12 text-center">
                                1X2
                              </span>
                              <div className="flex-1 grid grid-cols-3 gap-1 text-xs">
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Home</span>
                                  <span className="text-white font-medium">{record.moneyline_1x2_home?.toFixed(2) ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Draw</span>
                                  <span className="text-white font-medium">{record.moneyline_1x2_draw?.toFixed(2) ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Away</span>
                                  <span className="text-white font-medium">{record.moneyline_1x2_away?.toFixed(2) ?? '-'}</span>
                                </div>
                              </div>
                            </div>

                            {/* Over/Under */}
                            <div className="flex items-center gap-2">
                              <span className="px-2 py-0.5 rounded bg-cyan-500/20 text-cyan-400 text-[10px] font-semibold w-12 text-center">
                                O/U
                              </span>
                              <div className="flex-1 grid grid-cols-3 gap-1 text-xs">
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Line</span>
                                  <span className="text-cyan-400 font-medium">{record.totalpoints_main_line ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Over</span>
                                  <span className="text-white font-medium">{record.totalpoints_over?.toFixed(2) ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Under</span>
                                  <span className="text-white font-medium">{record.totalpoints_under?.toFixed(2) ?? '-'}</span>
                                </div>
                              </div>
                            </div>

                            {/* Handicap */}
                            <div className="flex items-center gap-2">
                              <span className="px-2 py-0.5 rounded bg-purple-500/20 text-purple-400 text-[10px] font-semibold w-12 text-center">
                                HDP
                              </span>
                              <div className="flex-1 grid grid-cols-3 gap-1 text-xs">
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Line</span>
                                  <span className="text-purple-400 font-medium">{record.handicap_main_line ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Home</span>
                                  <span className="text-white font-medium">{record.handicap_home?.toFixed(2) ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Away</span>
                                  <span className="text-white font-medium">{record.handicap_away?.toFixed(2) ?? '-'}</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    {t('noHistory')}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Signal History Modal */}
          {showSignalHistory && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
              {/* Backdrop */}
              <div
                className="absolute inset-0 bg-black/80 backdrop-blur-sm"
                onClick={() => setShowSignalHistory(false)}
              />
              {/* Modal */}
              <div className="relative bg-gradient-to-br from-gray-900 to-gray-950 rounded-2xl border border-white/10 p-6 max-w-6xl w-full max-h-[85vh] flex flex-col overflow-hidden">
                {/* Background glow */}
                <div className="absolute top-0 left-1/4 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl pointer-events-none" />
                <div className="absolute top-0 right-1/4 w-64 h-64 bg-cyan-500/10 rounded-full blur-3xl pointer-events-none" />

                <div className="flex items-center justify-between mb-4 relative z-10">
                  <h3 className="text-xl font-bold text-white">Signal History</h3>
                  <button
                    onClick={() => setShowSignalHistory(false)}
                    className="p-2 rounded-lg hover:bg-white/10 transition-colors cursor-pointer"
                  >
                    <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>

                {/* Filters Section */}
                <div className="relative z-10 space-y-3 mb-4">
                  {/* Market Type Filter */}
                  <div>
                    <label className="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Market Type</label>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setModalMarketFilter('moneyline')}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                          modalMarketFilter === 'moneyline'
                            ? 'bg-gradient-to-r from-emerald-500 to-cyan-500 text-black'
                            : 'bg-white/5 text-gray-400 hover:bg-white/10'
                        }`}
                      >
                        1X2
                      </button>
                      <button
                        onClick={() => setModalMarketFilter('overunder')}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                          modalMarketFilter === 'overunder'
                            ? 'bg-gradient-to-r from-emerald-500 to-cyan-500 text-black'
                            : 'bg-white/5 text-gray-400 hover:bg-white/10'
                        }`}
                      >
                        O/U
                      </button>
                      <button
                        onClick={() => setModalMarketFilter('handicap')}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                          modalMarketFilter === 'handicap'
                            ? 'bg-gradient-to-r from-emerald-500 to-cyan-500 text-black'
                            : 'bg-white/5 text-gray-400 hover:bg-white/10'
                        }`}
                      >
                        HDP
                      </button>
                    </div>
                  </div>

                  {/* Bet Style Filter */}
                  <div>
                    <label className="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Bet Style</label>
                    <div className="flex gap-2 overflow-x-auto pb-1">
                      {PERSONALITIES.filter(p => isStyleAvailable(p.id)).map((p) => (
                        <button
                          key={p.id}
                          onClick={() => setModalBetStyleFilter(p.id)}
                          className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all flex items-center gap-2 ${
                            modalBetStyleFilter === p.id
                              ? `bg-gradient-to-r ${p.color} text-white border border-white/20`
                              : 'bg-white/5 text-gray-400 hover:bg-white/10 border border-white/10'
                          }`}
                        >
                          {p.image && (
                            <div className={`w-6 h-6 rounded flex items-center justify-center bg-gradient-to-br ${p.logoColor}`}>
                              <img src={p.image} alt={p.name} className="w-4 h-4 object-contain" />
                            </div>
                          )}
                          <span>{p.name}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="overflow-auto flex-1 relative z-10">
                  {modalBetStyleFilter === 'value' ? (
                    liveSignalsHistory.length > 0 ? (
                      <>
                      {/* Desktop Table */}
                      <table className="w-full text-sm border-collapse hidden md:table">
                        <thead className="sticky top-0 bg-[#0d1117]">
                          <tr>
                            <th className="text-left py-3 px-2 text-gray-400 font-medium">Clock</th>
                            <th className="text-left py-3 px-2 text-gray-400 font-medium">Score</th>
                            <th className="text-center py-3 px-2 text-gray-400 font-medium">Selection</th>
                            {(modalMarketFilter === 'overunder' || modalMarketFilter === 'handicap') && (
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Line</th>
                            )}
                            <th className="text-center py-3 px-2 text-gray-400 font-medium">Fair Odds</th>
                            <th className="text-center py-3 px-2 text-gray-400 font-medium">Market Odds</th>
                            <th className="text-center py-3 px-2 text-gray-400 font-medium">EV</th>
                            <th className="text-center py-3 px-2 text-gray-400 font-medium">Stake</th>
                            {modalMarketFilter === 'handicap' && (
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Unrealized P/L</th>
                            )}
                            <th className="text-center py-3 px-2 text-gray-400 font-medium">Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          {liveSignalsHistory.map((record, index) => {
                            // Get data based on modal market filter
                            // Note: Database stores selection as "HOME"/"DRAW"/"AWAY" text, and odds as single numeric values
                            const rawRecord = record as unknown as Record<string, unknown>;
                            const getSelectionLabel = () => {
                              if (modalMarketFilter === 'moneyline') {
                                const sel = String(rawRecord.selection_1x2 || '').toUpperCase();
                                return sel === 'HOME' || sel === '1' ? 'Home' : sel === 'DRAW' || sel === 'X' ? 'Draw' : 'Away';
                              } else if (modalMarketFilter === 'overunder') {
                                const sel = String(rawRecord.selection_ou || '').toLowerCase();
                                return sel === 'over' ? 'Over' : 'Under';
                              } else {
                                const sel = String(rawRecord.selection_hdp || '').toLowerCase();
                                return sel === 'home' ? 'Home' : 'Away';
                              }
                            };
                            const getFairOdds = () => {
                              if (modalMarketFilter === 'moneyline') {
                                const val = rawRecord.fair_odds_1x2;
                                return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                              } else if (modalMarketFilter === 'overunder') {
                                const val = rawRecord.fair_odds_ou;
                                return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                              } else {
                                const val = rawRecord.fair_odds_hdp;
                                return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                              }
                            };
                            const getMarketOdds = () => {
                              if (modalMarketFilter === 'moneyline') {
                                const val = rawRecord.market_odds_1x2;
                                return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                              } else if (modalMarketFilter === 'overunder') {
                                const val = rawRecord.market_odds_ou;
                                return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                              } else {
                                const val = rawRecord.market_odds_hdp;
                                return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                              }
                            };
                            const getEV = () => {
                              // EV is stored as text like "24.73%" in database
                              const parseEV = (val: unknown) => {
                                if (val === null || val === undefined) return '-';
                                const str = String(val).replace('%', '');
                                const num = parseFloat(str);
                                return !isNaN(num) ? `+${num.toFixed(2)}%` : '-';
                              };
                              if (modalMarketFilter === 'moneyline') {
                                return parseEV(rawRecord.expected_value_1x2);
                              } else if (modalMarketFilter === 'overunder') {
                                return parseEV(rawRecord.expected_value_ou);
                              } else {
                                return parseEV(rawRecord.expected_value_hdp);
                              }
                            };
                            const getStake = () => {
                              const parseStake = (val: unknown) => {
                                if (val === null || val === undefined) return '-';
                                // Handle both numeric and string formats (e.g., "2.21%" or 2.21)
                                const str = String(val).replace('%', '');
                                const num = parseFloat(str);
                                return !isNaN(num) ? `${num.toFixed(2)} units` : '-';
                              };
                              if (modalMarketFilter === 'moneyline') {
                                return parseStake(rawRecord.recommended_stake_1x2);
                              } else if (modalMarketFilter === 'overunder') {
                                return parseStake(rawRecord.recommended_stake_ou);
                              } else {
                                return parseStake(rawRecord.recommended_stake_hdp);
                              }
                            };
                            const isValuable = modalMarketFilter === 'moneyline' ? rawRecord.is_valuable_1x2 : modalMarketFilter === 'overunder' ? rawRecord.is_valuable_ou : rawRecord.is_valuable_hdp;

                            // Calculate unrealized P/L for HDP
                            const getUnrealizedPnL = () => {
                              if (selectedMarket !== 'handicap') return null;

                              // Parse score (e.g., "0-2" -> home: 0, away: 2)
                              const scoreStr = record.score || '';
                              const scoreParts = scoreStr.split('-').map((s: string) => parseInt(s.trim(), 10));
                              if (scoreParts.length !== 2 || isNaN(scoreParts[0]) || isNaN(scoreParts[1])) {
                                return null;
                              }
                              const [homeGoals, awayGoals] = scoreParts;

                              // Get selection - use same logic as getSelectionLabel (defaults to AWAY if not home)
                              const selStr = String(rawRecord.selection_hdp || '').toLowerCase().trim();
                              const selection: 'HOME' | 'AWAY' = selStr === 'home' ? 'HOME' : 'AWAY';

                              // Get line - the displayed line is the absolute value for the selected team
                              // For AWAY selection, the line shown is the away team's handicap (positive = advantage)
                              const lineVal = rawRecord.handicap_main_line ?? rawRecord.handicap_mainline ?? rawRecord.line_hdp ?? rawRecord.line ?? null;
                              if (lineVal === null || lineVal === undefined) return null;
                              const lineNum = parseFloat(String(lineVal));
                              if (isNaN(lineNum)) return null;
                              // The line displayed is always positive for the selected team
                              // If selection is AWAY and line shows "2", it means Away +2
                              const line = lineNum;

                              // Get market odds - handle both number and string formats
                              const oddsVal = rawRecord.market_odds_hdp;
                              if (oddsVal === null || oddsVal === undefined) return null;
                              const odds = typeof oddsVal === 'number' ? oddsVal : parseFloat(String(oddsVal));
                              if (isNaN(odds) || odds <= 0) return null;

                              // Get stake - handle various formats (number, "2.21", "2.21%", "2.21 units")
                              const stakeVal = rawRecord.recommended_stake_hdp;
                              if (stakeVal === null || stakeVal === undefined) return null;
                              const stakeNum = typeof stakeVal === 'number'
                                ? stakeVal
                                : parseFloat(String(stakeVal).replace('%', '').replace('units', '').trim());
                              if (isNaN(stakeNum) || stakeNum <= 0) return null;

                              return calculateUnrealizedHdpPnL(homeGoals, awayGoals, selection, line, odds, stakeNum);
                            };

                            const getLine = () => {
                              if (modalMarketFilter === 'overunder') {
                                // Try multiple possible field names for O/U line
                                const val = rawRecord.total_points_mainline ?? rawRecord.totalpoints_main_line ?? rawRecord.line_ou ?? rawRecord.line ?? null;
                                return val !== null && val !== undefined ? String(val) : '-';
                              } else if (modalMarketFilter === 'handicap') {
                                // Try multiple possible field names for HDP line
                                const val = rawRecord.handicap_main_line ?? rawRecord.handicap_mainline ?? rawRecord.line_hdp ?? rawRecord.line ?? null;
                                return val !== null && val !== undefined ? String(val) : '-';
                              }
                              return '-';
                            };

                            return (
                              <tr key={record.id || index} className={`border-b border-white/5 ${index === 0 ? 'bg-purple-500/10' : 'hover:bg-white/5'} transition-colors`}>
                                <td className="py-3 px-2 text-gray-300">{record.clock !== null ? `${record.clock}'` : '-'}</td>
                                <td className="py-3 px-2 text-white font-bold">{record.score || '-'}</td>
                                <td className="py-3 px-2 text-center">
                                  <span className={`px-2 py-1 rounded text-xs font-bold ${
                                    modalMarketFilter === 'moneyline' ? 'bg-emerald-500/20 text-emerald-400' :
                                    modalMarketFilter === 'overunder' ? 'bg-cyan-500/20 text-cyan-400' :
                                    'bg-pink-500/20 text-pink-400'
                                  }`}>{getSelectionLabel()}</span>
                                </td>
                                {(modalMarketFilter === 'overunder' || modalMarketFilter === 'handicap') && (
                                  <td className="py-3 px-2 text-center text-amber-400 font-medium">{getLine()}</td>
                                )}
                                <td className="py-3 px-2 text-center text-gray-400">{getFairOdds()}</td>
                                <td className="py-3 px-2 text-center text-white font-medium">{getMarketOdds()}</td>
                                <td className="py-3 px-2 text-center text-emerald-400 font-medium">{getEV()}</td>
                                <td className="py-3 px-2 text-center text-yellow-400">{getStake()}</td>
                                {modalMarketFilter === 'handicap' && (() => {
                                  const unrealizedPnL = getUnrealizedPnL();
                                  return (
                                    <td className={`py-3 px-2 text-center font-medium ${unrealizedPnL ? getUnrealizedStatusColor(unrealizedPnL.status) : 'text-gray-500'}`}>
                                      {unrealizedPnL ? formatUnrealizedProfit(unrealizedPnL.profit) : '-'}
                                    </td>
                                  );
                                })()}
                                <td className="py-3 px-2 text-center">
                                  {isValuable ? (
                                    <span className="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs font-bold">VALUE</span>
                                  ) : (
                                    <span className="px-2 py-1 rounded bg-gray-500/20 text-gray-400 text-xs">NORMAL</span>
                                  )}
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>

                      {/* Mobile Card Layout for Value/Conservative */}
                      <div className="md:hidden space-y-3 p-2">
                        {liveSignalsHistory.map((record, index) => {
                          const rawRecord = record as unknown as Record<string, unknown>;
                          const getSelectionLabel = () => {
                            if (modalMarketFilter === 'moneyline') {
                              const sel = String(rawRecord.selection_1x2 || '').toUpperCase();
                              return sel === 'HOME' || sel === '1' ? 'Home' : sel === 'DRAW' || sel === 'X' ? 'Draw' : 'Away';
                            } else if (modalMarketFilter === 'overunder') {
                              const sel = String(rawRecord.selection_ou || '').toLowerCase();
                              return sel === 'over' ? 'Over' : 'Under';
                            } else {
                              const sel = String(rawRecord.selection_hdp || '').toLowerCase();
                              return sel === 'home' ? 'Home' : 'Away';
                            }
                          };
                          const getFairOdds = () => {
                            if (modalMarketFilter === 'moneyline') {
                              const val = rawRecord.fair_odds_1x2;
                              return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                            } else if (modalMarketFilter === 'overunder') {
                              const val = rawRecord.fair_odds_ou;
                              return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                            } else {
                              const val = rawRecord.fair_odds_hdp;
                              return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                            }
                          };
                          const getMarketOdds = () => {
                            if (modalMarketFilter === 'moneyline') {
                              const val = rawRecord.market_odds_1x2;
                              return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                            } else if (modalMarketFilter === 'overunder') {
                              const val = rawRecord.market_odds_ou;
                              return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                            } else {
                              const val = rawRecord.market_odds_hdp;
                              return val !== null && val !== undefined ? Number(val).toFixed(2) : '-';
                            }
                          };
                          const getEV = () => {
                            const parseEV = (val: unknown) => {
                              if (val === null || val === undefined) return '-';
                              const str = String(val).replace('%', '');
                              const num = parseFloat(str);
                              return !isNaN(num) ? `+${num.toFixed(2)}%` : '-';
                            };
                            if (modalMarketFilter === 'moneyline') {
                              return parseEV(rawRecord.expected_value_1x2);
                            } else if (modalMarketFilter === 'overunder') {
                              return parseEV(rawRecord.expected_value_ou);
                            } else {
                              return parseEV(rawRecord.expected_value_hdp);
                            }
                          };
                          const getStake = () => {
                            const parseStake = (val: unknown) => {
                              if (val === null || val === undefined) return '-';
                              const str = String(val).replace('%', '');
                              const num = parseFloat(str);
                              return !isNaN(num) ? `${num.toFixed(2)}u` : '-';
                            };
                            if (modalMarketFilter === 'moneyline') {
                              return parseStake(rawRecord.recommended_stake_1x2);
                            } else if (modalMarketFilter === 'overunder') {
                              return parseStake(rawRecord.recommended_stake_ou);
                            } else {
                              return parseStake(rawRecord.recommended_stake_hdp);
                            }
                          };
                          const isValuable = modalMarketFilter === 'moneyline' ? rawRecord.is_valuable_1x2 : modalMarketFilter === 'overunder' ? rawRecord.is_valuable_ou : rawRecord.is_valuable_hdp;
                          const getLine = () => {
                            if (modalMarketFilter === 'overunder') {
                              const val = rawRecord.total_points_mainline ?? rawRecord.totalpoints_main_line ?? rawRecord.line_ou ?? rawRecord.line ?? null;
                              return val !== null && val !== undefined ? String(val) : '-';
                            } else if (modalMarketFilter === 'handicap') {
                              const val = rawRecord.handicap_main_line ?? rawRecord.handicap_mainline ?? rawRecord.line_hdp ?? rawRecord.line ?? null;
                              return val !== null && val !== undefined ? String(val) : '-';
                            }
                            return null;
                          };

                          // Calculate unrealized P/L for HDP (mobile)
                          const getUnrealizedPnL = () => {
                            if (selectedMarket !== 'handicap') return null;

                            const scoreStr = record.score || '';
                            const scoreParts = scoreStr.split('-').map((s: string) => parseInt(s.trim(), 10));
                            if (scoreParts.length !== 2 || isNaN(scoreParts[0]) || isNaN(scoreParts[1])) {
                              return null;
                            }
                            const [homeGoals, awayGoals] = scoreParts;

                            const selStr = String(rawRecord.selection_hdp || '').toLowerCase().trim();
                            const selection: 'HOME' | 'AWAY' = selStr === 'home' ? 'HOME' : 'AWAY';

                            const lineVal = rawRecord.handicap_main_line ?? rawRecord.handicap_mainline ?? rawRecord.line_hdp ?? rawRecord.line ?? null;
                            if (lineVal === null || lineVal === undefined) return null;
                            const line = parseFloat(String(lineVal));
                            if (isNaN(line)) return null;

                            const oddsVal = rawRecord.market_odds_hdp;
                            if (oddsVal === null || oddsVal === undefined) return null;
                            const odds = typeof oddsVal === 'number' ? oddsVal : parseFloat(String(oddsVal));
                            if (isNaN(odds) || odds <= 0) return null;

                            const stakeVal = rawRecord.recommended_stake_hdp;
                            if (stakeVal === null || stakeVal === undefined) return null;
                            const stakeNum = typeof stakeVal === 'number'
                              ? stakeVal
                              : parseFloat(String(stakeVal).replace('%', '').replace('units', '').trim());
                            if (isNaN(stakeNum) || stakeNum <= 0) return null;

                            return calculateUnrealizedHdpPnL(homeGoals, awayGoals, selection, line, odds, stakeNum);
                          };

                          return (
                            <div
                              key={record.id || index}
                              className={`bg-white/5 rounded-lg p-3 border ${
                                index === 0 ? 'border-purple-500/30 bg-purple-500/5' : 'border-white/5'
                              }`}
                            >
                              {/* Header: Clock, Score, Status */}
                              <div className="flex items-center justify-between mb-2 pb-2 border-b border-white/5">
                                <div className="flex items-center gap-3">
                                  <span className="text-gray-400 text-sm">{record.clock !== null ? `${record.clock}'` : '-'}</span>
                                  <span className="text-white font-bold">{record.score || '-'}</span>
                                </div>
                                {isValuable ? (
                                  <span className="px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-400 text-xs font-bold">VALUE</span>
                                ) : (
                                  <span className="px-2 py-0.5 rounded bg-gray-500/20 text-gray-400 text-xs">NORMAL</span>
                                )}
                              </div>

                              {/* Selection & Line */}
                              <div className="flex items-center gap-2 mb-2">
                                <span className={`px-2 py-1 rounded text-xs font-bold ${
                                  modalMarketFilter === 'moneyline' ? 'bg-emerald-500/20 text-emerald-400' :
                                  modalMarketFilter === 'overunder' ? 'bg-cyan-500/20 text-cyan-400' :
                                  'bg-pink-500/20 text-pink-400'
                                }`}>{getSelectionLabel()}</span>
                                {getLine() && (
                                  <span className="text-amber-400 text-sm font-medium">Line: {getLine()}</span>
                                )}
                              </div>

                              {/* Odds & EV Row */}
                              <div className={`grid ${modalMarketFilter === 'handicap' ? 'grid-cols-5' : 'grid-cols-4'} gap-2 text-xs`}>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Fair</span>
                                  <span className="text-gray-400">{getFairOdds()}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Market</span>
                                  <span className="text-white font-medium">{getMarketOdds()}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">EV</span>
                                  <span className="text-emerald-400 font-medium">{getEV()}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Stake</span>
                                  <span className="text-yellow-400">{getStake()}</span>
                                </div>
                                {modalMarketFilter === 'handicap' && (() => {
                                  const unrealizedPnL = getUnrealizedPnL();
                                  return (
                                    <div className="text-center">
                                      <span className="text-gray-500 block text-[10px]">P/L</span>
                                      <span className={`font-medium ${unrealizedPnL ? getUnrealizedStatusColor(unrealizedPnL.status) : 'text-gray-500'}`}>
                                        {unrealizedPnL ? formatUnrealizedProfit(unrealizedPnL.profit) : '-'}
                                      </span>
                                    </div>
                                  );
                                })()}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                      </>
                    ) : (
                      <div className="text-center py-8 text-gray-500">No HDP Sniper signal history available</div>
                    )
                  ) : signalHistory[modalMarketFilter]?.length > 0 ? (
                    <>
                    {/* Desktop Table */}
                    <table className="w-full text-sm border-collapse hidden md:table">
                      <thead className="sticky top-0 bg-[#0d1117]">
                        <tr>
                          <th className="text-left py-3 px-3 text-gray-400 font-medium">Clock</th>
                          <th className="text-left py-3 px-3 text-gray-400 font-medium">Signal</th>
                          <th className="text-left py-3 px-3 text-gray-400 font-medium">Selection</th>
                          {modalMarketFilter === 'moneyline' && (
                            <>
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Home</th>
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Draw</th>
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Away</th>
                            </>
                          )}
                          {modalMarketFilter === 'overunder' && (
                            <>
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Line</th>
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Over</th>
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Under</th>
                            </>
                          )}
                          {modalMarketFilter === 'handicap' && (
                            <>
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Line</th>
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Home</th>
                              <th className="text-center py-3 px-2 text-gray-400 font-medium">Away</th>
                            </>
                          )}
                          <th className="text-left py-3 px-3 text-gray-400 font-medium">Bookmaker</th>
                          <th className="text-left py-3 px-3 text-gray-400 font-medium">Stacking</th>
                          <th className="text-left py-3 px-3 text-gray-400 font-medium">Vig Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {signalHistory[modalMarketFilter].map((record, index) => (
                          <tr key={record.id} className={`border-b border-white/5 ${index === 0 ? 'bg-emerald-500/10' : 'hover:bg-white/5'} transition-colors`}>
                            <td className="py-3 px-3 text-gray-300">
                              {record.clock !== null ? `${record.clock}'` : '-'}
                            </td>
                            <td className="py-3 px-3">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${
                                record.signal?.includes('🟢') ? 'bg-emerald-500/20 text-emerald-400' :
                                record.signal?.includes('🔥') ? 'bg-orange-500/20 text-orange-400' :
                                record.signal?.includes('🔵') ? 'bg-blue-500/20 text-blue-400' :
                                record.signal?.includes('🔴') ? 'bg-red-500/20 text-red-400' :
                                'bg-gray-500/20 text-gray-400'
                              }`}>
                                {record.signal || '-'}
                              </span>
                            </td>
                            <td className="py-3 px-3 text-white font-medium">{record.selection || '-'}</td>
                            {modalMarketFilter === 'moneyline' && (
                              <>
                                <td className="py-3 px-2 text-center text-cyan-400 font-medium">{(record as Moneyline1x2Prediction).moneyline_1x2_home?.toFixed(2) ?? '-'}</td>
                                <td className="py-3 px-2 text-center text-cyan-400 font-medium">{(record as Moneyline1x2Prediction).moneyline_1x2_draw?.toFixed(2) ?? '-'}</td>
                                <td className="py-3 px-2 text-center text-cyan-400 font-medium">{(record as Moneyline1x2Prediction).moneyline_1x2_away?.toFixed(2) ?? '-'}</td>
                              </>
                            )}
                            {modalMarketFilter === 'overunder' && (
                              <>
                                <td className="py-3 px-2 text-center text-purple-400 font-medium">{(record as OverUnderPrediction).line ?? '-'}</td>
                                <td className="py-3 px-2 text-center text-cyan-400 font-medium">{(record as OverUnderPrediction).over?.toFixed(2) ?? '-'}</td>
                                <td className="py-3 px-2 text-center text-cyan-400 font-medium">{(record as OverUnderPrediction).under?.toFixed(2) ?? '-'}</td>
                              </>
                            )}
                            {modalMarketFilter === 'handicap' && (
                              <>
                                <td className="py-3 px-2 text-center text-purple-400 font-medium">{(record as HandicapPrediction).line ?? '-'}</td>
                                <td className="py-3 px-2 text-center text-cyan-400 font-medium">{(record as HandicapPrediction).home_odds?.toFixed(2) ?? '-'}</td>
                                <td className="py-3 px-2 text-center text-cyan-400 font-medium">{(record as HandicapPrediction).away_odds?.toFixed(2) ?? '-'}</td>
                              </>
                            )}
                            <td className="py-3 px-3 text-gray-300">{record.bookmaker || '-'}</td>
                            <td className="py-3 px-3 text-yellow-400 text-xs">{record.stacking_quantity || '-'}</td>
                            <td className="py-3 px-3 text-gray-400 text-xs">{record.market_analysis_vig_status || '-'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>

                    {/* Mobile Card Layout for Regular Signals */}
                    <div className="md:hidden space-y-3 p-2">
                      {signalHistory[modalMarketFilter].map((record, index) => (
                        <div
                          key={record.id}
                          className={`bg-white/5 rounded-lg p-3 border ${
                            index === 0 ? 'border-emerald-500/30 bg-emerald-500/5' : 'border-white/5'
                          }`}
                        >
                          {/* Header: Clock & Signal */}
                          <div className="flex items-center justify-between mb-2 pb-2 border-b border-white/5">
                            <span className="text-gray-400 text-sm">{record.clock !== null ? `${record.clock}'` : '-'}</span>
                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                              record.signal?.includes('🟢') ? 'bg-emerald-500/20 text-emerald-400' :
                              record.signal?.includes('🔥') ? 'bg-orange-500/20 text-orange-400' :
                              record.signal?.includes('🔵') ? 'bg-blue-500/20 text-blue-400' :
                              record.signal?.includes('🔴') ? 'bg-red-500/20 text-red-400' :
                              'bg-gray-500/20 text-gray-400'
                            }`}>
                              {record.signal || '-'}
                            </span>
                          </div>

                          {/* Selection */}
                          <div className="mb-2">
                            <span className="text-white font-medium">{record.selection || '-'}</span>
                          </div>

                          {/* Market-specific odds */}
                          <div className="grid grid-cols-3 gap-2 text-xs mb-2">
                            {modalMarketFilter === 'moneyline' && (
                              <>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Home</span>
                                  <span className="text-cyan-400 font-medium">{(record as Moneyline1x2Prediction).moneyline_1x2_home?.toFixed(2) ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Draw</span>
                                  <span className="text-cyan-400 font-medium">{(record as Moneyline1x2Prediction).moneyline_1x2_draw?.toFixed(2) ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Away</span>
                                  <span className="text-cyan-400 font-medium">{(record as Moneyline1x2Prediction).moneyline_1x2_away?.toFixed(2) ?? '-'}</span>
                                </div>
                              </>
                            )}
                            {modalMarketFilter === 'overunder' && (
                              <>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Line</span>
                                  <span className="text-purple-400 font-medium">{(record as OverUnderPrediction).line ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Over</span>
                                  <span className="text-cyan-400 font-medium">{(record as OverUnderPrediction).over?.toFixed(2) ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Under</span>
                                  <span className="text-cyan-400 font-medium">{(record as OverUnderPrediction).under?.toFixed(2) ?? '-'}</span>
                                </div>
                              </>
                            )}
                            {modalMarketFilter === 'handicap' && (
                              <>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Line</span>
                                  <span className="text-purple-400 font-medium">{(record as HandicapPrediction).line ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Home</span>
                                  <span className="text-cyan-400 font-medium">{(record as HandicapPrediction).home_odds?.toFixed(2) ?? '-'}</span>
                                </div>
                                <div className="text-center">
                                  <span className="text-gray-500 block text-[10px]">Away</span>
                                  <span className="text-cyan-400 font-medium">{(record as HandicapPrediction).away_odds?.toFixed(2) ?? '-'}</span>
                                </div>
                              </>
                            )}
                          </div>

                          {/* Extra Info */}
                          <div className="flex items-center justify-between text-[10px] text-gray-500 pt-2 border-t border-white/5">
                            <span>{record.bookmaker || '-'}</span>
                            <span className="text-yellow-400">{record.stacking_quantity || '-'}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                    </>
                  ) : (
                    <div className="text-center py-8 text-gray-500">
                      No signal history available
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Profit Summary Modal */}
          {showProfitModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
              {/* Backdrop */}
              <div
                className="absolute inset-0 bg-black/80 backdrop-blur-sm"
                onClick={() => setShowProfitModal(false)}
              />
              {/* Modal - wider and scrollable */}
              <div className="relative bg-gradient-to-br from-gray-900 to-gray-950 rounded-2xl border border-white/10 p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                {/* Background glow */}
                <div className="absolute top-0 left-1/4 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl pointer-events-none" />
                <div className="absolute top-0 right-1/4 w-64 h-64 bg-cyan-500/10 rounded-full blur-3xl pointer-events-none" />

                <div className="flex items-center justify-between mb-6 relative z-10">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                      </svg>
                    </div>
                    <h3 className="text-xl font-bold text-white">
                      {selectedPersonality === 'value' ? 'HDP Sniper Profit Summary'
                        : selectedPersonality === 'aggressive' ? 'Active Trader Profit Summary'
                        : selectedPersonality === 'balanced' ? 'Oddsflow Core Strategy Profit Summary'
                        : selectedPersonality === 'beta' ? 'Oddsflow Beta Profit Summary'
                        : 'Profit Summary'}
                    </h3>
                  </div>
                  <button
                    onClick={() => setShowProfitModal(false)}
                    className="p-2 rounded-lg hover:bg-white/10 transition-colors cursor-pointer"
                  >
                    <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>

                {profitSummary ? (
                  <div className="relative z-10 space-y-4">
                    {/* Main Stats */}
                    <div className="grid grid-cols-2 gap-3">
                      {/* Total Profit */}
                      <div className="bg-white/5 rounded-xl p-4 border border-white/10">
                        <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Total Profit</div>
                        <div className={`text-2xl font-bold ${(profitSummary.total_profit ?? 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                          {(profitSummary.total_profit ?? 0) >= 0 ? '+$' : '-$'}{Math.abs(profitSummary.total_profit ?? 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </div>
                      </div>
                      {/* ROI */}
                      <div className="bg-white/5 rounded-xl p-4 border border-white/10">
                        <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">ROI</div>
                        <div className={`text-2xl font-bold ${(profitSummary.roi_percentage ?? 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                          {(profitSummary.roi_percentage ?? 0) >= 0 ? '+' : ''}{profitSummary.roi_percentage?.toFixed(2) ?? '0.00'}%
                        </div>
                      </div>
                      {/* Total Invested */}
                      <div className="bg-white/5 rounded-xl p-4 border border-white/10">
                        <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Total Invested</div>
                        <div className="text-xl font-bold text-white">
                          ${(profitSummary.total_invested ?? 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </div>
                      </div>
                      {/* Total Bets */}
                      <div className="bg-white/5 rounded-xl p-4 border border-white/10">
                        <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Total Bets</div>
                        <div className="text-xl font-bold text-white">
                          {profitSummary.total_bets ?? 0}
                        </div>
                      </div>
                    </div>

                    {/* Market Breakdown */}
                    <div className="bg-white/5 rounded-xl p-4 border border-white/10">
                      <div className="text-xs text-gray-500 uppercase tracking-wider mb-3">Profit by Market</div>
                      <div className="space-y-3">
                        {/* Moneyline */}
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-cyan-500"></div>
                            <span className="text-gray-300 text-sm">1X2 Moneyline</span>
                          </div>
                          <span className={`font-bold ${(profitSummary.profit_moneyline ?? 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                            {(profitSummary.profit_moneyline ?? 0) >= 0 ? '+$' : '-$'}{Math.abs(profitSummary.profit_moneyline ?? 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          </span>
                        </div>
                        {/* Handicap */}
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-purple-500"></div>
                            <span className="text-gray-300 text-sm">Asian Handicap</span>
                          </div>
                          <span className={`font-bold ${(profitSummary.profit_handicap ?? 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                            {(profitSummary.profit_handicap ?? 0) >= 0 ? '+$' : '-$'}{Math.abs(profitSummary.profit_handicap ?? 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          </span>
                        </div>
                        {/* Over/Under */}
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-amber-500"></div>
                            <span className="text-gray-300 text-sm">Over/Under</span>
                          </div>
                          <span className={`font-bold ${(profitSummary.profit_ou ?? 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                            {(profitSummary.profit_ou ?? 0) >= 0 ? '+$' : '-$'}{Math.abs(profitSummary.profit_ou ?? 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* Bet Details Table */}
                    {profitSummaryRecords.length > 0 && (() => {
                      // Helper function to derive bet type from selection
                      const getBetType = (selection: string | null): 'moneyline' | 'handicap' | 'ou' => {
                        if (!selection) return 'ou';
                        const sel = selection.toLowerCase();
                        // Handicap bets - check for HDP in selection (e.g., HOME_HDP_-0.75, AWAY_HDP_+0.5)
                        if (sel.includes('hdp') || sel.includes('handicap')) return 'handicap';
                        // Over/Under bets
                        if (sel.includes('over') || sel.includes('under')) return 'ou';
                        // Handicap bets - selection contains Home/Away with a number like -0.5, +0.25
                        if (/^(home|away)\s*[+-]?\d/.test(sel)) return 'handicap';
                        // Pure Home/Draw/Away without numbers = 1X2 Moneyline
                        if (sel === 'home' || sel === 'draw' || sel === 'away') return 'moneyline';
                        // Default fallback
                        return 'ou';
                      };

                      const filteredRecords = profitSummaryRecords.filter(record => {
                        if (profitTypeFilter === 'all') return true;
                        const derivedType = getBetType(record.selection);
                        return derivedType === profitTypeFilter;
                      });

                      return (
                      <div className="bg-white/5 rounded-xl p-4 border border-white/10">
                        {/* Header with Filter */}
                        <div className="flex items-center justify-between mb-3">
                          <div className="text-xs text-gray-500 uppercase tracking-wider">Bet Details ({filteredRecords.length})</div>
                          <div className="flex gap-1">
                            <button
                              onClick={() => setProfitTypeFilter('all')}
                              className={`px-2 py-1 rounded text-xs font-medium transition-colors cursor-pointer ${
                                profitTypeFilter === 'all' ? 'bg-white/20 text-white' : 'bg-white/5 text-gray-400 hover:bg-white/10'
                              }`}
                            >
                              All
                            </button>
                            <button
                              onClick={() => setProfitTypeFilter('moneyline')}
                              className={`px-2 py-1 rounded text-xs font-medium transition-colors cursor-pointer ${
                                profitTypeFilter === 'moneyline' ? 'bg-cyan-500/30 text-cyan-400' : 'bg-white/5 text-gray-400 hover:bg-white/10'
                              }`}
                            >
                              1X2
                            </button>
                            <button
                              onClick={() => setProfitTypeFilter('handicap')}
                              className={`px-2 py-1 rounded text-xs font-medium transition-colors cursor-pointer ${
                                profitTypeFilter === 'handicap' ? 'bg-purple-500/30 text-purple-400' : 'bg-white/5 text-gray-400 hover:bg-white/10'
                              }`}
                            >
                              HDP
                            </button>
                            <button
                              onClick={() => setProfitTypeFilter('ou')}
                              className={`px-2 py-1 rounded text-xs font-medium transition-colors cursor-pointer ${
                                profitTypeFilter === 'ou' ? 'bg-amber-500/30 text-amber-400' : 'bg-white/5 text-gray-400 hover:bg-white/10'
                              }`}
                            >
                              O/U
                            </button>
                          </div>
                        </div>
                        {/* Desktop Table */}
                        <table className="w-full text-sm hidden md:table">
                          <thead>
                            <tr className="border-b border-white/10">
                              <th className="text-left py-2 px-2 text-gray-400 font-medium text-xs">Clock</th>
                              <th className="text-left py-2 px-2 text-gray-400 font-medium text-xs">Type</th>
                              <th className="text-left py-2 px-2 text-gray-400 font-medium text-xs">Selection</th>
                              <th className="text-center py-2 px-2 text-gray-400 font-medium text-xs">Line</th>
                              <th className="text-center py-2 px-2 text-gray-400 font-medium text-xs">Odds</th>
                              <th className="text-center py-2 px-2 text-gray-400 font-medium text-xs">Stake</th>
                              <th className="text-center py-2 px-2 text-gray-400 font-medium text-xs">Score</th>
                              <th className="text-center py-2 px-2 text-gray-400 font-medium text-xs">Status</th>
                              <th className="text-right py-2 px-2 text-gray-400 font-medium text-xs">Profit</th>
                            </tr>
                          </thead>
                          <tbody>
                            {filteredRecords.map((record, index) => {
                              const derivedType = getBetType(record.selection);
                              return (
                              <tr key={record.id || index} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                                <td className="py-2 px-2 text-gray-300 text-xs whitespace-nowrap">
                                  {record.clock !== null ? `${record.clock}'` : '-'}
                                </td>
                                <td className="py-2 px-2">
                                  <span className={`px-1.5 py-0.5 rounded text-[10px] font-medium ${
                                    derivedType === 'moneyline' ? 'bg-cyan-500/20 text-cyan-400' :
                                    derivedType === 'handicap' ? 'bg-purple-500/20 text-purple-400' :
                                    'bg-amber-500/20 text-amber-400'
                                  }`}>
                                    {derivedType === 'moneyline' ? '1X2' : derivedType === 'handicap' ? 'HDP' : 'O/U'}
                                  </span>
                                </td>
                                <td className="py-2 px-2 text-white text-xs font-medium">{record.selection || '-'}</td>
                                <td className="py-2 px-2 text-center text-amber-400 text-xs">{record.line ?? '-'}</td>
                                <td className="py-2 px-2 text-center text-gray-300 text-xs">{record.odds?.toFixed(2) ?? '-'}</td>
                                <td className="py-2 px-2 text-center text-gray-300 text-xs">{record.stake_units ?? '-'}</td>
                                <td className="py-2 px-2 text-center text-white text-xs font-medium">
                                  {record.home_score !== null && record.away_score !== null ? `${record.home_score}-${record.away_score}` : '-'}
                                </td>
                                <td className="py-2 px-2 text-center">
                                  <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold ${
                                    record.status === 'won' ? 'bg-cyan-500/20 text-cyan-400' :
                                    record.status === 'lost' ? 'bg-red-500/20 text-red-400' :
                                    record.status === 'push' ? 'bg-gray-500/20 text-gray-400' :
                                    'bg-yellow-500/20 text-yellow-400'
                                  }`}>
                                    {record.status?.toUpperCase() || '-'}
                                  </span>
                                </td>
                                <td className={`py-2 px-2 text-right text-xs font-bold ${(record.profit ?? 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                  {(record.profit ?? 0) >= 0 ? '+' : ''}{record.profit?.toFixed(2) ?? '0.00'}
                                </td>
                              </tr>
                            );})}
                          </tbody>
                        </table>

                        {/* Mobile Card Layout */}
                        <div className="md:hidden space-y-2 max-h-[300px] overflow-y-auto">
                          {filteredRecords.map((record, index) => {
                            const derivedType = getBetType(record.selection);
                            return (
                              <div key={record.id || index} className="bg-white/5 rounded-lg p-3 border border-white/5">
                                {/* Header: Clock, Type, Status */}
                                <div className="flex items-center justify-between mb-2">
                                  <div className="flex items-center gap-2">
                                    <span className="text-gray-500 text-xs">{record.clock !== null ? `${record.clock}'` : '-'}</span>
                                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-medium ${
                                      derivedType === 'moneyline' ? 'bg-cyan-500/20 text-cyan-400' :
                                      derivedType === 'handicap' ? 'bg-purple-500/20 text-purple-400' :
                                      'bg-amber-500/20 text-amber-400'
                                    }`}>
                                      {derivedType === 'moneyline' ? '1X2' : derivedType === 'handicap' ? 'HDP' : 'O/U'}
                                    </span>
                                  </div>
                                  <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${
                                    record.status === 'won' ? 'bg-cyan-500/20 text-cyan-400' :
                                    record.status === 'lost' ? 'bg-red-500/20 text-red-400' :
                                    record.status === 'push' ? 'bg-gray-500/20 text-gray-400' :
                                    'bg-yellow-500/20 text-yellow-400'
                                  }`}>
                                    {record.status?.toUpperCase() || '-'}
                                  </span>
                                </div>

                                {/* Selection & Profit */}
                                <div className="flex items-center justify-between">
                                  <div className="flex-1">
                                    <div className="text-white text-sm font-medium">{record.selection || '-'}</div>
                                    <div className="flex items-center gap-2 text-xs text-gray-400 mt-0.5">
                                      <span>Line: <span className="text-amber-400">{record.line ?? '-'}</span></span>
                                      <span>@{record.odds?.toFixed(2) ?? '-'}</span>
                                      <span>{record.stake_units ?? '-'}u</span>
                                    </div>
                                  </div>
                                  <div className={`text-sm font-bold ${(record.profit ?? 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                    {(record.profit ?? 0) >= 0 ? '+' : ''}{record.profit?.toFixed(2) ?? '0.00'}
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );})()}

                    {/* Note */}
                    <div className="text-center text-xs text-gray-500">
                      1 Bet = $100
                    </div>
                  </div>
                ) : (
                  <div className="relative z-10 text-center py-8 text-gray-500">
                    <svg className="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <p className="text-sm">No profit summary available</p>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* AI Predictions Section */}
          <div className="bg-gradient-to-br from-gray-900/80 to-gray-950/80 rounded-2xl border border-white/5 p-4 sm:p-5">
            {/* Header Row */}
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                {match.type === 'In Play' && (
                  <div className="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse" />
                )}
                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center">
                  <svg className="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                </div>
                <div>
                  <h2 className="text-lg font-bold text-white">{t('aiPredictions')}</h2>
                  <div className="flex items-center gap-1.5">
                    <span className="text-xs text-gray-500">{currentPersonality.name}</span>
                  </div>
                </div>
                {/* Live Refresh Countdown */}
                {match.type === 'In Play' && (
                  <div className="ml-2 relative flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/30">
                    {/* Progress bar background */}
                    <div className="absolute inset-0 rounded-full overflow-hidden">
                      <div
                        className="h-full transition-all duration-1000 ease-linear bg-gradient-to-r from-red-500/30 to-red-400/20"
                        style={{ width: `${(refreshCountdown / 10) * 100}%` }}
                      />
                    </div>
                    {/* Content */}
                    <div className="relative flex items-center gap-2">
                      <svg className="w-3.5 h-3.5 animate-spin text-red-400" style={{ animationDuration: '2s' }} fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <span className="text-xs font-medium text-red-400">
                        {t('refreshIn')} <span className="font-bold text-red-300">{refreshCountdown}s</span>
                      </span>
                    </div>
                  </div>
                )}
              </div>
              <div className="flex items-center gap-2">
                {/* Profit Summary Button - Only for Finished matches */}
                {match.type === 'Finished' && (
                  <button
                    onClick={openProfitSummary}
                    className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gradient-to-r from-emerald-500/20 to-cyan-500/20 border border-emerald-500/30 text-emerald-400 text-xs font-medium hover:from-emerald-500/30 hover:to-cyan-500/30 transition-all cursor-pointer"
                  >
                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Profit Summary
                  </button>
                )}
                <button
                  onClick={openSignalHistory}
                  className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gradient-to-r from-amber-500/20 to-orange-500/20 border border-amber-500/30 text-amber-400 text-xs font-medium hover:from-amber-500/30 hover:to-orange-500/30 transition-all cursor-pointer"
                >
                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Signal History
                </button>
              </div>
            </div>

            {/* Personality Quick Select - Updated to match Performance page */}
            <div className="flex gap-2 mb-4 overflow-x-auto pb-1">
              {PERSONALITIES.map((p) => {
                const available = isStyleAvailable(p.id);
                const isLocked = p.isLocked || !available;
                return (
                  <button
                    key={p.id}
                    onClick={() => !isLocked && handlePersonalityChange(p.id)}
                    disabled={isLocked}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all relative overflow-hidden group flex items-center gap-2 ${
                      isLocked
                        ? 'bg-gray-800 text-gray-400 border border-gray-700 cursor-not-allowed'
                        : selectedPersonality === p.id
                        ? `bg-gradient-to-r ${p.color} text-white border border-white/20 shadow-lg cursor-pointer`
                        : 'bg-white/5 text-gray-400 hover:bg-white/10 border border-white/10 cursor-pointer'
                    }`}
                  >
                    {/* Coming Soon badge for locked features */}
                    {p.isLocked && (
                      <span className="absolute -top-1 -right-1 bg-orange-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full z-20 shadow-lg">
                        COMING SOON
                      </span>
                    )}

                    {/* Hover shine effect */}
                    {selectedPersonality !== p.id && !isLocked && (
                      <span className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700" />
                    )}

                    {/* Icon image with custom background colors */}
                    {p.image && (
                      <div
                        className={`w-8 h-8 rounded-lg flex items-center justify-center relative z-10 transition-all bg-gradient-to-br ${p.logoColor} ${
                          selectedPersonality === p.id
                            ? 'shadow-xl scale-110 ring-2 ring-white/30'
                            : ''
                        }`}
                      >
                        <img
                          src={p.image}
                          alt={p.name}
                          className={`object-contain transition-all ${
                            selectedPersonality === p.id ? 'w-6 h-6' : 'w-5 h-5'
                          }`}
                        />
                      </div>
                    )}

                    <span className="relative z-10 whitespace-nowrap">{p.name}</span>

                    {/* Lock icon for subscription-locked styles */}
                    {!p.isLocked && !available && (
                      <svg className="w-3 h-3 relative z-10 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                      </svg>
                    )}
                  </button>
                );
              })}
            </div>

            {/* Market Type Tabs */}
            <div className="flex gap-1 p-1 bg-white/5 rounded-xl mb-4">
              <button
                onClick={() => setSelectedMarket('moneyline')}
                className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all cursor-pointer ${
                  selectedMarket === 'moneyline'
                    ? 'bg-gradient-to-r from-emerald-500 to-cyan-500 text-black'
                    : 'text-gray-400 hover:text-white hover:bg-white/5'
                }`}
              >
                1X2
              </button>
              <button
                onClick={() => setSelectedMarket('overunder')}
                className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all cursor-pointer ${
                  selectedMarket === 'overunder'
                    ? 'bg-gradient-to-r from-cyan-500 to-blue-500 text-black'
                    : 'text-gray-400 hover:text-white hover:bg-white/5'
                }`}
              >
                O/U
              </button>
              <button
                onClick={() => setSelectedMarket('handicap')}
                className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all cursor-pointer ${
                  selectedMarket === 'handicap'
                    ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'
                    : 'text-gray-400 hover:text-white hover:bg-white/5'
                }`}
              >
                HDP
              </button>
            </div>

            {/* Prediction Card - Compact Design */}
            {selectedMarket === 'moneyline' && (
              <div className="space-y-3">
                {selectedPersonality === 'value' ? (
                  // HDP Sniper (Value Hunter) - check for finished OR live signals
                  match.type === 'Finished' ? (
                    // Show last 3 live signals for finished matches
                    (() => {
                      const lastLiveSignals = getLastLiveSignals('1x2', 3);
                      console.log('Rendering 1X2 for HDP Sniper (Finished):', {
                        liveSignalsHistoryLength: liveSignalsHistory.length,
                        lastLiveSignalsLength: lastLiveSignals.length,
                        matchType: match.type,
                        selectedPersonality
                      });

                      if (lastLiveSignals.length === 0) {
                        return (
                          <div className="text-center py-8 text-gray-500">
                            <div className="space-y-2">
                              <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              <p className="text-sm">Match has ended</p>
                            </div>
                          </div>
                        );
                      }
                      return (
                        <div className="opacity-30">
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                              <thead>
                                <tr className="border-b border-white/10">
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Clock</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Selection</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Fair Odds</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Market Odds</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">EV</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Stake</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Value</th>
                                </tr>
                              </thead>
                              <tbody>
                                {lastLiveSignals.map((signal: any, index: number) => {
                                  const raw = signal as Record<string, unknown>;
                                  const selection = String(raw.selection_1x2 || '').toUpperCase();
                                  const selectionLabel = selection === 'HOME' || selection === '1' ? 'Home' : selection === 'DRAW' || selection === 'X' ? 'Draw' : 'Away';
                                  const fairOdds = raw.fair_odds_1x2 !== null && raw.fair_odds_1x2 !== undefined ? Number(raw.fair_odds_1x2).toFixed(2) : '-';
                                  const marketOdds = raw.market_odds_1x2 !== null && raw.market_odds_1x2 !== undefined ? Number(raw.market_odds_1x2).toFixed(2) : '-';
                                  const evStr = String(raw.expected_value_1x2 || '').replace('%', '');
                                  const evNum = parseFloat(evStr);
                                  const evDisplay = !isNaN(evNum) ? `+${evNum.toFixed(2)}%` : '-';
                                  const stakeStr = String(raw.recommended_stake_1x2 || '').replace('%', '');
                                  const stakeNum = parseFloat(stakeStr);
                                  const stakeDisplay = !isNaN(stakeNum) ? `${stakeNum.toFixed(2)}` : '-';
                                  const isValuable = raw.is_valuable_1x2;
                                  const clock = raw.clock;

                                  return (
                                    <tr key={index} className="border-b border-white/5">
                                      <td className="py-2 px-3">
                                        {clock !== null && clock !== undefined ? (
                                          <span className="text-red-400 font-bold tabular-nums">{String(clock)}'</span>
                                        ) : (
                                          <span className="text-gray-500">-</span>
                                        )}
                                      </td>
                                      <td className="py-2 px-3">
                                        <span className="text-emerald-400 font-medium">{selectionLabel}</span>
                                      </td>
                                      <td className="py-2 px-3 text-gray-300">{fairOdds}</td>
                                      <td className="py-2 px-3 text-white font-semibold">{marketOdds}</td>
                                      <td className="py-2 px-3 text-emerald-400">{evDisplay}</td>
                                      <td className="py-2 px-3 text-yellow-400">{stakeDisplay}</td>
                                      <td className="py-2 px-3">
                                        {Boolean(isValuable) ? (
                                          <span className="text-emerald-400">💎</span>
                                        ) : (
                                          <span className="text-gray-500">-</span>
                                        )}
                                      </td>
                                    </tr>
                                  );
                                })}
                              </tbody>
                            </table>
                          </div>
                          <div className="text-center mt-4 text-gray-500 text-sm">Match has ended</div>
                        </div>
                      );
                    })()
                  ) : liveSignals ? (
                    // Show current live signal for ongoing match
                    (() => {
                      const raw = liveSignals as unknown as Record<string, unknown>;
                      const selection = String(raw.selection_1x2 || '').toUpperCase();
                      const selectionLabel = selection === 'HOME' || selection === '1' ? 'Home Win' : selection === 'DRAW' || selection === 'X' ? 'Draw' : 'Away Win';
                      const fairOdds = raw.fair_odds_1x2 !== null && raw.fair_odds_1x2 !== undefined ? Number(raw.fair_odds_1x2).toFixed(2) : '-';
                      const marketOdds = raw.market_odds_1x2 !== null && raw.market_odds_1x2 !== undefined ? Number(raw.market_odds_1x2).toFixed(2) : '-';
                      const evStr = String(raw.expected_value_1x2 || '').replace('%', '');
                      const evNum = parseFloat(evStr);
                      const evDisplay = !isNaN(evNum) ? `+${evNum.toFixed(2)}%` : '-';
                      const stakeStr = String(raw.recommended_stake_1x2 || '').replace('%', '');
                      const stakeNum = parseFloat(stakeStr);
                      const stakeDisplay = !isNaN(stakeNum) ? stakeNum.toFixed(2) : '-';
                      const isValuable = raw.is_valuable_1x2;
                      const score = raw.score as string | null;
                      const clock = raw.clock;

                      return (
                        <div className="rounded-xl bg-gradient-to-br from-purple-900/40 to-indigo-900/40 border-purple-500/20 border overflow-hidden">
                          <div className="flex items-center justify-between px-4 py-3 bg-black/20">
                            <div className="flex items-center gap-3">
                              {clock !== null && clock !== undefined && (
                                <div className="flex items-center gap-1.5">
                                  <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                                  <span className="text-white font-bold">{String(clock)}'</span>
                                </div>
                              )}
                              {score && (
                                <span className="text-gray-400 text-sm">Score: <span className="text-white font-semibold">{score}</span></span>
                              )}
                            </div>
                            {Boolean(isValuable) && (
                              <div className="flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-500/20 border-emerald-500/40 border">
                                <span className="text-emerald-400 text-xs font-bold">💎 VALUE BET</span>
                              </div>
                            )}
                          </div>
                          <div className="p-4">
                            <div className="flex items-center justify-between mb-4">
                              <div>
                                <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Recommended Bet</div>
                                <div className="text-xl font-bold text-white">{selectionLabel}</div>
                              </div>
                              <div className="flex items-center gap-6">
                                <div className="text-center">
                                  <div className="text-[10px] text-gray-500 uppercase">Fair</div>
                                  <div className="text-lg font-semibold text-gray-300">{fairOdds}</div>
                                </div>
                                <div className="text-gray-600">→</div>
                                <div className="text-center">
                                  <div className="text-[10px] text-gray-500 uppercase">Market</div>
                                  <div className="text-xl font-bold text-white">{marketOdds}</div>
                                </div>
                              </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                              <div className="bg-black/20 rounded-lg p-3">
                                <div className="text-[10px] text-gray-500 uppercase tracking-wider">Expected Value</div>
                                <div className="text-lg font-bold text-emerald-400">{evDisplay}</div>
                              </div>
                              <div className="bg-black/20 rounded-lg p-3">
                                <div className="text-[10px] text-gray-500 uppercase tracking-wider">Stake</div>
                                <div className="text-lg font-bold text-yellow-400">{stakeDisplay !== '-' ? `${stakeDisplay} units` : '-'}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })()
                  ) : (
                    // No signals available for HDP Sniper
                    <div className="text-center py-8 text-gray-500">
                      {match.type === 'Scheduled' ? (
                        <div className="space-y-2">
                          <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          <p className="text-sm">Match has not started yet</p>
                        </div>
                      ) : (
                        <div className="space-y-2">
                          <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                          </svg>
                          <p className="text-sm">AI no predictions</p>
                        </div>
                      )}
                    </div>
                  )
                ) : selectedPersonality === 'beta' ? (
                  // Oddsflow Beta - check for finished OR live signals
                  match.type === 'Finished' ? (
                    // Show last 3 beta signals for finished matches
                    (() => {
                      const lastBetaSignals = getLastBetaSignals('1x2', 3);
                      console.log('Rendering 1X2 for Oddsflow Beta (Finished):', {
                        betaSignalsHistoryLength: betaSignalsHistory.length,
                        lastBetaSignalsLength: lastBetaSignals.length,
                        matchType: match.type,
                        selectedPersonality
                      });

                      if (lastBetaSignals.length === 0) {
                        return (
                          <div className="text-center py-8 text-gray-500">
                            <div className="space-y-2">
                              <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              <p className="text-sm">Match has ended</p>
                            </div>
                          </div>
                        );
                      }
                      return (
                        <div className="opacity-30">
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                              <thead>
                                <tr className="border-b border-white/10">
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Clock</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Selection</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Fair Odds</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Market Odds</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">EV</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Stake</th>
                                  <th className="text-left py-2 px-3 text-gray-400 font-medium">Value</th>
                                </tr>
                              </thead>
                              <tbody>
                                {lastBetaSignals.map((signal: any, index: number) => {
                                  const raw = signal as Record<string, unknown>;
                                  const selection = String(raw.selection_1x2 || '').toUpperCase();
                                  const selectionLabel = selection === 'HOME' || selection === '1' ? 'Home' : selection === 'DRAW' || selection === 'X' ? 'Draw' : 'Away';
                                  const fairOdds = raw.fair_odds_1x2 !== null && raw.fair_odds_1x2 !== undefined ? Number(raw.fair_odds_1x2).toFixed(2) : '-';
                                  const marketOdds = raw.market_odds_1x2 !== null && raw.market_odds_1x2 !== undefined ? Number(raw.market_odds_1x2).toFixed(2) : '-';
                                  const evStr = String(raw.expected_value_1x2 || '').replace('%', '');
                                  const evNum = parseFloat(evStr);
                                  const evDisplay = !isNaN(evNum) ? `+${evNum.toFixed(2)}%` : '-';
                                  const stakeStr = String(raw.recommended_stake_1x2 || '').replace('%', '');
                                  const stakeNum = parseFloat(stakeStr);
                                  const stakeDisplay = !isNaN(stakeNum) ? `${stakeNum.toFixed(2)}` : '-';
                                  const isValuable = raw.is_valuable_1x2;
                                  const clock = raw.clock;

                                  return (
                                    <tr key={index} className="border-b border-white/5">
                                      <td className="py-2 px-3">
                                        {clock !== null && clock !== undefined ? (
                                          <span className="text-red-400 font-bold tabular-nums">{String(clock)}'</span>
                                        ) : (
                                          <span className="text-gray-500">-</span>
                                        )}
                                      </td>
                                      <td className="py-2 px-3">
                                        <span className="text-emerald-400 font-medium">{selectionLabel}</span>
                                      </td>
                                      <td className="py-2 px-3 text-gray-300">{fairOdds}</td>
                                      <td className="py-2 px-3 text-white font-semibold">{marketOdds}</td>
                                      <td className="py-2 px-3 text-emerald-400">{evDisplay}</td>
                                      <td className="py-2 px-3 text-yellow-400">{stakeDisplay}</td>
                                      <td className="py-2 px-3">
                                        {Boolean(isValuable) ? (
                                          <span className="text-emerald-400">💎</span>
                                        ) : (
                                          <span className="text-gray-500">-</span>
                                        )}
                                      </td>
                                    </tr>
                                  );
                                })}
                              </tbody>
                            </table>
                          </div>
                          <div className="text-center mt-4 text-gray-500 text-sm">Match has ended</div>
                        </div>
                      );
                    })()
                  ) : (
                    // No beta signals available or match not finished
                    <div className="text-center py-8 text-gray-500">
                      {match.type === 'Scheduled' ? (
                        <div className="space-y-2">
                          <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          <p className="text-sm">Match has not started yet</p>
                        </div>
                      ) : (
                        <div className="space-y-2">
                          <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                          </svg>
                          <p className="text-sm">AI no predictions</p>
                        </div>
                      )}
                    </div>
                  )
                ) : match.type === 'Finished' ? (
                  // Regular AI personalities - show last 3 signals for finished matches
                  (() => {
                    const lastSignals = getLastSignals('moneyline', 3);
                    if (lastSignals.length === 0) {
                      return (
                        <div className="text-center py-8 text-gray-500">
                          <div className="space-y-2">
                            <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p className="text-sm">Match has ended</p>
                          </div>
                        </div>
                      );
                    }
                    return (
                      <div className="opacity-30">
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b border-white/10">
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Clock</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Signal</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Selection</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Home</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Draw</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Away</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Bookmaker</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Stacking</th>
                              </tr>
                            </thead>
                            <tbody>
                              {lastSignals.map((signal: any, index: number) => {
                                const odds = signal.odds || [];
                                const homeOdds = typeof odds[0] === 'number' ? odds[0].toFixed(2) : '-';
                                const drawOdds = typeof odds[1] === 'number' ? odds[1].toFixed(2) : '-';
                                const awayOdds = typeof odds[2] === 'number' ? odds[2].toFixed(2) : '-';

                                return (
                                  <tr key={index} className="border-b border-white/5">
                                    <td className="py-2 px-3">
                                      {signal.clock !== null ? (
                                        <span className="text-red-400 font-bold tabular-nums">{signal.clock}'</span>
                                      ) : (
                                        <span className="text-gray-500">-</span>
                                      )}
                                    </td>
                                    <td className="py-2 px-3">
                                      <span className={`font-bold ${
                                        signal.signal?.includes('🟢') ? 'text-emerald-400' :
                                        signal.signal?.includes('🔥') ? 'text-orange-400' :
                                        signal.signal?.includes('🔵') ? 'text-blue-400' :
                                        'text-gray-400'
                                      }`}>
                                        {signal.signal || '-'}
                                      </span>
                                    </td>
                                    <td className="py-2 px-3">
                                      <span className="text-emerald-400 font-medium">{signal.selection || '-'}</span>
                                    </td>
                                    <td className="py-2 px-3 text-gray-300">{homeOdds}</td>
                                    <td className="py-2 px-3 text-gray-300">{drawOdds}</td>
                                    <td className="py-2 px-3 text-gray-300">{awayOdds}</td>
                                    <td className="py-2 px-3">
                                      <span className="text-blue-400 text-xs font-bold uppercase">{signal.bookmaker || '-'}</span>
                                    </td>
                                    <td className="py-2 px-3 text-gray-300">{signal.stacking || '-'}</td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        <div className="text-center mt-4 text-gray-500 text-sm">Match has ended</div>
                      </div>
                    );
                  })()
                ) : aiPredictions.moneyline ? (
                  <>
                    {/* Signal & Status Row */}
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        {aiPredictions.moneyline.bookmaker && (
                          <span className="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 text-sm font-bold uppercase tracking-wide">
                            {aiPredictions.moneyline.bookmaker}
                          </span>
                        )}
                        {aiPredictions.moneyline.clock !== null && (
                          <div className="flex items-center gap-1.5 px-3 py-1 rounded-lg bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-500/30">
                            <svg className="w-4 h-4 text-red-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="12" r="10" strokeWidth="2" />
                              <path strokeLinecap="round" strokeWidth="2" d="M12 6v6l4 2" />
                            </svg>
                            <span className="text-red-400 text-sm font-bold tabular-nums">{aiPredictions.moneyline.clock}'</span>
                          </div>
                        )}
                      </div>
                      <div className="flex items-center gap-3">
                        <div className="flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-500/20 to-cyan-500/20 border border-emerald-500/30">
                          <svg className="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          <span className="text-emerald-400 font-bold text-base">{aiPredictions.moneyline.selection || '1X2'}</span>
                        </div>
                        <div className={`px-4 py-2 rounded-lg text-base font-bold ${
                          aiPredictions.moneyline.signal?.includes('🟢') ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' :
                          aiPredictions.moneyline.signal?.includes('🔥') ? 'bg-orange-500/20 text-orange-400 border border-orange-500/30' :
                          aiPredictions.moneyline.signal?.includes('🔵') ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' :
                          aiPredictions.moneyline.signal?.includes('🔴') ? 'bg-red-500/20 text-red-400 border border-red-500/30' :
                          'bg-gray-500/20 text-gray-400 border border-gray-500/30'
                        }`}>
                          {aiPredictions.moneyline.signal}
                        </div>
                      </div>
                    </div>

                    {/* Compact Odds Grid */}
                    <div className="grid grid-cols-3 gap-2">
                      <div className="bg-white/5 rounded-xl py-3 px-3 text-center">
                        <div className="text-xs text-gray-500 uppercase mb-1">Home</div>
                        <div className="text-xl font-bold text-white">{aiPredictions.moneyline.moneyline_1x2_home?.toFixed(2) ?? '-'}</div>
                      </div>
                      <div className="bg-white/5 rounded-xl py-3 px-3 text-center">
                        <div className="text-xs text-gray-500 uppercase mb-1">Draw</div>
                        <div className="text-xl font-bold text-white">{aiPredictions.moneyline.moneyline_1x2_draw?.toFixed(2) ?? '-'}</div>
                      </div>
                      <div className="bg-white/5 rounded-xl py-3 px-3 text-center">
                        <div className="text-xs text-gray-500 uppercase mb-1">Away</div>
                        <div className="text-xl font-bold text-white">{aiPredictions.moneyline.moneyline_1x2_away?.toFixed(2) ?? '-'}</div>
                      </div>
                    </div>

                    {/* AI Insights Panel */}
                    {(aiPredictions.moneyline.stacking_quantity || aiPredictions.moneyline.market_analysis_trend_direction || aiPredictions.moneyline.market_analysis_vig_status) ? (
                      <div className="rounded-xl bg-gradient-to-br from-slate-800/50 to-slate-900/50 border border-white/5 overflow-hidden">
                        {/* Stacking Status */}
                        {(aiPredictions.moneyline.stacking_quantity || aiPredictions.moneyline.market_analysis_vig_status) && (
                          <div className="p-4 border-b border-white/5">
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-2">
                                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-yellow-500 to-amber-600 flex items-center justify-center">
                                  <span className="text-white text-sm">💎</span>
                                </div>
                                <div>
                                  <div className="text-xs text-gray-500 uppercase tracking-wider">Staking Plan</div>
                                  <div className="text-yellow-400 font-bold text-base">{aiPredictions.moneyline.stacking_quantity}</div>
                                </div>
                              </div>
                              {aiPredictions.moneyline.market_analysis_vig_status && (
                                <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                                  <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                  <span className="text-emerald-400 text-xs font-medium">{aiPredictions.moneyline.market_analysis_vig_status}</span>
                                </div>
                              )}
                            </div>
                            {aiPredictions.moneyline.stacking_plan_description && (
                              <p className="text-gray-400 text-sm leading-relaxed line-clamp-2">{aiPredictions.moneyline.stacking_plan_description}</p>
                            )}
                          </div>
                        )}
                        {/* Market Trend */}
                        {aiPredictions.moneyline.market_analysis_trend_direction && (
                          <div className="p-4">
                            <div className="flex items-start gap-3">
                              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center flex-shrink-0">
                                <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                              </div>
                              <div>
                                <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Market Performance</div>
                                <p className="text-gray-300 text-sm leading-relaxed">{aiPredictions.moneyline.market_analysis_trend_direction}</p>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="rounded-xl bg-gradient-to-br from-slate-800/50 to-slate-900/50 border border-white/5 p-6 text-center">
                        <div className="text-gray-500 text-sm">AI no predictions</div>
                      </div>
                    )}
                  </>
                ) : selectedPersonality === 'value' && liveSignals ? (
                  (() => {
                    // Cast to raw record to access database values directly
                    const raw = liveSignals as unknown as Record<string, unknown>;
                    const selection = String(raw.selection_1x2 || '').toUpperCase();
                    const selectionLabel = selection === 'HOME' || selection === '1' ? 'Home Win' : selection === 'DRAW' || selection === 'X' ? 'Draw' : 'Away Win';
                    const fairOdds = raw.fair_odds_1x2 !== null && raw.fair_odds_1x2 !== undefined ? Number(raw.fair_odds_1x2).toFixed(2) : '-';
                    const marketOdds = raw.market_odds_1x2 !== null && raw.market_odds_1x2 !== undefined ? Number(raw.market_odds_1x2).toFixed(2) : '-';
                    const evStr = String(raw.expected_value_1x2 || '').replace('%', '');
                    const evNum = parseFloat(evStr);
                    const evDisplay = !isNaN(evNum) ? `+${evNum.toFixed(2)}%` : '-';
                    const stakeStr = String(raw.recommended_stake_1x2 || '').replace('%', '');
                    const stakeNum = parseFloat(stakeStr);
                    const stakeDisplay = !isNaN(stakeNum) ? stakeNum.toFixed(2) : '-';
                    const isValuable = raw.is_valuable_1x2;
                    const score = raw.score as string | null;
                    const clock = raw.clock;

                    return (
                      <div className="rounded-xl bg-gradient-to-br from-purple-900/40 to-indigo-900/40 border-purple-500/20 border overflow-hidden">
                        {/* Header with Clock and Status */}
                        <div className="flex items-center justify-between px-4 py-3 bg-black/20">
                          <div className="flex items-center gap-3">
                            {clock !== null && clock !== undefined && (
                              <div className="flex items-center gap-1.5">
                                <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                                <span className="text-white font-bold">{String(clock)}'</span>
                              </div>
                            )}
                            {score && (
                              <span className="text-gray-400 text-sm">Score: <span className="text-white font-semibold">{score}</span></span>
                            )}
                          </div>
                          {Boolean(isValuable) && (
                            <div className="flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-500/20 border-emerald-500/40 border">
                              <span className="text-emerald-400 text-xs font-bold">💎 VALUE BET</span>
                            </div>
                          )}
                        </div>

                        {/* Main Content */}
                        <div className="p-4">
                          {/* Selection & Odds */}
                          <div className="flex items-center justify-between mb-4">
                            <div>
                              <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Recommended Bet</div>
                              <div className="text-xl font-bold text-white">{selectionLabel}</div>
                            </div>
                            <div className="flex items-center gap-6">
                              <div className="text-center">
                                <div className="text-[10px] text-gray-500 uppercase">Fair</div>
                                <div className="text-lg font-semibold text-gray-300">{fairOdds}</div>
                              </div>
                              <div className="text-gray-600">→</div>
                              <div className="text-center">
                                <div className="text-[10px] text-gray-500 uppercase">Market</div>
                                <div className="text-xl font-bold text-white">{marketOdds}</div>
                              </div>
                            </div>
                          </div>

                          {/* Stats Grid */}
                          <div className="grid grid-cols-2 gap-3">
                            <div className="bg-black/20 rounded-lg p-3">
                              <div className="text-[10px] text-gray-500 uppercase tracking-wider">Expected Value</div>
                              <div className="text-lg font-bold text-emerald-400">{evDisplay}</div>
                            </div>
                            <div className="bg-black/20 rounded-lg p-3">
                              <div className="text-[10px] text-gray-500 uppercase tracking-wider">Stake</div>
                              <div className="text-lg font-bold text-yellow-400">{stakeDisplay !== '-' ? `${stakeDisplay} units` : '-'}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })()
                ) : selectedPersonality === 'value' && match.type === 'Finished' ? (
                  (() => {
                    const lastLiveSignals = getLastLiveSignals('1x2', 3);
                    console.log('Rendering 1X2 for HDP Sniper (Finished):', {
                      liveSignalsHistoryLength: liveSignalsHistory.length,
                      lastLiveSignalsLength: lastLiveSignals.length,
                      matchType: match.type,
                      selectedPersonality
                    });

                    if (lastLiveSignals.length === 0) {
                      return (
                        <div className="text-center py-8 text-gray-500">
                          <div className="space-y-2">
                            <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p className="text-sm">Match has ended</p>
                          </div>
                        </div>
                      );
                    }
                    return (
                      <div className="opacity-30">
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b border-white/10">
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Clock</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Selection</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Fair Odds</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Market Odds</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">EV</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Stake</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Value</th>
                              </tr>
                            </thead>
                            <tbody>
                              {lastLiveSignals.map((signal: any, index: number) => {
                                const raw = signal as Record<string, unknown>;
                                const selection = String(raw.selection_1x2 || '').toUpperCase();
                                const selectionLabel = selection === 'HOME' || selection === '1' ? 'Home' : selection === 'DRAW' || selection === 'X' ? 'Draw' : 'Away';
                                const fairOdds = raw.fair_odds_1x2 !== null && raw.fair_odds_1x2 !== undefined ? Number(raw.fair_odds_1x2).toFixed(2) : '-';
                                const marketOdds = raw.market_odds_1x2 !== null && raw.market_odds_1x2 !== undefined ? Number(raw.market_odds_1x2).toFixed(2) : '-';
                                const evStr = String(raw.expected_value_1x2 || '').replace('%', '');
                                const evNum = parseFloat(evStr);
                                const evDisplay = !isNaN(evNum) ? `+${evNum.toFixed(2)}%` : '-';
                                const stakeStr = String(raw.recommended_stake_1x2 || '').replace('%', '');
                                const stakeNum = parseFloat(stakeStr);
                                const stakeDisplay = !isNaN(stakeNum) ? `${stakeNum.toFixed(2)}` : '-';
                                const isValuable = raw.is_valuable_1x2;
                                const clock = raw.clock;

                                return (
                                  <tr key={index} className="border-b border-white/5">
                                    <td className="py-2 px-3">
                                      {clock !== null && clock !== undefined ? (
                                        <span className="text-red-400 font-bold tabular-nums">{String(clock)}'</span>
                                      ) : (
                                        <span className="text-gray-500">-</span>
                                      )}
                                    </td>
                                    <td className="py-2 px-3">
                                      <span className="text-emerald-400 font-medium">{selectionLabel}</span>
                                    </td>
                                    <td className="py-2 px-3 text-gray-300">{fairOdds}</td>
                                    <td className="py-2 px-3 text-white font-semibold">{marketOdds}</td>
                                    <td className="py-2 px-3 text-emerald-400">{evDisplay}</td>
                                    <td className="py-2 px-3 text-yellow-400">{stakeDisplay}</td>
                                    <td className="py-2 px-3">
                                      {Boolean(isValuable) ? (
                                        <span className="text-emerald-400">💎</span>
                                      ) : (
                                        <span className="text-gray-500">-</span>
                                      )}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        <div className="text-center mt-4 text-gray-500 text-sm">Match has ended</div>
                      </div>
                    );
                  })()
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    {match.type === 'Scheduled' ? (
                      <div className="space-y-2">
                        <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm">Match has not started yet</p>
                      </div>
                    ) : match.type === 'Finished' ? (
                      <div className="space-y-2">
                        <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm">Match has ended</p>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        <p className="text-sm">AI no predictions</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {selectedMarket === 'overunder' && (
              <div className="space-y-3">
                {match.type === 'Finished' ? (
                  (() => {
                    const lastSignals = getLastSignals('overunder', 3);
                    if (lastSignals.length === 0) {
                      return (
                        <div className="text-center py-8 text-gray-500">
                          <div className="space-y-2">
                            <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p className="text-sm">Match has ended</p>
                          </div>
                        </div>
                      );
                    }
                    return (
                      <div className="opacity-30">
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b border-white/10">
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Clock</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Signal</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Selection</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Line</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Over</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Under</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Bookmaker</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Stacking</th>
                              </tr>
                            </thead>
                            <tbody>
                              {lastSignals.map((signal: any, index: number) => {
                                const odds = signal.odds || [];
                                const overOdds = typeof odds[0] === 'number' ? odds[0].toFixed(2) : '-';
                                const underOdds = typeof odds[1] === 'number' ? odds[1].toFixed(2) : '-';

                                return (
                                  <tr key={index} className="border-b border-white/5">
                                    <td className="py-2 px-3">
                                      {signal.clock !== null ? (
                                        <span className="text-red-400 font-bold tabular-nums">{signal.clock}'</span>
                                      ) : (
                                        <span className="text-gray-500">-</span>
                                      )}
                                    </td>
                                    <td className="py-2 px-3">
                                      <span className={`font-bold ${
                                        signal.signal?.includes('🟢') ? 'text-emerald-400' :
                                        signal.signal?.includes('🔥') ? 'text-orange-400' :
                                        signal.signal?.includes('🔵') ? 'text-blue-400' :
                                        'text-gray-400'
                                      }`}>
                                        {signal.signal || '-'}
                                      </span>
                                    </td>
                                    <td className="py-2 px-3">
                                      <span className="text-emerald-400 font-medium">{signal.selection || '-'}</span>
                                    </td>
                                    <td className="py-2 px-3 text-gray-300">{signal.line || '-'}</td>
                                    <td className="py-2 px-3 text-gray-300">{overOdds}</td>
                                    <td className="py-2 px-3 text-gray-300">{underOdds}</td>
                                    <td className="py-2 px-3">
                                      <span className="text-blue-400 text-xs font-bold uppercase">{signal.bookmaker || '-'}</span>
                                    </td>
                                    <td className="py-2 px-3 text-gray-300">{signal.stacking || '-'}</td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        <div className="text-center mt-4 text-gray-500 text-sm">Match has ended</div>
                      </div>
                    );
                  })()
                ) : aiPredictions.overunder ? (
                  <>
                    {/* Signal & Status Row */}
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        {aiPredictions.overunder.bookmaker && (
                          <span className="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 text-sm font-bold uppercase tracking-wide">
                            {aiPredictions.overunder.bookmaker}
                          </span>
                        )}
                        {aiPredictions.overunder.clock !== null && (
                          <div className="flex items-center gap-1.5 px-3 py-1 rounded-lg bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-500/30">
                            <svg className="w-4 h-4 text-red-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="12" r="10" strokeWidth="2" />
                              <path strokeLinecap="round" strokeWidth="2" d="M12 6v6l4 2" />
                            </svg>
                            <span className="text-red-400 text-sm font-bold tabular-nums">{aiPredictions.overunder.clock}'</span>
                          </div>
                        )}
                      </div>
                      <div className="flex items-center gap-3">
                        {(aiPredictions.overunder.selection || aiPredictions.overunder.line !== null) && (
                          <div className="flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border border-cyan-500/30">
                            <svg className="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span className="text-cyan-400 font-bold text-base">
                              {aiPredictions.overunder.selection || `O/U ${aiPredictions.overunder.line}`}
                            </span>
                          </div>
                        )}
                        <div className={`px-4 py-2 rounded-lg text-base font-bold ${
                          aiPredictions.overunder.signal?.includes('🟢') ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' :
                          aiPredictions.overunder.signal?.includes('🔥') ? 'bg-orange-500/20 text-orange-400 border border-orange-500/30' :
                          aiPredictions.overunder.signal?.includes('🔵') ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' :
                          aiPredictions.overunder.signal?.includes('🔴') ? 'bg-red-500/20 text-red-400 border border-red-500/30' :
                          'bg-gray-500/20 text-gray-400 border border-gray-500/30'
                        }`}>
                          {aiPredictions.overunder.signal}
                        </div>
                      </div>
                    </div>

                    {/* Line Display */}
                    {aiPredictions.overunder.line !== null && (
                      <div className="flex items-center justify-center gap-2 py-2 px-4 rounded-lg bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-500/20">
                        <span className="text-gray-400 text-sm">Line</span>
                        <span className="text-cyan-400 font-bold text-lg">{aiPredictions.overunder.line}</span>
                      </div>
                    )}

                    {/* Compact Odds Grid */}
                    <div className="grid grid-cols-2 gap-2">
                      <div className="bg-white/5 rounded-xl py-3 px-3 text-center">
                        <div className="text-xs text-gray-500 uppercase mb-1">Over</div>
                        <div className="text-xl font-bold text-white">{aiPredictions.overunder.over?.toFixed(2) ?? '-'}</div>
                      </div>
                      <div className="bg-white/5 rounded-xl py-3 px-3 text-center">
                        <div className="text-xs text-gray-500 uppercase mb-1">Under</div>
                        <div className="text-xl font-bold text-white">{aiPredictions.overunder.under?.toFixed(2) ?? '-'}</div>
                      </div>
                    </div>

                    {/* AI Insights Panel */}
                    {(aiPredictions.overunder.stacking_quantity || aiPredictions.overunder.market_analysis_trend_direction || aiPredictions.overunder.market_analysis_vig_status) ? (
                      <div className="rounded-xl bg-gradient-to-br from-slate-800/50 to-slate-900/50 border border-white/5 overflow-hidden">
                        {/* Staking Plan */}
                        {(aiPredictions.overunder.stacking_quantity || aiPredictions.overunder.stacking_plan_description || aiPredictions.overunder.market_analysis_vig_status) && (
                          <div className="p-4 border-b border-white/5">
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center gap-2">
                                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-yellow-500 to-amber-600 flex items-center justify-center">
                                  <span className="text-white text-sm">💎</span>
                                </div>
                                <div>
                                  <div className="text-xs text-gray-500 uppercase tracking-wider">Staking Plan</div>
                                  <div className="text-yellow-400 font-bold">{aiPredictions.overunder.stacking_quantity || '-'}</div>
                                </div>
                              </div>
                              {aiPredictions.overunder.market_analysis_vig_status && (
                                <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                                  <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                  <span className="text-emerald-400 text-xs font-medium">{aiPredictions.overunder.market_analysis_vig_status}</span>
                                </div>
                              )}
                            </div>
                            {aiPredictions.overunder.stacking_plan_description && (
                              <p className="text-gray-400 text-sm leading-relaxed line-clamp-2">{aiPredictions.overunder.stacking_plan_description}</p>
                            )}
                          </div>
                        )}
                        {/* Market Trend */}
                        {aiPredictions.overunder.market_analysis_trend_direction && (
                          <div className="p-4">
                            <div className="flex items-start gap-3">
                              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center flex-shrink-0">
                                <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                              </div>
                              <div>
                                <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Market Performance</div>
                                <p className="text-gray-300 text-sm leading-relaxed">{aiPredictions.overunder.market_analysis_trend_direction}</p>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="rounded-xl bg-gradient-to-br from-slate-800/50 to-slate-900/50 border border-white/5 p-6 text-center">
                        <div className="text-gray-500 text-sm">AI no predictions</div>
                      </div>
                    )}
                  </>
                ) : selectedPersonality === 'value' && liveSignals ? (
                  (() => {
                    // Cast to raw record to access database values directly
                    const raw = liveSignals as unknown as Record<string, unknown>;
                    const selection = String(raw.selection_ou || '').toLowerCase();
                    // Try multiple possible field names for O/U line
                    const lineValue = raw.total_points_mainline ?? raw.totalpoints_main_line ?? raw.line_ou ?? raw.line ?? null;
                    const line = lineValue !== null && lineValue !== undefined ? String(lineValue) : '';
                    const selectionLabel = selection === 'over' ? 'Over' : 'Under';
                    const fairOdds = raw.fair_odds_ou !== null && raw.fair_odds_ou !== undefined ? Number(raw.fair_odds_ou).toFixed(2) : '-';
                    const marketOdds = raw.market_odds_ou !== null && raw.market_odds_ou !== undefined ? Number(raw.market_odds_ou).toFixed(2) : '-';
                    const evStr = String(raw.expected_value_ou || '').replace('%', '');
                    const evNum = parseFloat(evStr);
                    const evDisplay = !isNaN(evNum) ? `+${evNum.toFixed(2)}%` : '-';
                    const stakeStr = String(raw.recommended_stake_ou || '').replace('%', '');
                    const stakeNum = parseFloat(stakeStr);
                    const stakeDisplay = !isNaN(stakeNum) ? stakeNum.toFixed(2) : '-';
                    const isValuable = raw.is_valuable_ou;
                    const score = raw.score as string | null;
                    const clock = raw.clock;

                    return (
                      <div className="rounded-xl bg-gradient-to-br from-cyan-900/40 to-blue-900/40 border-cyan-500/20 border overflow-hidden">
                        {/* Header with Clock and Status */}
                        <div className="flex items-center justify-between px-4 py-3 bg-black/20">
                          <div className="flex items-center gap-3">
                            {clock !== null && clock !== undefined && (
                              <div className="flex items-center gap-1.5">
                                <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                                <span className="text-white font-bold">{String(clock)}'</span>
                              </div>
                            )}
                            {score && (
                              <span className="text-gray-400 text-sm">Score: <span className="text-white font-semibold">{score}</span></span>
                            )}
                          </div>
                          {Boolean(isValuable) && (
                            <div className="flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-500/20 border-emerald-500/40 border">
                              <span className="text-emerald-400 text-xs font-bold">💎 VALUE BET</span>
                            </div>
                          )}
                        </div>

                        {/* Main Content */}
                        <div className="p-4">
                          {/* Selection & Odds */}
                          <div className="flex items-center justify-between mb-4">
                            <div>
                              <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Recommended Bet</div>
                              <div className="text-xl font-bold text-white">{selectionLabel} {line && <span className="text-amber-400">{line}</span>}</div>
                            </div>
                            <div className="flex items-center gap-6">
                              <div className="text-center">
                                <div className="text-[10px] text-gray-500 uppercase">Fair</div>
                                <div className="text-lg font-semibold text-gray-300">{fairOdds}</div>
                              </div>
                              <div className="text-gray-600">→</div>
                              <div className="text-center">
                                <div className="text-[10px] text-gray-500 uppercase">Market</div>
                                <div className="text-xl font-bold text-white">{marketOdds}</div>
                              </div>
                            </div>
                          </div>

                          {/* Stats Grid */}
                          <div className="grid grid-cols-2 gap-3">
                            <div className="bg-black/20 rounded-lg p-3">
                              <div className="text-[10px] text-gray-500 uppercase tracking-wider">Expected Value</div>
                              <div className="text-lg font-bold text-emerald-400">{evDisplay}</div>
                            </div>
                            <div className="bg-black/20 rounded-lg p-3">
                              <div className="text-[10px] text-gray-500 uppercase tracking-wider">Stake</div>
                              <div className="text-lg font-bold text-yellow-400">{stakeDisplay !== '-' ? `${stakeDisplay} units` : '-'}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })()
                ) : selectedPersonality === 'value' && match.type === 'Finished' ? (
                  (() => {
                    const lastLiveSignals = getLastLiveSignals('ou', 3);
                    if (lastLiveSignals.length === 0) {
                      return (
                        <div className="text-center py-8 text-gray-500">
                          <div className="space-y-2">
                            <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p className="text-sm">Match has ended</p>
                          </div>
                        </div>
                      );
                    }
                    return (
                      <div className="opacity-30">
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b border-white/10">
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Clock</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Selection</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Line</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Fair Odds</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Market Odds</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">EV</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Stake</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Value</th>
                              </tr>
                            </thead>
                            <tbody>
                              {lastLiveSignals.map((signal: any, index: number) => {
                                const raw = signal as Record<string, unknown>;
                                const selection = String(raw.selection_ou || '').toLowerCase();
                                const lineValue = raw.total_points_mainline ?? raw.totalpoints_main_line ?? raw.line_ou ?? raw.line ?? null;
                                const line = lineValue !== null && lineValue !== undefined ? String(lineValue) : '-';
                                const selectionLabel = selection === 'over' ? 'Over' : 'Under';
                                const fairOdds = raw.fair_odds_ou !== null && raw.fair_odds_ou !== undefined ? Number(raw.fair_odds_ou).toFixed(2) : '-';
                                const marketOdds = raw.market_odds_ou !== null && raw.market_odds_ou !== undefined ? Number(raw.market_odds_ou).toFixed(2) : '-';
                                const evStr = String(raw.expected_value_ou || '').replace('%', '');
                                const evNum = parseFloat(evStr);
                                const evDisplay = !isNaN(evNum) ? `+${evNum.toFixed(2)}%` : '-';
                                const stakeStr = String(raw.recommended_stake_ou || '').replace('%', '');
                                const stakeNum = parseFloat(stakeStr);
                                const stakeDisplay = !isNaN(stakeNum) ? `${stakeNum.toFixed(2)}` : '-';
                                const isValuable = raw.is_valuable_ou;
                                const clock = raw.clock;

                                return (
                                  <tr key={index} className="border-b border-white/5">
                                    <td className="py-2 px-3">
                                      {clock !== null && clock !== undefined ? (
                                        <span className="text-red-400 font-bold tabular-nums">{String(clock)}'</span>
                                      ) : (
                                        <span className="text-gray-500">-</span>
                                      )}
                                    </td>
                                    <td className="py-2 px-3">
                                      <span className="text-emerald-400 font-medium">{selectionLabel}</span>
                                    </td>
                                    <td className="py-2 px-3 text-amber-400">{line}</td>
                                    <td className="py-2 px-3 text-gray-300">{fairOdds}</td>
                                    <td className="py-2 px-3 text-white font-semibold">{marketOdds}</td>
                                    <td className="py-2 px-3 text-emerald-400">{evDisplay}</td>
                                    <td className="py-2 px-3 text-yellow-400">{stakeDisplay}</td>
                                    <td className="py-2 px-3">
                                      {Boolean(isValuable) ? (
                                        <span className="text-emerald-400">💎</span>
                                      ) : (
                                        <span className="text-gray-500">-</span>
                                      )}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        <div className="text-center mt-4 text-gray-500 text-sm">Match has ended</div>
                      </div>
                    );
                  })()
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    {match.type === 'Scheduled' ? (
                      <div className="space-y-2">
                        <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm">Match has not started yet</p>
                      </div>
                    ) : match.type === 'Finished' ? (
                      <div className="space-y-2">
                        <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm">Match has ended</p>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        <p className="text-sm">AI no predictions</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {selectedMarket === 'handicap' && (
              <div className="space-y-3">
                {match.type === 'Finished' ? (
                  (() => {
                    const lastSignals = getLastSignals('handicap', 3);
                    if (lastSignals.length === 0) {
                      return (
                        <div className="text-center py-8 text-gray-500">
                          <div className="space-y-2">
                            <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p className="text-sm">Match has ended</p>
                          </div>
                        </div>
                      );
                    }
                    return (
                      <div className="opacity-30">
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b border-white/10">
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Clock</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Signal</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Selection</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Line</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Home</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Away</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Bookmaker</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Stacking</th>
                              </tr>
                            </thead>
                            <tbody>
                              {lastSignals.map((signal: any, index: number) => {
                                const odds = signal.odds || [];
                                const homeOdds = typeof odds[0] === 'number' ? odds[0].toFixed(2) : '-';
                                const awayOdds = typeof odds[1] === 'number' ? odds[1].toFixed(2) : '-';

                                return (
                                  <tr key={index} className="border-b border-white/5">
                                    <td className="py-2 px-3">
                                      {signal.clock !== null ? (
                                        <span className="text-red-400 font-bold tabular-nums">{signal.clock}'</span>
                                      ) : (
                                        <span className="text-gray-500">-</span>
                                      )}
                                    </td>
                                    <td className="py-2 px-3">
                                      <span className={`font-bold ${
                                        signal.signal?.includes('🟢') ? 'text-emerald-400' :
                                        signal.signal?.includes('🔥') ? 'text-orange-400' :
                                        signal.signal?.includes('🔵') ? 'text-blue-400' :
                                        'text-gray-400'
                                      }`}>
                                        {signal.signal || '-'}
                                      </span>
                                    </td>
                                    <td className="py-2 px-3">
                                      <span className="text-emerald-400 font-medium">{signal.selection || '-'}</span>
                                    </td>
                                    <td className="py-2 px-3 text-gray-300">{signal.line || '-'}</td>
                                    <td className="py-2 px-3 text-gray-300">{homeOdds}</td>
                                    <td className="py-2 px-3 text-gray-300">{awayOdds}</td>
                                    <td className="py-2 px-3">
                                      <span className="text-blue-400 text-xs font-bold uppercase">{signal.bookmaker || '-'}</span>
                                    </td>
                                    <td className="py-2 px-3 text-gray-300">{signal.stacking || '-'}</td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        <div className="text-center mt-4 text-gray-500 text-sm">Match has ended</div>
                      </div>
                    );
                  })()
                ) : aiPredictions.handicap ? (
                  <>
                    {/* Signal & Status Row */}
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        {aiPredictions.handicap.bookmaker && (
                          <span className="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 text-sm font-bold uppercase tracking-wide">
                            {aiPredictions.handicap.bookmaker}
                          </span>
                        )}
                        {aiPredictions.handicap.clock !== null && (
                          <div className="flex items-center gap-1.5 px-3 py-1 rounded-lg bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-500/30">
                            <svg className="w-4 h-4 text-red-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="12" r="10" strokeWidth="2" />
                              <path strokeLinecap="round" strokeWidth="2" d="M12 6v6l4 2" />
                            </svg>
                            <span className="text-red-400 text-sm font-bold tabular-nums">{aiPredictions.handicap.clock}'</span>
                          </div>
                        )}
                      </div>
                      <div className="flex items-center gap-3">
                        {(aiPredictions.handicap.selection || aiPredictions.handicap.line !== null) && (
                          <div className="flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-500/30">
                            <svg className="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span className="text-purple-400 font-bold text-base">
                              {aiPredictions.handicap.selection || `HDP ${aiPredictions.handicap.line !== null && aiPredictions.handicap.line > 0 ? '+' : ''}${aiPredictions.handicap.line}`}
                            </span>
                          </div>
                        )}
                        <div className={`px-4 py-2 rounded-lg text-base font-bold ${
                          aiPredictions.handicap.signal?.includes('🟢') ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' :
                          aiPredictions.handicap.signal?.includes('🔥') ? 'bg-orange-500/20 text-orange-400 border border-orange-500/30' :
                          aiPredictions.handicap.signal?.includes('🔵') ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' :
                          aiPredictions.handicap.signal?.includes('🔴') ? 'bg-red-500/20 text-red-400 border border-red-500/30' :
                          'bg-gray-500/20 text-gray-400 border border-gray-500/30'
                        }`}>
                          {aiPredictions.handicap.signal}
                        </div>
                      </div>
                    </div>

                    {/* Line Display */}
                    {aiPredictions.handicap.line !== null && (
                      <div className="flex items-center justify-center gap-2 py-2 px-4 rounded-lg bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20">
                        <span className="text-gray-400 text-sm">Line</span>
                        <span className="text-purple-400 font-bold text-lg">{aiPredictions.handicap.line > 0 ? '+' : ''}{aiPredictions.handicap.line}</span>
                      </div>
                    )}

                    {/* Compact Odds Grid */}
                    <div className="grid grid-cols-2 gap-2">
                      <div className="bg-white/5 rounded-xl py-3 px-3 text-center">
                        <div className="text-xs text-gray-500 uppercase mb-1">Home</div>
                        <div className="text-xl font-bold text-white">{aiPredictions.handicap.home_odds?.toFixed(2) ?? '-'}</div>
                      </div>
                      <div className="bg-white/5 rounded-xl py-3 px-3 text-center">
                        <div className="text-xs text-gray-500 uppercase mb-1">Away</div>
                        <div className="text-xl font-bold text-white">{aiPredictions.handicap.away_odds?.toFixed(2) ?? '-'}</div>
                      </div>
                    </div>

                    {/* AI Insights Panel */}
                    {(aiPredictions.handicap.stacking_quantity || aiPredictions.handicap.market_analysis_trend_direction || aiPredictions.handicap.market_analysis_vig_status) ? (
                      <div className="rounded-xl bg-gradient-to-br from-slate-800/50 to-slate-900/50 border border-white/5 overflow-hidden">
                        {/* Staking Plan */}
                        {(aiPredictions.handicap.stacking_quantity || aiPredictions.handicap.stacking_plan_description || aiPredictions.handicap.market_analysis_vig_status) && (
                          <div className="p-4 border-b border-white/5">
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center gap-2">
                                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-yellow-500 to-amber-600 flex items-center justify-center">
                                  <span className="text-white text-sm">💎</span>
                                </div>
                                <div>
                                  <div className="text-xs text-gray-500 uppercase tracking-wider">Staking Plan</div>
                                  <div className="text-yellow-400 font-bold">{aiPredictions.handicap.stacking_quantity || '-'}</div>
                                </div>
                              </div>
                              {aiPredictions.handicap.market_analysis_vig_status && (
                                <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                                  <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                  <span className="text-emerald-400 text-xs font-medium">{aiPredictions.handicap.market_analysis_vig_status}</span>
                                </div>
                              )}
                            </div>
                            {aiPredictions.handicap.stacking_plan_description && (
                              <p className="text-gray-400 text-sm leading-relaxed line-clamp-2">{aiPredictions.handicap.stacking_plan_description}</p>
                            )}
                          </div>
                        )}
                        {/* Market Trend */}
                        {aiPredictions.handicap.market_analysis_trend_direction && (
                          <div className="p-4">
                            <div className="flex items-start gap-3">
                              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center flex-shrink-0">
                                <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                              </div>
                              <div>
                                <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Market Performance</div>
                                <p className="text-gray-300 text-sm leading-relaxed">{aiPredictions.handicap.market_analysis_trend_direction}</p>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="rounded-xl bg-gradient-to-br from-slate-800/50 to-slate-900/50 border border-white/5 p-6 text-center">
                        <div className="text-gray-500 text-sm">AI no predictions</div>
                      </div>
                    )}
                  </>
                ) : selectedPersonality === 'value' && liveSignals ? (
                  (() => {
                    // Cast to raw record to access database values directly
                    const raw = liveSignals as unknown as Record<string, unknown>;
                    const selection = String(raw.selection_hdp || '').toLowerCase();
                    // Try multiple possible field names for HDP line
                    const lineValue = raw.handicap_main_line ?? raw.handicap_mainline ?? raw.line_hdp ?? raw.line ?? null;
                    const line = lineValue !== null && lineValue !== undefined ? String(lineValue) : '';
                    const selectionLabel = selection === 'home' ? 'Home' : 'Away';
                    const fairOdds = raw.fair_odds_hdp !== null && raw.fair_odds_hdp !== undefined ? Number(raw.fair_odds_hdp).toFixed(2) : '-';
                    const marketOdds = raw.market_odds_hdp !== null && raw.market_odds_hdp !== undefined ? Number(raw.market_odds_hdp).toFixed(2) : '-';
                    const evStr = String(raw.expected_value_hdp || '').replace('%', '');
                    const evNum = parseFloat(evStr);
                    const evDisplay = !isNaN(evNum) ? `+${evNum.toFixed(2)}%` : '-';
                    const stakeStr = String(raw.recommended_stake_hdp || '').replace('%', '');
                    const stakeNum = parseFloat(stakeStr);
                    const stakeDisplay = !isNaN(stakeNum) ? stakeNum.toFixed(2) : '-';
                    const isValuable = raw.is_valuable_hdp;
                    const score = raw.score as string | null;
                    const clock = raw.clock;

                    return (
                      <div className="rounded-xl bg-gradient-to-br from-pink-900/40 to-purple-900/40 border-pink-500/20 border overflow-hidden">
                        {/* Header with Clock and Status */}
                        <div className="flex items-center justify-between px-4 py-3 bg-black/20">
                          <div className="flex items-center gap-3">
                            {clock !== null && clock !== undefined && (
                              <div className="flex items-center gap-1.5">
                                <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                                <span className="text-white font-bold">{String(clock)}'</span>
                              </div>
                            )}
                            {score && (
                              <span className="text-gray-400 text-sm">Score: <span className="text-white font-semibold">{score}</span></span>
                            )}
                          </div>
                          {Boolean(isValuable) && (
                            <div className="flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-500/20 border-emerald-500/40 border">
                              <span className="text-emerald-400 text-xs font-bold">💎 VALUE BET</span>
                            </div>
                          )}
                        </div>

                        {/* Main Content */}
                        <div className="p-4">
                          {/* Selection & Odds */}
                          <div className="flex items-center justify-between mb-4">
                            <div>
                              <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Recommended Bet</div>
                              <div className="text-xl font-bold text-white">{selectionLabel} {line && <span className="text-amber-400">{line}</span>}</div>
                            </div>
                            <div className="flex items-center gap-6">
                              <div className="text-center">
                                <div className="text-[10px] text-gray-500 uppercase">Fair</div>
                                <div className="text-lg font-semibold text-gray-300">{fairOdds}</div>
                              </div>
                              <div className="text-gray-600">→</div>
                              <div className="text-center">
                                <div className="text-[10px] text-gray-500 uppercase">Market</div>
                                <div className="text-xl font-bold text-white">{marketOdds}</div>
                              </div>
                            </div>
                          </div>

                          {/* Stats Grid */}
                          <div className="grid grid-cols-2 gap-3">
                            <div className="bg-black/20 rounded-lg p-3">
                              <div className="text-[10px] text-gray-500 uppercase tracking-wider">Expected Value</div>
                              <div className="text-lg font-bold text-emerald-400">{evDisplay}</div>
                            </div>
                            <div className="bg-black/20 rounded-lg p-3">
                              <div className="text-[10px] text-gray-500 uppercase tracking-wider">Stake</div>
                              <div className="text-lg font-bold text-yellow-400">{stakeDisplay !== '-' ? `${stakeDisplay} units` : '-'}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })()
                ) : selectedPersonality === 'value' && match.type === 'Finished' ? (
                  (() => {
                    const lastLiveSignals = getLastLiveSignals('hdp', 3);
                    if (lastLiveSignals.length === 0) {
                      return (
                        <div className="text-center py-8 text-gray-500">
                          <div className="space-y-2">
                            <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p className="text-sm">Match has ended</p>
                          </div>
                        </div>
                      );
                    }
                    return (
                      <div className="opacity-30">
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b border-white/10">
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Clock</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Selection</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Line</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Fair Odds</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Market Odds</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">EV</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Stake</th>
                                <th className="text-left py-2 px-3 text-gray-400 font-medium">Value</th>
                              </tr>
                            </thead>
                            <tbody>
                              {lastLiveSignals.map((signal: any, index: number) => {
                                const raw = signal as Record<string, unknown>;
                                const selection = String(raw.selection_hdp || '').toLowerCase();
                                const lineValue = raw.handicap_mainline ?? raw.line_hdp ?? raw.line ?? null;
                                const line = lineValue !== null && lineValue !== undefined ? String(lineValue) : '-';
                                const selectionLabel = selection === 'home' ? 'Home' : 'Away';
                                const fairOdds = raw.fair_odds_hdp !== null && raw.fair_odds_hdp !== undefined ? Number(raw.fair_odds_hdp).toFixed(2) : '-';
                                const marketOdds = raw.market_odds_hdp !== null && raw.market_odds_hdp !== undefined ? Number(raw.market_odds_hdp).toFixed(2) : '-';
                                const evStr = String(raw.expected_value_hdp || '').replace('%', '');
                                const evNum = parseFloat(evStr);
                                const evDisplay = !isNaN(evNum) ? `+${evNum.toFixed(2)}%` : '-';
                                const stakeStr = String(raw.recommended_stake_hdp || '').replace('%', '');
                                const stakeNum = parseFloat(stakeStr);
                                const stakeDisplay = !isNaN(stakeNum) ? `${stakeNum.toFixed(2)}` : '-';
                                const isValuable = raw.is_valuable_hdp;
                                const clock = raw.clock;

                                return (
                                  <tr key={index} className="border-b border-white/5">
                                    <td className="py-2 px-3">
                                      {clock !== null && clock !== undefined ? (
                                        <span className="text-red-400 font-bold tabular-nums">{String(clock)}'</span>
                                      ) : (
                                        <span className="text-gray-500">-</span>
                                      )}
                                    </td>
                                    <td className="py-2 px-3">
                                      <span className="text-emerald-400 font-medium">{selectionLabel}</span>
                                    </td>
                                    <td className="py-2 px-3 text-purple-400">{line}</td>
                                    <td className="py-2 px-3 text-gray-300">{fairOdds}</td>
                                    <td className="py-2 px-3 text-white font-semibold">{marketOdds}</td>
                                    <td className="py-2 px-3 text-emerald-400">{evDisplay}</td>
                                    <td className="py-2 px-3 text-yellow-400">{stakeDisplay}</td>
                                    <td className="py-2 px-3">
                                      {Boolean(isValuable) ? (
                                        <span className="text-emerald-400">💎</span>
                                      ) : (
                                        <span className="text-gray-500">-</span>
                                      )}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        <div className="text-center mt-4 text-gray-500 text-sm">Match has ended</div>
                      </div>
                    );
                  })()
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    {match.type === 'Scheduled' ? (
                      <div className="space-y-2">
                        <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm">Match has not started yet</p>
                      </div>
                    ) : match.type === 'Finished' ? (
                      <div className="space-y-2">
                        <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm">Match has ended</p>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        <svg className="w-10 h-10 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        <p className="text-sm">AI no predictions</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {/* Disclaimer Ticker */}
            <div className="mt-6 rounded-xl bg-gradient-to-r from-yellow-500/10 via-orange-500/10 to-yellow-500/10 border border-yellow-500/20 overflow-hidden">
              <div className="py-3 px-4 flex items-center">
                <div className="flex-shrink-0 mr-4">
                  <span className="text-yellow-400 text-lg animate-pulse">⚠️</span>
                </div>
                <div className="overflow-hidden flex-1">
                  <div className="animate-marquee whitespace-nowrap">
                    <span className="text-yellow-400/90 text-sm font-medium">
                      {t('disclaimer')} &nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp; {t('disclaimer')} &nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp; {t('disclaimer')}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </>
          )}
        </div>
      </main>

      {/* Footer */}
      <footer className="py-8 px-4 border-t border-white/5">
        <div className="max-w-7xl mx-auto text-center text-gray-500 text-sm">
          <p>&copy; 2026 OddsFlow. All rights reserved. Gambling involves risk. Please gamble responsibly.</p>
        </div>
      </footer>
    </div>
  );
}
